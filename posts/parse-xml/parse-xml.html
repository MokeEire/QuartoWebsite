<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.615">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="dcterms.date" content="2022-07-14">
<title>Mark Barrett - Parsing XML with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://hypothes.is/embed.js"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Mark Barrett</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">Blog</a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/Mmm_JuicyFruit"><i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/MokeEire"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 </a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#what-is-xml" id="toc-what-is-xml" class="nav-link active" data-scroll-target="#what-is-xml">What is XML?</a></li>
  <li><a href="#navigating-xml-with-r" id="toc-navigating-xml-with-r" class="nav-link" data-scroll-target="#navigating-xml-with-r">Navigating XML with R</a></li>
  <li><a href="#define-the-output" id="toc-define-the-output" class="nav-link" data-scroll-target="#define-the-output">Define the output</a></li>
  <li>
<a href="#parsing" id="toc-parsing" class="nav-link" data-scroll-target="#parsing">Parsing</a>
  <ul class="collapse">
<li><a href="#singular-elements" id="toc-singular-elements" class="nav-link" data-scroll-target="#singular-elements">Singular elements</a></li>
  <li>
<a href="#nested-elements" id="toc-nested-elements" class="nav-link" data-scroll-target="#nested-elements">Nested elements</a>
  <ul class="collapse">
<li><a href="#multiple-children" id="toc-multiple-children" class="nav-link" data-scroll-target="#multiple-children">Multiple children</a></li>
  <li><a href="#multiple-children-with-sub-elements" id="toc-multiple-children-with-sub-elements" class="nav-link" data-scroll-target="#multiple-children-with-sub-elements">Multiple children with sub-elements</a></li>
  <li><a href="#nested-xml" id="toc-nested-xml" class="nav-link" data-scroll-target="#nested-xml">Nested XML</a></li>
  </ul>
</li>
  </ul>
</li>
  <li><a href="#tldr-main-points" id="toc-tldr-main-points" class="nav-link" data-scroll-target="#tldr-main-points">TL;DR: Main Points</a></li>
  <li><a href="#other-helpful-articles" id="toc-other-helpful-articles" class="nav-link" data-scroll-target="#other-helpful-articles">Other helpful articles</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Parsing XML with R</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Untangling congressional legislative data</p>
  <div class="quarto-categories">
    <div class="quarto-category">data</div>
    <div class="quarto-category">governance</div>
    <div class="quarto-category">R</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 14, 2022</p>
    </div>
  </div>
    
  </div>
  

</header><div class="cell">

</div>
<div class="callout-tip callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What you’ll learn:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Load and parse XML files in R using the <a href="http://www.omegahat.net/RSXML/">XML</a> and <a href="https://xml2.r-lib.org/">xml2</a> packages</p></li>
<li><p>Explore the structure of XML documents</p></li>
<li><p>List, map, and flatten your data into a tabular format using <a href="http://purrr.tidyverse.org">purrr</a> and using list columns with <a href="https://tidyr.tidyverse.org">tidyr</a></p></li>
</ul>
</div>
</div>
<section id="what-is-xml" class="level1"><h1>What is XML?</h1>
<p>Unlike Excel spreadsheets, CSV files, and other tabular formats, (e)Xtensible Markup Language (XML) is a storage format designed to contain any “arbitrary” structure<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> of data. This flexibility makes XML useful for storing all kinds of information from financial transactions and recipes to webpage content and document formatting<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. At its core, XML is just “information wrapped in tags”. Here is an example of information a bookstore might have in XML format from <a href="https://www.w3schools.com/XML/xml_usedfor.asp">w3schools</a> :</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bookstore</span>&gt;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"children"</span>&gt;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Harry Potter&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;J K. Rowling&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2005&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;29.99&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"web"</span>&gt;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Learning XML&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;Erik T. Ray&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2003&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;39.95&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bookstore</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>&lt;bookstore&gt;</code> is the parent, or <em>root</em> element. The parent element contains two <code>&lt;book&gt;</code>s which have the elements contained in the tags – <code>&lt;title&gt;</code>, <code>&lt;author&gt;</code>, <code>&lt;year&gt;</code>, and <code>&lt;price&gt;</code>. XML can be thought of as a tree, where each tree branch can have multiple leaves, or none.</p>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note that attributes are denoted by key/value assignment in a tag.
</div>
</div>
<div class="callout-body-container callout-body">
<p>In <code>&lt;book category="children"&gt;</code>, the book’s category is stored as an attribute. Attributes are a useful way to store data related to a specific element for HTML, but using child elements is typically preferred in XML. This post will touch on data stored using both methods. To learn more about what XML is and how to use it, I recommend going through <a href="https://www.w3schools.com/XML/default.asp">w3school’s XML tutorial</a>.</p>
</div>
</div>
</section><section id="navigating-xml-with-r" class="level1"><h1>Navigating XML with R</h1>
<p>To illustrate potential complexities of XML structures, I’ll be using congressional bill data provided by the <a href="https://www.gpo.gov/">United States Government Publishing Office (GPO)</a>. You can follow along by downloading the sample XML bill <a href="https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml" title="HR-391: Global Health Security Act of 2021">here</a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<p>Four R packages are important for this article. <a href="http://www.omegahat.net/RSXML/">XML</a> and <a href="https://xml2.r-lib.org/">xml2</a><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> provide functions for reading in XML data while <a href="http://purrr.tidyverse.org">purrr</a> and <a href="https://tidyr.tidyverse.org">tidyr</a> (loaded as part of the <a href="https://tidyverse.tidyverse.org">tidyverse</a> package) helps us parse and flatten the data into tabular form. To start, read in the file with <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml()</a></code> , which returns an <code>xml_document</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> object.</p>
<div class="cell">
<details open=""><summary>Load and view XML file</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.omegahat.net/RSXML/">XML</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">bill_xml</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="st">"https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the xml_document's contents</span></span>
<span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents</a></span><span class="op">(</span><span class="va">bill_xml</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (2)}
[1] &lt;bill&gt;\n  &lt;billNumber&gt;391&lt;/billNumber&gt;\n  &lt;createDate&gt;2021-01-22T08:12:10 ...
[2] &lt;dublinCore xmlns:dc="http://purl.org/dc/elements/1.1/"&gt;\n  &lt;dc:format&gt;te ...</code></pre>
</div>
</div>
<p>We can see the document has two top-level nodes - one <code>&lt;bill&gt;</code> node and one called <code>&lt;dublinCore&gt;</code><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> In this case we can look just at the <code>&lt;bill&gt;</code> node using <code><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child()</a></code>.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Return child nodes named bill</span></span>
<span></span>
<span><span class="op">(</span><span class="va">bill_node</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span><span class="va">bill_xml</span>, <span class="st">"bill"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_node}
&lt;bill&gt;
 [1] &lt;billNumber&gt;391&lt;/billNumber&gt;
 [2] &lt;createDate&gt;2021-01-22T08:12:10Z&lt;/createDate&gt;
 [3] &lt;updateDate&gt;2022-02-09T12:37:52Z&lt;/updateDate&gt;
 [4] &lt;originChamber&gt;House&lt;/originChamber&gt;
 [5] &lt;billType&gt;HR&lt;/billType&gt;
 [6] &lt;introducedDate&gt;2021-01-21&lt;/introducedDate&gt;
 [7] &lt;congress&gt;117&lt;/congress&gt;
 [8] &lt;constitutionalAuthorityStatementText&gt;&lt;![CDATA[&lt;pre&gt;[Congressional Recor ...
 [9] &lt;recordedVotes&gt;\n  &lt;recordedVote&gt;\n    &lt;rollNumber&gt;188&lt;/rollNumber&gt;\n    ...
[10] &lt;committees&gt;\n  &lt;billCommittees&gt;\n    &lt;item&gt;\n      &lt;systemCode&gt;ssfr00&lt;/ ...
[11] &lt;committeeReports/&gt;
[12] &lt;relatedBills/&gt;
[13] &lt;actions&gt;\n  &lt;item&gt;\n    &lt;actionDate&gt;2021-07-12&lt;/actionDate&gt;\n    &lt;commi ...
[14] &lt;sponsors&gt;\n  &lt;item&gt;\n    &lt;bioguideId&gt;C001078&lt;/bioguideId&gt;\n    &lt;fullNam ...
[15] &lt;cosponsors&gt;\n  &lt;item&gt;\n    &lt;bioguideId&gt;C000266&lt;/bioguideId&gt;\n    &lt;fullN ...
[16] &lt;cboCostEstimates&gt;\n  &lt;item&gt;\n    &lt;pubDate&gt;2021-05-11T15:11:11Z&lt;/pubDate ...
[17] &lt;laws/&gt;
[18] &lt;notes/&gt;
[19] &lt;policyArea&gt;\n  &lt;name&gt;International Affairs&lt;/name&gt;\n&lt;/policyArea&gt;
[20] &lt;subjects&gt;\n  &lt;billSubjects&gt;\n    &lt;legislativeSubjects&gt;\n      &lt;item&gt;\n  ...
...</code></pre>
</div>
</div>
<p>So if we want to have a data frame with one row per bill, we have a few different kinds of elements to deal with. Firstly there are the elements which have <strong>only one value</strong> (i.e.&nbsp;<em>singular</em>) like <code>billNumber</code>, <code>createDate</code>, and <code>billType</code>. There are also elements which have information <em>nested</em> in them like <code>recordedVotes</code>, <code>committees</code>, and <code>actions</code>.</p>
<p>The importance of understanding the structure of your data brings us to one of the cardinal rules of data analysis:</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Look at your data
</div>
</div>
<div class="callout-body-container callout-body">
<p>In fact, you could even say <em>stare</em> at it. Understanding the structure and contents of your data is essential for designing a solution to consistently process the data.</p>
</div>
</div>
</section><section id="define-the-output" class="level1"><h1>Define the output</h1>
<p>As well as looking at your data, it’s also helpful to think about your intended output. This determines what you need to do to transform the data. Depending on the structure of your XML data, there are a lot of different options.</p>
<p>In the case of congressional data, we have multiple levels of observation - bill, action, vote, and individual legislator votes. To organize the data in a way that preserves each, we can use rows, columns, separate tables linked by some combination of ID variables, or we can use <a href="https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html">list columns</a>. Columns in a data frame are typically <em>atomic vectors</em><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> of equal length, but list columns enable us to store data of varying length and type, including data frames themselves. This makes them a perfect solution for the nested characteristics of the congressional data. Using <a href="https://tidyr.tidyverse.org">tidyr</a>, we will <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code>/<code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> these columns as needed. The end result will look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 24
$ bill_id                                 &lt;chr&gt; "HR-391"
$ bill_number                             &lt;chr&gt; "391"
$ create_date                             &lt;dttm&gt; 2021-01-22 08:12:10
$ update_date                             &lt;dttm&gt; 2022-02-09 12:37:52
$ origin_chamber                          &lt;chr&gt; "House"
$ bill_type                               &lt;chr&gt; "HR"
$ introduced_date                         &lt;dttm&gt; 2021-01-21
$ congress                                &lt;chr&gt; "117"
$ constitutional_authority_statement_text &lt;chr&gt; "&lt;pre&gt;[Congressional Record Vo…
$ title                                   &lt;chr&gt; "Global Health Security Act of…
$ version                                 &lt;chr&gt; "1.0.0"
$ policy_areas                            &lt;list&gt; "International Affairs"
$ legislative_subjects                    &lt;list&gt; &lt;"Advisory bodies", "Animal a…
$ bill_summaries                          &lt;list&gt; [&lt;tbl_df[2 x 7]&gt;]
$ bill_titles                             &lt;list&gt; [&lt;tbl_df[5 x 5]&gt;]
$ bill_text_versions                      &lt;list&gt; [&lt;tbl_df[3 x 3]&gt;]
$ latest_action_action_date               &lt;dttm&gt; 2021-07-12
$ latest_action_text                      &lt;chr&gt; "Received in the Senate and R…
$ committees                              &lt;list&gt; [&lt;tbl_df[2 x 6]&gt;]
$ votes                                   &lt;list&gt; [&lt;tbl_df[1 x 9]&gt;]
$ actions                                 &lt;list&gt; [&lt;tbl_df[14 x 9]&gt;]
$ action_counts                           &lt;list&gt; [&lt;tbl_df[15 x 2]&gt;]
$ sponsors                                &lt;list&gt; [&lt;tbl_df[1 x 11]&gt;]
$ cosponsors                              &lt;list&gt; [&lt;tbl_df[77 x 13]&gt;]</code></pre>
</div>
</div>
<div class="cell">

</div>
<p>Here’s a <code><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse()</a></code> of some of the nested data:</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Committees</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Votes</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Actions</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">Sponsors</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [2 × 6] (S3: tbl_df/tbl/data.frame)
  ..$ committee_system_code  : chr [1:2] "ssfr00" "hsfa00"
  ..$ committee_name         : chr [1:2] "Foreign Relations Committee" "Foreign Affairs Committee"
  ..$ committee_chamber      : chr [1:2] "Senate" "House"
  ..$ committee_type         : chr [1:2] "Standing" "Standing"
  ..$ committee_activities   :List of 2
  ..$ subcommittee_activities:List of 2</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [1 × 9] (S3: tbl_df/tbl/data.frame)
  ..$ roll_number     : chr "188"
  ..$ url             : chr "https://clerk.house.gov/evs/2021/roll188.xml"
  ..$ full_action_name: chr "Final Passage Under Suspension of the Rules Results"
  ..$ chamber         : chr "House"
  ..$ congress        : chr "117"
  ..$ date            : chr "2021-06-28T23:46:02Z"
  ..$ session_number  : chr "1"
  ..$ vote_roll       :List of 1
  ..$ roll_found      : logi TRUE</code></pre>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [14 × 9] (S3: tbl_df/tbl/data.frame)
  ..$ action_date                 : Date[1:14], format: "2021-07-12" "2021-06-28" ...
  ..$ action_committee_system_code: chr [1:14] "ssfr00" NA NA NA ...
  ..$ action_committee_name       : chr [1:14] "Foreign Relations Committee" NA NA NA ...
  ..$ action_source_code          : chr [1:14] "0" "2" "2" "9" ...
  ..$ action_source_name          : chr [1:14] "Senate" "House floor actions" "House floor actions" "Library of Congress" ...
  ..$ action_text                 : chr [1:14] "Received in the Senate and Read twice and referred to the Committee on Foreign Relations." "Motion to reconsider laid on the table Agreed to without objection." "On motion to suspend the rules and pass the bill, as amended Agreed to by the Yeas and Nays: (2/3 required): 30"| __truncated__ "Passed/agreed to in House: On motion to suspend the rules and pass the bill, as amended Agreed to by the Yeas a"| __truncated__ ...
  ..$ action_type                 : Ord.factor w/ 6 levels "IntroReferral"&lt;..: 1 3 3 3 3 3 3 3 3 2 ...
  ..$ action_time                 : 'hms' num [1:14] NA 19:46:03 19:46:02 19:46:02 ...
  .. ..- attr(*, "units")= chr "secs"
  ..$ action_code                 : chr [1:14] NA "H38310" "H37300" "8000" ...</code></pre>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [1 × 11] (S3: tbl_df/tbl/data.frame)
  ..$ sponsor_bioguide_id            : chr "C001078"
  ..$ sponsor_full_name              : chr "Rep. Connolly, Gerald E. [D-VA-11]"
  ..$ sponsor_first_name             : chr "Gerald"
  ..$ sponsor_middle_name            : chr "E."
  ..$ sponsor_last_name              : chr "Connolly"
  ..$ sponsor_party                  : chr "D"
  ..$ sponsor_state                  : chr "VA"
  ..$ sponsor_identifiers_lis_id     : chr "1959"
  ..$ sponsor_identifiers_bioguide_id: chr "C001078"
  ..$ sponsor_identifiers_gpo_id     : chr "8202"
  ..$ sponsor_district               : chr "11"</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="parsing" class="level1 page-columns page-full"><h1>Parsing</h1>
<p>With an understanding of your data’s structure and your intended output, let’s break down the process into extracting 1) singular elements i.e.&nbsp;only one value, and 2) nested elements. Your output should inform what you do with both, but for either case I convert XML to a list and use <code>{purrr]</code> to flatten and transform the list into a data frame.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Write Functions
</div>
</div>
<div class="callout-body-container callout-body">
<p>For more complex cases, I would implore you to write functions. They make your code more reliable, easier to debug, and make you think critically about how you are handling data. A good resource to start learning about writing functions is <a href="https://www.earthdatascience.org/courses/earth-analytics/automate-science-workflows/write-function-r-programming/">How to Write a Function in R</a>.</p>
</div>
</div>
<section id="singular-elements" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="singular-elements">Singular elements</h2>
<p>You can think of singular elements as the contents of a single cell in a data frame. In the bookstore example, you could arrange each book as a row and each child node as a column.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bookstore_xml_text</span> <span class="op">=</span> <span class="st">'&lt;bookstore&gt;</span></span>
<span><span class="st">  &lt;book category="children"&gt;</span></span>
<span><span class="st">    &lt;title&gt;Harry Potter&lt;/title&gt;</span></span>
<span><span class="st">    &lt;author&gt;J K. Rowling&lt;/author&gt;</span></span>
<span><span class="st">    &lt;year&gt;2005&lt;/year&gt;</span></span>
<span><span class="st">    &lt;price&gt;29.99&lt;/price&gt;</span></span>
<span><span class="st">  &lt;/book&gt;</span></span>
<span><span class="st">  &lt;book category="web"&gt;</span></span>
<span><span class="st">    &lt;title&gt;Learning XML&lt;/title&gt;</span></span>
<span><span class="st">    &lt;author&gt;Erik T. Ray&lt;/author&gt;</span></span>
<span><span class="st">    &lt;year&gt;2003&lt;/year&gt;</span></span>
<span><span class="st">    &lt;price&gt;39.95&lt;/price&gt;</span></span>
<span><span class="st">  &lt;/book&gt;</span></span>
<span><span class="st">&lt;/bookstore&gt;'</span></span>
<span></span>
<span><span class="va">bookstore_xml_parsed</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlTreeParse.html">xmlParse</a></span><span class="op">(</span><span class="va">bookstore_xml_text</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">bookstore_xml_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame</a></span><span class="op">(</span><span class="va">bookstore_xml_parsed</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>         title       author year price
1 Harry Potter J K. Rowling 2005 29.99
2 Learning XML  Erik T. Ray 2003 39.95</code></pre>
</div>
</div>
<p>In cases where your data are entirely singular nodes, you can convert XML to a dataframe using two functions from <a href="http://www.omegahat.net/RSXML/">XML</a><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>: <code><a href="https://rdrr.io/pkg/XML/man/xmlTreeParse.html">xmlParse()</a></code> and <code><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame()</a></code>. Because the congressional data has singular and nested element structures, the nested data in fields like <code>committees</code>, <code>actions</code>, and <code>sponsors</code> are combined into single columns. If your data is not all singular nodes like this, you’ll need to do a little bit more work to get the data into a <a href="https://vita.had.co.nz/papers/tidy-data.html">tidy data</a> frame.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># First you need to use the xmlParse function</span></span>
<span><span class="va">bill_xml_parse</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlTreeParse.html">xmlParse</a></span><span class="op">(</span><span class="va">bill_xml</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/XML/man/getNodeSet.html">getNodeSet</a></span><span class="op">(</span><span class="va">bill_xml_parse</span>, <span class="st">"//bill"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre class="code-block-h"><code>Rows: 1
Columns: 28
$ billNumber                           &lt;chr&gt; "391"
$ createDate                           &lt;chr&gt; "2021-01-22T08:12:10Z"
$ updateDate                           &lt;chr&gt; "2022-02-09T12:37:52Z"
$ originChamber                        &lt;chr&gt; "House"
$ billType                             &lt;chr&gt; "HR"
$ introducedDate                       &lt;chr&gt; "2021-01-21"
$ congress                             &lt;chr&gt; "117"
$ constitutionalAuthorityStatementText &lt;chr&gt; "&lt;pre&gt;[Congressional Record Volum…
$ recordedVotes                        &lt;chr&gt; "188https://clerk.house.gov/evs/2…
$ committees                           &lt;chr&gt; "ssfr00Foreign Relations Committe…
$ committeeReports                     &lt;chr&gt; ""
$ relatedBills                         &lt;chr&gt; ""
$ actions                              &lt;chr&gt; "2021-07-12ssfr00Foreign Relation…
$ sponsors                             &lt;chr&gt; "C001078Rep. Connolly, Gerald E. …
$ cosponsors                           &lt;chr&gt; "C000266Rep. Chabot, Steve [R-OH-…
$ cboCostEstimates                     &lt;chr&gt; "2021-05-11T15:11:11ZH.R. 391, Gl…
$ laws                                 &lt;chr&gt; ""
$ notes                                &lt;chr&gt; ""
$ policyArea                           &lt;chr&gt; "International Affairs"
$ subjects                             &lt;chr&gt; "Advisory bodiesAnimal and plant …
$ summaries                            &lt;chr&gt; "002021-01-21Introduced in House2…
$ title                                &lt;chr&gt; "Global Health Security Act of 20…
$ titles                               &lt;chr&gt; "Display TitleGlobal Health Secur…
$ amendments                           &lt;chr&gt; ""
$ textVersions                         &lt;chr&gt; "Referred in Senate2021-07-12T04:…
$ latestAction                         &lt;chr&gt; "2021-07-12Received in the Senate…
$ calendarNumbers                      &lt;chr&gt; ""
$ version                              &lt;chr&gt; "1.0.0"</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this example, we actually need to use <code>getNodeSet(., [path =] "//bill")</code> to select only nodes in <code>&lt;bill&gt;</code>. If we just passed <code>bill_xml_parse</code>, we would get a dataframe with two rows because the top-level nodes are bill and the metadata identifier node <code>&lt;dublinCore&gt;</code>.</p>
</div>
</div>
<p>To start building our congressional bill dataset, we need to isolate singular elements like <code>billNumber</code> and <code>billType</code> by selecting nodes which meet two criteria: 1) the node does not have any child nodes of its own, and 2) the node is not an empty string. I use to extract nodes based on an <a href="https://www.w3schools.com/xml/xml_parser.asp">XPath</a> (XML Path Language) string. It returns an <code>{xml_nodeset}</code> which is then coerced to a list using <code><a href="http://xml2.r-lib.org/reference/as_list.html">as_list()</a></code>.</p>
<p>As the help file for <code><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all()</a></code> says, “XPath is like regular expressions for trees”. The expression selects the nodes which match the given path or pattern<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>. In the code below <code>//bill/*</code> selects the child nodes in a bill. The expressions <code>[</code> within the square brackets <code>]</code> are called predicates which I use to find nodes which have no children with the XPath <code>count</code> function and nodes which are not empty strings<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">singular_nodes</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span></span>
<span>  <span class="va">bill_xml</span>, </span>
<span>  <span class="st">"//bill/*[count(./*) = 0 and not(string-length(.) = 0)]"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">singular_list</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">singular_nodes</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ :List of 1
  ..$ : chr "391"
 $ :List of 1
  ..$ : chr "2021-01-22T08:12:10Z"
 $ :List of 1
  ..$ : chr "2022-02-09T12:37:52Z"
 $ :List of 1
  ..$ : chr "House"
 $ :List of 1
  ..$ : chr "HR"
 $ :List of 1
  ..$ : chr "2021-01-21"
 $ :List of 1
  ..$ : chr "117"
 $ :List of 1
  ..$ : chr "&lt;pre&gt;[Congressional Record Volume 167, Number 17 (Thursday, January 28, 2021)][House]From the Congressional Rec"| __truncated__
 $ :List of 1
  ..$ : chr "Global Health Security Act of 2021"
 $ :List of 1
  ..$ : chr "1.0.0"</code></pre>
</div>
</div>
<p>Note that we didn’t retain the element names so we need to assign them ourselves. When your data is in a named list, you can flatten each element in the list into a <strong>d</strong>ata <strong>f</strong>rame <strong>c</strong>olumn using purrr’s <code><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfc()</a></code> .</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">singular_list_named</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">singular_list</span>, </span>
<span>                                <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_name.html">xml_name</a></span><span class="op">(</span><span class="va">singular_nodes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">bill_df</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfc</a></span><span class="op">(</span><span class="va">singular_list_named</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 10
$ billNumber                           &lt;chr&gt; "391"
$ createDate                           &lt;chr&gt; "2021-01-22T08:12:10Z"
$ updateDate                           &lt;chr&gt; "2022-02-09T12:37:52Z"
$ originChamber                        &lt;chr&gt; "House"
$ billType                             &lt;chr&gt; "HR"
$ introducedDate                       &lt;chr&gt; "2021-01-21"
$ congress                             &lt;chr&gt; "117"
$ constitutionalAuthorityStatementText &lt;chr&gt; "&lt;pre&gt;[Congressional Record Volum…
$ title                                &lt;chr&gt; "Global Health Security Act of 20…
$ version                              &lt;chr&gt; "1.0.0"</code></pre>
</div>
</div>
<div class="cell column-page">

</div>
</section><section id="nested-elements" class="level2"><h2 class="anchored" data-anchor-id="nested-elements">Nested elements</h2>
<p>At this point I should be clear about one of my assumptions: that performance with list-columns scales reasonably in various dimensions. I have yet to hit a computational wall<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>, but I am sure at some point it would be much smarter to store this information in a relational database. In either case you may come across elements with multiple children, multiple children with their own sub-elements, and elements with nested XML data. I’ll be As you dive deeper into your data you’ll likely have to decide which information you’re extracting and how.</p>
<p>To include actions and votes, we can take advantage of the <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code>/<code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> functionality of <a href="https://tidyr.tidyverse.org">tidyr</a>. We use the same steps as before to convert the XML to a list and then nest them in a list column.</p>
<section id="multiple-children" class="level3"><h3 class="anchored" data-anchor-id="multiple-children">Multiple children</h3>
<p>This section’s still under construction, if you’re reading this and you’re not someone I sent this to I am impressed you’ve managed to reach this corner of the internet.</p>
</section><section id="multiple-children-with-sub-elements" class="level3"><h3 class="anchored" data-anchor-id="multiple-children-with-sub-elements">Multiple children with sub-elements</h3>
<p>The actions node has an <code>&lt;item&gt;</code> child node for each congressional action taken for a bill, such as being introduced, sent to a committee, debated on the floor, etc.. Just as before, we use <code><a href="http://xml2.r-lib.org/reference/as_list.html">as_list()</a></code> to convert the <code>{xml_nodeset}</code> to a list.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">actions_xml</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">bill_node</span>, <span class="st">"actions/item"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">actions_list</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">actions_xml</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at first action</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">actions_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 6
 $ actionDate  :List of 1
  ..$ : chr "2021-07-12"
 $ committees  :List of 1
  ..$ item:List of 2
  .. ..$ systemCode:List of 1
  .. ..$ name      :List of 1
 $ links       : list()
 $ sourceSystem:List of 2
  ..$ code:List of 1
  .. ..$ : chr "0"
  ..$ name:List of 1
  .. ..$ : chr "Senate"
 $ text        :List of 1
  ..$ : chr "Received in the Senate and Read twice and referred to the Committee on Foreign Relations."
 $ type        :List of 1
  ..$ : chr "IntroReferral"</code></pre>
</div>
</div>
<p>In the individual action container, we have the date, a list of committees related to the action, some administrative information, the text and type of action. To deal with this, we can write a function (or set of functions) like the ones below to process an action.</p>
<div class="cell">
<details><summary>View Functions</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Helper function: flatten_dfc_rename</span></span>
<span><span class="co"># flatten a list to data frame and </span></span>
<span><span class="co"># rename the columns with a given prefix</span></span>
<span><span class="va">flatten_dfc_rename</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">list_to_flatten</span>, </span>
<span>                          <span class="va">name_prefix</span> <span class="op">=</span> <span class="st">"prefix"</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span></span>
<span>    .data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfc</a></span><span class="op">(</span><span class="va">list_to_flatten</span><span class="op">)</span>, </span>
<span>    .fn <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="va">name_prefix</span>, <span class="st">"_"</span>, <span class="va">.</span><span class="op">)</span>,</span>
<span>    <span class="co"># Exclude columns which already start with the prefix</span></span>
<span>    .cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="va">name_prefix</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Function: parse_action</span></span>
<span><span class="co"># Parse actions from list to data frame</span></span>
<span><span class="va">parse_action</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">action</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">action</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Flatten+rename sourceSystem elements</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at</a></span><span class="op">(</span><span class="st">"sourceSystem"</span>, <span class="op">~</span><span class="fu">flatten_dfc_rename</span><span class="op">(</span><span class="va">.x</span>, <span class="st">"source"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Flatten+rename committees</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at</a></span><span class="op">(</span><span class="st">"committees"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">committee</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">committee</span>, <span class="op">~</span><span class="fu">flatten_dfc_rename</span><span class="op">(</span><span class="va">.x</span>, <span class="st">"committee"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Flatten object to data frame</span></span>
<span>    <span class="fu">flatten_dfc_rename</span><span class="op">(</span><span class="va">.</span>, <span class="st">"action"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Lastly, clean the names</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Using the <a href="http://purrr.tidyverse.org">purrr</a> library’s <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code>, we apply this function to each action and combine the results into <strong>d</strong>ata <strong>f</strong>rame <strong>r</strong>ows. Here’s the output of this process:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Parse the first action</span></span>
<span><span class="op">(</span><span class="va">actions_df</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">actions_list</span>, <span class="va">parse_action</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 14
Columns: 9
$ action_date                  &lt;chr&gt; "2021-07-12", "2021-06-28", "2021-06-28",…
$ action_committee_system_code &lt;chr&gt; "ssfr00", NA, NA, NA, NA, NA, NA, NA, NA,…
$ action_committee_name        &lt;chr&gt; "Foreign Relations Committee", NA, NA, NA…
$ action_source_code           &lt;chr&gt; "0", "2", "2", "9", "2", "2", "2", "2", "…
$ action_source_name           &lt;chr&gt; "Senate", "House floor actions", "House f…
$ action_text                  &lt;chr&gt; "Received in the Senate and Read twice an…
$ action_type                  &lt;chr&gt; "IntroReferral", "Floor", "Floor", "Floor…
$ action_time                  &lt;chr&gt; NA, "19:46:03", "19:46:02", "19:46:02", "…
$ action_code                  &lt;chr&gt; NA, "H38310", "H37300", "8000", "H30000",…</code></pre>
</div>
</div>
<p>It is useful to be explicit about the data types when you plan to combine rows into a data frame or <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> the data in the future. I do this using <code><a href="https://readr.tidyverse.org/reference/type_convert.html">type_convert()</a></code> to ensure the columns have a specific datatype. To add these actions data as a list column to <code>bill_df</code> we can simply use dollar assignment.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">actions_df</span> <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/type_convert.html">type_convert</a></span><span class="op">(</span><span class="va">actions_df</span>,</span>
<span>                          col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span></span>
<span>                            action_date <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_datetime.html">col_date</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_time <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_datetime.html">col_time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                            action_committee_systemCode <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_committee_name <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_source_code <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                            action_source_name <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                            action_text <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_type <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_code <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html">col_character</a></span><span class="op">(</span><span class="op">)</span></span>
<span>                            <span class="op">)</span></span>
<span>                          <span class="op">)</span></span>
<span></span>
<span><span class="va">bill_df</span><span class="op">$</span><span class="va">actions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">actions_df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="nested-xml" class="level3"><h3 class="anchored" data-anchor-id="nested-xml">Nested XML</h3>
<p>Sometimes you can even have links to other XML files in a node, as we can see in the <code>&lt;recordedVotes&gt;</code> element. Votes are particularly interesting because it provides a more discrete measure of our representatives’ behaviour.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">bill_recorded_vote_nodes</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">bill_node</span>, <span class="st">"recordedVotes/recordedVote"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (1)}
[1] &lt;recordedVote&gt;\n  &lt;rollNumber&gt;188&lt;/rollNumber&gt;\n  &lt;url&gt;https://clerk.hous ...</code></pre>
</div>
</div>
<p>You may have spotted why votes are interesting elements to parse because inside the <code>&lt;url&gt;</code> element we find <strong>another</strong> <strong>XML file</strong>!<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> Before we dive into that can of worms, I’ll convert the top-level nodes to a list and flatten it into columns. Note we use <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> with <code>votes_list</code> because there could be multiple vote objects.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Coerce nodes to list</span></span>
<span><span class="va">recorded_votes_list</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">bill_recorded_vote_nodes</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">recorded_votes_df</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">recorded_votes_list</span>, <span class="va">flatten_dfc</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 7
$ rollNumber     &lt;chr&gt; "188"
$ url            &lt;chr&gt; "https://clerk.house.gov/evs/2021/roll188.xml"
$ fullActionName &lt;chr&gt; "Final Passage Under Suspension of the Rules Results"
$ chamber        &lt;chr&gt; "House"
$ congress       &lt;chr&gt; "117"
$ date           &lt;chr&gt; "2021-06-28T23:46:02Z"
$ sessionNumber  &lt;chr&gt; "1"</code></pre>
</div>
</div>
<p>Now we want to get the vote roll XML file, so we go back to <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml()</a></code> . There are two main nodes - <code>&lt;vote-metadata&gt;</code> and <code>&lt;vote-data&gt;</code>. One node contains the aggregated vote information, while <code>&lt;vote-data&gt;</code> contains the legislator-level vote data. Let’s try to parse the legislator-level data first. Here is the XML for a single legislator’s vote:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vote_roll_xml</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="va">recorded_votes_df</span><span class="op">$</span><span class="va">url</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vote_data</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_roll_xml</span>, <span class="st">"vote-data"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vote_legislators</span> <span class="op">=</span> <span class="va">vote_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">"recorded-vote"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">legislators_list</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">vote_legislators</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ :List of 2
  ..$ legislator:List of 1
  .. ..$ : chr "Adams"
  .. ..- attr(*, "name-id")= chr "A000370"
  .. ..- attr(*, "sort-field")= chr "Adams"
  .. ..- attr(*, "unaccented-name")= chr "Adams"
  .. ..- attr(*, "party")= chr "D"
  .. ..- attr(*, "state")= chr "NC"
  .. ..- attr(*, "role")= chr "legislator"
  ..$ vote      :List of 1
  .. ..$ : chr "Yea"</code></pre>
</div>
</div>
<p>With a similar combination of <code><a href="http://xml2.r-lib.org/reference/as_list.html">as_list()</a></code> , <code><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfr()</a></code>, and <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> we can flatten the XML into one row per legislator but we lose all the attributes.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">vote_roll_flattened</span> <span class="op">=</span> <span class="va">vote_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfr</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 430 × 2
   legislator  vote 
   &lt;chr&gt;       &lt;chr&gt;
 1 Adams       Yea  
 2 Aderholt    Nay  
 3 Aguilar     Yea  
 4 Allen       Nay  
 5 Allred      Yea  
 6 Amodei      Yea  
 7 Armstrong   Yea  
 8 Arrington   Nay  
 9 Auchincloss Yea  
10 Axne        Yea  
# … with 420 more rows</code></pre>
</div>
</div>
<p>Instead we’ll need to extract the attributes before we flatten the data. We want to extract the attributes only for legislator using <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> to apply <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at()</a></code> on each legislator element and extract the attributes from each while retaining the value in <code>vote</code>. It can often feel like you’re getting lost in a list of lists, but with some experimentation you’ll be able to find your way back to the surface.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">legislator_vote_df</span> <span class="op">=</span> <span class="va">legislators_list</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Modify one level deeper using map_at to target legislator elements</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">map_at</span>, <span class="st">"legislator"</span>, <span class="va">attributes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">flatten_dfc</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 430 × 7
   `name-id` `sort-field` `unaccented-name` party state role       vote 
   &lt;chr&gt;     &lt;chr&gt;        &lt;chr&gt;             &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
 1 A000370   Adams        Adams             D     NC    legislator Yea  
 2 A000055   Aderholt     Aderholt          R     AL    legislator Nay  
 3 A000371   Aguilar      Aguilar           D     CA    legislator Yea  
 4 A000372   Allen        Allen             R     GA    legislator Nay  
 5 A000376   Allred       Allred            D     TX    legislator Yea  
 6 A000369   Amodei       Amodei            R     NV    legislator Yea  
 7 A000377   Armstrong    Armstrong         R     ND    legislator Yea  
 8 A000375   Arrington    Arrington         R     TX    legislator Nay  
 9 A000148   Auchincloss  Auchincloss       D     MA    legislator Yea  
10 A000378   Axne         Axne              D     IA    legislator Yea  
# … with 420 more rows</code></pre>
</div>
</div>
<p>Now we have a table of legislator voting data! But what about the <code>&lt;vote-metadata&gt;</code>? Everything other than the <code>&lt;vote-totals&gt;</code> element is singular so we can get that out of the way the same way as before:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vote_metadata</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_roll_xml</span>, <span class="st">"vote-metadata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vote_singular_nodes</span> <span class="op">=</span> <span class="fu">xml_singular_nodes</span><span class="op">(</span><span class="va">vote_metadata</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">vote_df</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">vote_singular_nodes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># as_list() doesn't retain element names so we set names ourselves</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_name.html">xml_name</a></span><span class="op">(</span><span class="va">vote_singular_nodes</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfc</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 12
$ majority        &lt;chr&gt; "D"
$ congress        &lt;chr&gt; "117"
$ session         &lt;chr&gt; "1st"
$ chamber         &lt;chr&gt; "U.S. House of Representatives"
$ `rollcall-num`  &lt;chr&gt; "188"
$ `legis-num`     &lt;chr&gt; "H R 391"
$ `vote-question` &lt;chr&gt; "On Motion to Suspend the Rules and Pass, as Amended"
$ `vote-type`     &lt;chr&gt; "2/3 YEA-AND-NAY"
$ `vote-result`   &lt;chr&gt; "Passed"
$ `action-date`   &lt;chr&gt; "28-Jun-2021"
$ `action-time`   &lt;chr&gt; "7:42 PM"
$ `vote-desc`     &lt;chr&gt; "Global Health Security Act"</code></pre>
</div>
</div>
<p>The <code>&lt;vote-totals&gt;</code> are a bit of a unique little element, with 3 different types of nodes. This is another opportunity for us to be choosy with our data. The first node is table headers, which we don’t need because the elements are tagged anyway. From these, we really only need the <code>&lt;totals-by-party&gt;</code> nodes as long as the totals of which agree with <code>&lt;totals-by-vote&gt;</code> , which is worth checking.</p>
<div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">vote_totals</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_metadata</span>, <span class="st">"vote-totals"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vote_totals_by_party</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_totals</span>, <span class="st">"totals-by-party"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">party_vote_totals_df</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">vote_totals_by_party</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">flatten_dfc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://readr.tidyverse.org/reference/type_convert.html">type_convert</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>
── Column specification ────────────────────────────────────────────────────────
cols(
  party = col_character(),
  `yea-total` = col_double(),
  `nay-total` = col_double(),
  `present-total` = col_double(),
  `not-voting-total` = col_double()
)</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">totals_by_vote</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_totals</span>, <span class="st">"totals-by-vote"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<pre><code>{xml_nodeset (5)}
[1] &lt;totals-by-party-header&gt;\n  &lt;party-header&gt;Party&lt;/party-header&gt;\n  &lt;yea-he ...
[2] &lt;totals-by-party&gt;\n  &lt;party&gt;Republican&lt;/party&gt;\n  &lt;yea-total&gt;90&lt;/yea-tota ...
[3] &lt;totals-by-party&gt;\n  &lt;party&gt;Democratic&lt;/party&gt;\n  &lt;yea-total&gt;217&lt;/yea-tot ...
[4] &lt;totals-by-party&gt;\n  &lt;party&gt;Independent&lt;/party&gt;\n  &lt;yea-total&gt;0&lt;/yea-tota ...
[5] &lt;totals-by-vote&gt;\n  &lt;total-stub&gt;Totals&lt;/total-stub&gt;\n  &lt;yea-total&gt;307&lt;/ye ...</code></pre>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<pre><code>{xml_nodeset (5)}
[1] &lt;total-stub&gt;Totals&lt;/total-stub&gt;
[2] &lt;yea-total&gt;307&lt;/yea-total&gt;
[3] &lt;nay-total&gt;112&lt;/nay-total&gt;
[4] &lt;present-total&gt;0&lt;/present-total&gt;
[5] &lt;not-voting-total&gt;11&lt;/not-voting-total&gt;</code></pre>
</div>
</div>
</div>
</div>
<p>Once we have our nodeset (which at last are all singular), we use same listing, mapping, and flattening…or <em>lappening</em> as absolutely no one calls it.</p>
<p>Now that we have all of our vote data wrangled from the thorny grasp of XML, we can put it all together.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vote_roll_df</span> <span class="op">=</span> <span class="va">vote_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>legislator_votes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">legislator_vote_df</span><span class="op">)</span>,</span>
<span>         party_votes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">party_vote_totals_df</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">recorded_votes_df</span> <span class="op">=</span> <span class="va">recorded_votes_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>vote_roll <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">vote_roll_df</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 8
$ rollNumber     &lt;chr&gt; "188"
$ url            &lt;chr&gt; "https://clerk.house.gov/evs/2021/roll188.xml"
$ fullActionName &lt;chr&gt; "Final Passage Under Suspension of the Rules Results"
$ chamber        &lt;chr&gt; "House"
$ congress       &lt;chr&gt; "117"
$ date           &lt;chr&gt; "2021-06-28T23:46:02Z"
$ sessionNumber  &lt;chr&gt; "1"
$ vote_roll      &lt;list&gt; [&lt;tbl_df[1 x 14]&gt;]</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bill_df</span><span class="op">$</span><span class="va">votes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">recorded_votes_df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>…all the way until we’ve gotten back to the bill-level. Now we have the bill-level characteristics with action and vote information nested in list columns. If we want to analyze the actions data, we simply have to <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> it.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">bill_df</span>, <span class="va">actions</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 14
Columns: 20
$ billNumber                           &lt;chr&gt; "391", "391", "391", "391", "391"…
$ createDate                           &lt;chr&gt; "2021-01-22T08:12:10Z", "2021-01-…
$ updateDate                           &lt;chr&gt; "2022-02-09T12:37:52Z", "2022-02-…
$ originChamber                        &lt;chr&gt; "House", "House", "House", "House…
$ billType                             &lt;chr&gt; "HR", "HR", "HR", "HR", "HR", "HR…
$ introducedDate                       &lt;chr&gt; "2021-01-21", "2021-01-21", "2021…
$ congress                             &lt;chr&gt; "117", "117", "117", "117", "117"…
$ constitutionalAuthorityStatementText &lt;chr&gt; "&lt;pre&gt;[Congressional Record Volum…
$ title                                &lt;chr&gt; "Global Health Security Act of 20…
$ version                              &lt;chr&gt; "1.0.0", "1.0.0", "1.0.0", "1.0.0…
$ action_date                          &lt;date&gt; 2021-07-12, 2021-06-28, 2021-06-…
$ action_committee_system_code         &lt;chr&gt; "ssfr00", NA, NA, NA, NA, NA, NA,…
$ action_committee_name                &lt;chr&gt; "Foreign Relations Committee", NA…
$ action_source_code                   &lt;chr&gt; "0", "2", "2", "9", "2", "2", "2"…
$ action_source_name                   &lt;chr&gt; "Senate", "House floor actions", …
$ action_text                          &lt;chr&gt; "Received in the Senate and Read …
$ action_type                          &lt;chr&gt; "IntroReferral", "Floor", "Floor"…
$ action_time                          &lt;time&gt;       NA, 19:46:03, 19:46:02, 19…
$ action_code                          &lt;chr&gt; NA, "H38310", "H37300", "8000", "…
$ votes                                &lt;list&gt; [&lt;tbl_df[1 x 8]&gt;], [&lt;tbl_df[1 x …</code></pre>
</div>
</div>
<p>I’ll stop there for brevity’s sake, but you can find the code for extracting the full XML file <a href="https://github.com/MokeEire/my-reps/blob/master/R/parsing_functions.R">here</a><a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>.</p>
</section></section></section><section id="tldr-main-points" class="level1"><h1>TL;DR: Main Points</h1>
<p>Processing XML documents can be simple depending on their structure, so try the simplest method if you can. If your data is making use of XML’s flexibility you might but it can be boiled down to these steps:</p>
<ol type="1">
<li><strong>Explore the structure</strong></li>
</ol>
<blockquote class="blockquote">
<p>Go through any available documentation, and when you read in the XML file you can use functions like <code><a href="https://rdrr.io/pkg/XML/man/xmlTreeParse.html">xmlParse()</a></code>, <code><a href="http://xml2.r-lib.org/reference/xml_structure.html">xml_structure()</a></code>, and <code><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents()</a></code> .</p>
</blockquote>
<ol start="2" type="1">
<li><strong>Define the output</strong></li>
</ol>
<blockquote class="blockquote">
<p>Consider what you want the output to look like and think about how it needs to be transformed to match this target.</p>
</blockquote>
<ol start="3" type="1">
<li>
<strong>Process a single element</strong> (write a function if it gets too complicated)</li>
</ol>
<blockquote class="blockquote">
<p>Get one element into the form you want. Writing functions can help you think through the data transformations being applied and make your code easier to read.</p>
</blockquote>
<ol start="4" type="1">
<li><strong>Apply to all elements</strong></li>
</ol>
<blockquote class="blockquote">
<p>Focus on processing of the entire file (or the subset of the file you’re interested in). You might want an XML file to return a single row, a single column, or a data frame of size <span class="math inline">\(n\times k\)</span>. Once you have a single file returned in the format you want, you can combine the outputs of multiple files.</p>
</blockquote>
<p>Please reach out with any questions or feedback! All is welcome, and there may even be a reward for anyone who finds a mistake in the code.</p>
</section><section id="other-helpful-articles" class="level1"><h1>Other helpful articles</h1>
<p>Here are some of the helpful articles I came across in the course of writing this:</p>
<ul>
<li><a href="https://towardsdatascience.com/from-xml-to-excel-for-data-analysis-ac0c0c765b7d" title="Introduction to Processing XML In Python">From XML to Excel for Data Analysis</a></li>
<li><a href="https://medium.com/geekculture/reading-xml-files-in-r-3122c3a2a8d9">Reading XML files in R</a></li>
</ul></section><section id="session-info" class="level1"><h1>Session Info</h1>
<p>Version information about R, OS, and loaded packages.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.2.1 (2022-06-23 ucrt)
 os       Windows 10 x64 (build 19043)
 system   x86_64, mingw32
 ui       RTerm
 language (EN)
 collate  English_United States.utf8
 ctype    English_United States.utf8
 tz       America/Los_Angeles
 date     2022-08-08
 pandoc   2.18 @ C:/Program Files/RStudio/bin/quarto/bin/tools/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────────
 package        * version   date (UTC) lib source
 assertthat       0.2.1     2019-03-21 [1] CRAN (R 4.2.0)
 backports        1.4.1     2021-12-13 [1] CRAN (R 4.2.0)
 bit              4.0.4     2020-08-04 [1] CRAN (R 4.2.0)
 bit64            4.0.5     2020-08-30 [1] CRAN (R 4.2.0)
 bitops           1.0-7     2021-04-24 [1] CRAN (R 4.2.0)
 broom            1.0.0     2022-07-01 [1] CRAN (R 4.2.1)
 cellranger       1.1.0     2016-07-27 [1] CRAN (R 4.2.0)
 cli              3.3.0     2022-04-25 [1] CRAN (R 4.2.0)
 colorspace       2.0-3     2022-02-21 [1] CRAN (R 4.2.0)
 crayon           1.5.1     2022-03-26 [1] CRAN (R 4.2.0)
 curl             4.3.2     2021-06-23 [1] CRAN (R 4.2.0)
 DBI              1.1.3     2022-06-18 [1] CRAN (R 4.2.0)
 dbplyr           2.2.1     2022-06-27 [1] CRAN (R 4.2.1)
 digest           0.6.29    2021-12-01 [1] CRAN (R 4.2.0)
 dplyr          * 1.0.9     2022-04-28 [1] CRAN (R 4.2.0)
 ellipsis         0.3.2     2021-04-29 [1] CRAN (R 4.2.0)
 evaluate         0.15      2022-02-18 [1] CRAN (R 4.2.0)
 extrafont      * 0.18      2022-04-12 [1] CRAN (R 4.2.0)
 extrafontdb      1.0       2012-06-11 [1] CRAN (R 4.2.0)
 fansi            1.0.3     2022-03-24 [1] CRAN (R 4.2.0)
 fastmap          1.1.0     2021-01-25 [1] CRAN (R 4.2.0)
 forcats        * 0.5.1     2021-01-27 [1] CRAN (R 4.2.0)
 fs               1.5.2     2021-12-08 [1] CRAN (R 4.2.0)
 generics         0.1.2     2022-01-31 [1] CRAN (R 4.2.0)
 ggplot2        * 3.3.6     2022-05-03 [1] CRAN (R 4.2.0)
 glue             1.6.2     2022-02-24 [1] CRAN (R 4.2.0)
 gtable           0.3.0     2019-03-25 [1] CRAN (R 4.2.0)
 haven            2.5.0     2022-04-15 [1] CRAN (R 4.2.0)
 hms              1.1.1     2021-09-26 [1] CRAN (R 4.2.0)
 htmltools        0.5.2     2021-08-25 [1] CRAN (R 4.2.0)
 htmlwidgets      1.5.4     2021-09-08 [1] CRAN (R 4.2.0)
 httr             1.4.3     2022-05-04 [1] CRAN (R 4.2.0)
 janitor          2.1.0     2021-01-05 [1] CRAN (R 4.2.1)
 jsonlite       * 1.8.0     2022-02-22 [1] CRAN (R 4.2.0)
 knitr            1.39      2022-04-26 [1] CRAN (R 4.2.0)
 lifecycle        1.0.1     2021-09-24 [1] CRAN (R 4.2.0)
 log4r          * 0.4.2     2021-11-04 [1] CRAN (R 4.2.0)
 lubridate      * 1.8.0     2021-10-07 [1] CRAN (R 4.2.0)
 magrittr       * 2.0.3     2022-03-30 [1] CRAN (R 4.2.0)
 microbenchmark   1.4.9     2021-11-09 [1] CRAN (R 4.2.0)
 modelr           0.1.8     2020-05-19 [1] CRAN (R 4.2.0)
 mokeR          * 0.1.0     2022-07-16 [1] local
 munsell          0.5.0     2018-06-12 [1] CRAN (R 4.2.0)
 pillar           1.7.0     2022-02-01 [1] CRAN (R 4.2.0)
 pkgconfig        2.0.3     2019-09-22 [1] CRAN (R 4.2.0)
 purrr          * 0.3.4     2020-04-17 [1] CRAN (R 4.2.0)
 R6               2.5.1     2021-08-19 [1] CRAN (R 4.2.0)
 RCurl          * 1.98-1.7  2022-06-09 [1] CRAN (R 4.2.0)
 reactable      * 0.3.0     2022-05-26 [1] CRAN (R 4.2.0)
 readr          * 2.1.2     2022-01-30 [1] CRAN (R 4.2.0)
 readxl           1.4.0     2022-03-28 [1] CRAN (R 4.2.0)
 reprex           2.0.1     2021-08-05 [1] CRAN (R 4.2.0)
 rjson          * 0.2.21    2022-01-09 [1] CRAN (R 4.2.0)
 rlang            1.0.4     2022-07-12 [1] CRAN (R 4.2.1)
 rmarkdown        2.14      2022-04-25 [1] CRAN (R 4.2.0)
 rstudioapi       0.13      2020-11-12 [1] CRAN (R 4.2.0)
 Rttf2pt1         1.3.8     2020-01-10 [1] CRAN (R 4.2.1)
 rvest            1.0.2     2021-10-16 [1] CRAN (R 4.2.0)
 scales           1.2.0     2022-04-13 [1] CRAN (R 4.2.0)
 sessioninfo      1.2.2     2021-12-06 [1] CRAN (R 4.2.0)
 snakecase        0.11.0    2019-05-25 [1] CRAN (R 4.2.1)
 stringi          1.7.6     2021-11-29 [1] CRAN (R 4.2.0)
 stringr        * 1.4.0     2019-02-10 [1] CRAN (R 4.2.0)
 tibble         * 3.1.7     2022-05-03 [1] CRAN (R 4.2.0)
 tidyjson       * 0.3.1     2020-05-31 [1] CRAN (R 4.2.0)
 tidyr          * 1.2.0     2022-02-01 [1] CRAN (R 4.2.0)
 tidyselect       1.1.2     2022-02-21 [1] CRAN (R 4.2.0)
 tidyverse      * 1.3.1     2021-04-15 [1] CRAN (R 4.2.0)
 tzdb             0.3.0     2022-03-28 [1] CRAN (R 4.2.0)
 utf8             1.2.2     2021-07-24 [1] CRAN (R 4.2.0)
 vctrs            0.4.1     2022-04-13 [1] CRAN (R 4.2.0)
 vroom            1.5.7     2021-11-30 [1] CRAN (R 4.2.0)
 withr            2.5.0     2022-03-03 [1] CRAN (R 4.2.0)
 xfun             0.31      2022-05-10 [1] CRAN (R 4.2.0)
 XML            * 3.99-0.10 2022-06-09 [1] CRAN (R 4.2.0)
 xml2           * 1.3.3     2021-11-30 [1] CRAN (R 4.2.0)
 yaml             2.3.5     2022-02-21 [1] CRAN (R 4.2.0)

 [1] C:/Users/Mark/AppData/Local/R/win-library/4.2
 [2] C:/Program Files/R/R-4.2.1/library

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>


<!-- -->

</section><div id="quarto-appendix" class="default"><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://en.wikipedia.org/wiki/XML">Wikipedia</a> for the curious. Don’t miss the drama about Microsoft’s “vociferous protests” as one of the co-editors started working with Netscape.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>The <em>x</em> at the end of Microsoft file types (e.g.&nbsp;.docx, .xlsx, .pptx) stands for XML.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>I chose the bill <a href="https://www.govinfo.gov/app/details/BILLS-117hr391rfs"><em>HR-391: Global Health Security Act of 2021</em></a>only because it contains good examples of the challenges of parsing XML data, so consider this a standard <em>retweets ≠ endorsements</em> situation<em>.</em><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>Between <a href="http://www.omegahat.net/RSXML/">XML</a> and <a href="https://xml2.r-lib.org/">xml2</a> there are numerous ways to load XML data with R. I generally prefer <a href="https://xml2.r-lib.org/">xml2</a> but I suggest looking through the packages’ documentation to find the right function for your task<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p><code>xml_document</code> is one of the “key classes” used in the <a href="https://xml2.r-lib.org/">xml2</a> library, the others being <code>xml_node</code> (a single node), and <code>xml_nodeset</code> (a set of nodes).<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>Which is a document metadata identifier, not an Irish metal music genre. While very useful in its own right, it isn’t relevant for our task here.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>Atomic vectors are vectors with elements of the same type (e.g.&nbsp;numeric, character, etc.) as opposed to <em>general vectors</em>, or lists, which can contain a variety of types.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote">
<p>When you’re working with both the <a href="http://www.omegahat.net/RSXML/">XML</a> and <a href="https://xml2.r-lib.org/">xml2</a> libraries, it is important to note that their functions often rely on different object types. In the case of <code><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame()</a></code>, it does not take <code>{xml_document}</code> or <code>{xml_node}</code> objects. If you try to use them, you’ll see an error like this:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame</a></span><span class="op">(</span><span class="va">bill_xml</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error in (function (classes, fdef, mtable) : unable to find an inherited method for function 'xmlToDataFrame' for signature '"xml_document", "missing", "missing", "missing", "missing"'</code></pre>
</div>
</div>
<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a>
</li>
<li id="fn9" role="doc-endnote"><p><a href="https://www.w3schools.com/XML/xpath_syntax.asp" target="_blank">A very useful table of XPath syntax</a><a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10" role="doc-endnote">
<p>In the process of writing this, I discovered that using XPath made this ~5x faster than an equivalent function in R.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to select singular child nodes from XML node</span></span>
<span><span class="va">xml_singular_nodes</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xml_node</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Return child nodes of current node</span></span>
<span>  <span class="va">child_nodes</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_children</a></span><span class="op">(</span><span class="va">xml_node</span><span class="op">)</span></span>
<span>  <span class="co"># Select child nodes with 0 children</span></span>
<span>  <span class="va">zero_length_child_nodes</span> <span class="op">=</span> <span class="va">child_nodes</span><span class="op">[</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_length</a></span><span class="op">(</span><span class="va">child_nodes</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Keep the nodes which are not empty strings</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">keep</a></span><span class="op">(</span><span class="va">zero_length_child_nodes</span>, <span class="op">~</span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_text</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Using XPath:</span></span>
<span><span class="co"># singular_nodes1 = xml_find_all(bill_xml, </span></span>
<span><span class="co">#                                 "//bill/*[count(./*) = 0 and not(string-length(.) = 0)]")</span></span>
<span></span>
<span><span class="co"># Using R function:</span></span>
<span><span class="co"># singular_nodes2 = xml_singular_nodes(bill_node)</span></span>
<span></span>
<span><span class="co"># Check they are the same</span></span>
<span><span class="co"># all.equal(singular_nodes1, singular_nodes2)</span></span>
<span></span>
<span><span class="co"># benchmark the two different ways of selecting nodes</span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  xml_singular_nodes <span class="op">=</span> <span class="fu">xml_singular_nodes</span><span class="op">(</span><span class="va">bill_node</span><span class="op">)</span>,</span>
<span>  xml_find_all <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">bill_xml</span>, <span class="st">"//bill/*[count(./*) = 0 and not(string-length(.) = 0)]"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
               expr  min   lq mean median   uq  max neval
 xml_singular_nodes 1167 1186 1306   1206 1229 7325   100
       xml_find_all  207  212  239    224  245  780   100</code></pre>
</div>
</div>
<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a>
</li>
<li id="fn11" role="doc-endnote"><p>Parsing ~12,000 congressional bills takes 20 minutes for my computer.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12" role="doc-endnote">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://c.tenor.com/um2EhyMQyR8AAAAC/xzibit-meme.gif" class="img-fluid figure-img" width="267"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">They heard you like XML so they put XML in your XML</figcaption><p></p>
</figure>
</div>
<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a>
</li>
<li id="fn13" role="doc-endnote"><p>Ctrl/Cmd+F: <code>extract_bill_status</code><a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb53" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Parsing XML with R"</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Untangling congressional legislative data"</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2022-07-14"</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> </span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - data</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - governance</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - R</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co">    comments:</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co">      hypothesis: true</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(extrafont)</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reactable)</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"https://github.com/MokeEire/my-reps/raw/master/R/parsing_functions.R"</span>)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>bill_xml_link <span class="ot">=</span> <span class="st">"https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml"</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>bill_xml_file <span class="ot">=</span> <span class="fu">read_xml</span>(bill_xml_link)</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: df-print-fct</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>knit_print.data.frame <span class="ot">=</span> <span class="cf">function</span>(x, ...){</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">knit_print</span>(</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reactable</span>(x,</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>              <span class="at">compact =</span> T, </span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>              <span class="at">resizable =</span> T,</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip appearance="simple"}</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## What you'll learn:</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Load and parse XML files in R using the <span class="in">`{XML}`</span> and <span class="in">`{xml2}`</span> packages</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Explore the structure of XML documents</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>List, map, and flatten your data into a tabular format using <span class="in">`{purrr}`</span> and using list columns with <span class="in">`{tidyr}`</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="fu"># What is XML?</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>Unlike Excel spreadsheets, CSV files, and other tabular formats, (e)Xtensible Markup Language (XML) is a storage format designed to contain any "arbitrary" structure<span class="ot">[^1]</span> of data. This flexibility makes XML useful for storing all kinds of information from financial transactions and recipes to webpage content and document formatting<span class="ot">[^2]</span>. At its core, XML is just "information wrapped in tags". Here is an example of information a bookstore might have in XML format from <span class="co">[</span><span class="ot">w3schools</span><span class="co">](https://www.w3schools.com/XML/xml_usedfor.asp)</span> :</span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span><span class="co">[</span><span class="ot">Wikipedia</span><span class="co">](https://en.wikipedia.org/wiki/XML)</span> for the curious. Don't miss the drama about Microsoft's "vociferous protests" as one of the co-editors started working with Netscape.</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>The *x* at the end of Microsoft file types (e.g. .docx, .xlsx, .pptx) stands for XML.</span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a><span class="in">``` xml</span></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bookstore</span>&gt;</span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"children"</span>&gt;</span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Harry Potter&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;J K. Rowling&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2005&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;29.99&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"web"</span>&gt;</span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Learning XML&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;Erik T. Ray&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2003&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;39.95&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bookstore</span>&gt;</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a>The `&lt;<span class="kw">bookstore</span>&gt;` is the parent, or *root* element. The parent element contains two `&lt;<span class="kw">book</span>&gt;`s which have the elements contained in the tags -- `&lt;<span class="kw">title</span>&gt;`, `&lt;<span class="kw">author</span>&gt;`, `&lt;<span class="kw">year</span>&gt;`, and `&lt;<span class="kw">price</span>&gt;`. XML can be thought of as a tree, where each tree branch can have multiple leaves, or none.</span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>::: {.callout-note appearance="simple"}</span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>## Note that attributes are denoted by key/value assignment in a tag.</span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a>In `&lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"children"</span>&gt;`, the book's category is stored as an attribute. Attributes are a useful way to store data related to a specific element for HTML, but using child elements is typically preferred in XML. This post will touch on data stored using both methods. To learn more about what XML is and how to use it, I recommend going through [w3school's XML tutorial](https://www.w3schools.com/XML/default.asp).</span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a># Navigating XML with R</span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a>To illustrate potential complexities of XML structures, I'll be using congressional bill data provided by the [United States Government Publishing Office (GPO)](https://www.gpo.gov/). You can follow along by downloading the sample XML bill [here](https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml "HR-391: Global Health Security Act of 2021")[^3].</span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a>[^3]: I chose the bill [*HR-391: Global Health Security Act of 2021*](https://www.govinfo.gov/app/details/BILLS-117hr391rfs)only because it contains good examples of the challenges of parsing XML data, so consider this a standard *retweets ≠ endorsements* situation*.*</span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a>Four R packages are important for this article. `{XML}` and `{xml2}`[^4] provide functions for reading in XML data while `{purrr}` and `{tidyr}` (loaded as part of the `{tidyverse}` package) helps us parse and flatten the data into tabular form. To start, read in the file with `read_xml()` , which returns an `xml_document`[^5] object.</span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a>[^4]: Between `{XML}` and `{xml2}` there are numerous ways to load XML data with R. I generally prefer `{xml2}` but I suggest looking through the packages' documentation to find the right function for your task</span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a>[^5]: `xml_document` is one of the "key classes" used in the `{xml2}` library, the others being `xml_node` (a single node), and `xml_nodeset` (a set of nodes).</span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a>#| label: read-xml</span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a>#| code-summary: "Load and view XML file"</span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a>library(tidyverse)</span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a>library(XML)</span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a>library(xml2)</span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a>bill_xml = read_xml("https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml")</span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a># Look at the xml_document's contents</span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a>xml_contents(bill_xml)</span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a>We can see the document has two top-level nodes - one `&lt;<span class="kw">bill</span>&gt;` node and one called `&lt;<span class="kw">dublinCore</span>&gt;`[^6] In this case we can look just at the `&lt;<span class="kw">bill</span>&gt;` node using `xml_child()`.</span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a>[^6]: Which is a document metadata identifier, not an Irish metal music genre. While very useful in its own right, it isn't relevant for our task here.</span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a>#| label: xml-bill-child</span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a>#| code-overflow: wrap</span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a># Return child nodes named bill</span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-135"><a href="#cb53-135" aria-hidden="true" tabindex="-1"></a>(bill_node = xml_child(bill_xml, "bill"))</span>
<span id="cb53-136"><a href="#cb53-136" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a>So if we want to have a data frame with one row per bill, we have a few different kinds of elements to deal with. Firstly there are the elements which have **only one value** (i.e. *singular*) like `billNumber`, `createDate`, and `billType`. There are also elements which have information *nested* in them like `recordedVotes`, `committees`, and `actions`.</span>
<span id="cb53-139"><a href="#cb53-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-140"><a href="#cb53-140" aria-hidden="true" tabindex="-1"></a>The importance of understanding the structure of your data brings us to one of the cardinal rules of data analysis:</span>
<span id="cb53-141"><a href="#cb53-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-142"><a href="#cb53-142" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb53-143"><a href="#cb53-143" aria-hidden="true" tabindex="-1"></a>## Look at your data</span>
<span id="cb53-144"><a href="#cb53-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-145"><a href="#cb53-145" aria-hidden="true" tabindex="-1"></a>In fact, you could even say *stare* at it. Understanding the structure and contents of your data is essential for designing a solution to consistently process the data.</span>
<span id="cb53-146"><a href="#cb53-146" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-147"><a href="#cb53-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-148"><a href="#cb53-148" aria-hidden="true" tabindex="-1"></a># Define the output</span>
<span id="cb53-149"><a href="#cb53-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-150"><a href="#cb53-150" aria-hidden="true" tabindex="-1"></a>As well as looking at your data, it's also helpful to think about your intended output. This determines what you need to do to transform the data. Depending on the structure of your XML data, there are a lot of different options.</span>
<span id="cb53-151"><a href="#cb53-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-152"><a href="#cb53-152" aria-hidden="true" tabindex="-1"></a>In the case of congressional data, we have multiple levels of observation - bill, action, vote, and individual legislator votes. To organize the data in a way that preserves each, we can use rows, columns, separate tables linked by some combination of ID variables, or we can use [list columns](https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html). Columns in a data frame are typically *atomic vectors*[^7] of equal length, but list columns enable us to store data of varying length and type, including data frames themselves. This makes them a perfect solution for the nested characteristics of the congressional data. Using `{tidyr}`, we will `nest()`/`unnest()` these columns as needed. The end result will look like this:</span>
<span id="cb53-153"><a href="#cb53-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-154"><a href="#cb53-154" aria-hidden="true" tabindex="-1"></a>[^7]: Atomic vectors are vectors with elements of the same type (e.g. numeric, character, etc.) as opposed to *general vectors*, or lists, which can contain a variety of types.</span>
<span id="cb53-155"><a href="#cb53-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-158"><a href="#cb53-158" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-159"><a href="#cb53-159" aria-hidden="true" tabindex="-1"></a>#| label: example-bill</span>
<span id="cb53-160"><a href="#cb53-160" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-161"><a href="#cb53-161" aria-hidden="true" tabindex="-1"></a>#| message: false</span>
<span id="cb53-162"><a href="#cb53-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-163"><a href="#cb53-163" aria-hidden="true" tabindex="-1"></a>example_bill_df = extract_bill_status(bill_xml_link, log_types = NULL)</span>
<span id="cb53-164"><a href="#cb53-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-165"><a href="#cb53-165" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df)</span>
<span id="cb53-166"><a href="#cb53-166" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-167"><a href="#cb53-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-170"><a href="#cb53-170" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-171"><a href="#cb53-171" aria-hidden="true" tabindex="-1"></a>#| label: example-bill-rt</span>
<span id="cb53-172"><a href="#cb53-172" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-173"><a href="#cb53-173" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb53-174"><a href="#cb53-174" aria-hidden="true" tabindex="-1"></a>example_bill_df %&gt;% #glimpse() # here to check the data</span>
<span id="cb53-175"><a href="#cb53-175" aria-hidden="true" tabindex="-1"></a>  # select(</span>
<span id="cb53-176"><a href="#cb53-176" aria-hidden="true" tabindex="-1"></a>  #   -bill_id, -where(is_list) # remove list columns?</span>
<span id="cb53-177"><a href="#cb53-177" aria-hidden="true" tabindex="-1"></a>  # ) %&gt;%</span>
<span id="cb53-178"><a href="#cb53-178" aria-hidden="true" tabindex="-1"></a>  reactable::reactable(</span>
<span id="cb53-179"><a href="#cb53-179" aria-hidden="true" tabindex="-1"></a>    theme = moke_rt(),</span>
<span id="cb53-180"><a href="#cb53-180" aria-hidden="true" tabindex="-1"></a>    compact = T,</span>
<span id="cb53-181"><a href="#cb53-181" aria-hidden="true" tabindex="-1"></a>    resizable = T,</span>
<span id="cb53-182"><a href="#cb53-182" aria-hidden="true" tabindex="-1"></a>    wrap = F,</span>
<span id="cb53-183"><a href="#cb53-183" aria-hidden="true" tabindex="-1"></a>    columns = list(</span>
<span id="cb53-184"><a href="#cb53-184" aria-hidden="true" tabindex="-1"></a>      "bill_number" = colDef(width = 100),</span>
<span id="cb53-185"><a href="#cb53-185" aria-hidden="true" tabindex="-1"></a>      "create_date" = colDef(format = colFormat(date = T), width = 100),</span>
<span id="cb53-186"><a href="#cb53-186" aria-hidden="true" tabindex="-1"></a>      "update_date" = colDef(format = colFormat(date = T), width = 100),</span>
<span id="cb53-187"><a href="#cb53-187" aria-hidden="true" tabindex="-1"></a>      "origin_chamber" = colDef(show=F),</span>
<span id="cb53-188"><a href="#cb53-188" aria-hidden="true" tabindex="-1"></a>      "bill_type" = colDef(width = 80),</span>
<span id="cb53-189"><a href="#cb53-189" aria-hidden="true" tabindex="-1"></a>      "introduced_date" = colDef(format = colFormat(date = T), width = 130),</span>
<span id="cb53-190"><a href="#cb53-190" aria-hidden="true" tabindex="-1"></a>      "congress" = colDef(width = 80),</span>
<span id="cb53-191"><a href="#cb53-191" aria-hidden="true" tabindex="-1"></a>      "constitutional_authority_statement_text" = colDef(show=F),</span>
<span id="cb53-192"><a href="#cb53-192" aria-hidden="true" tabindex="-1"></a>      "title" = colDef(minWidth = 180),</span>
<span id="cb53-193"><a href="#cb53-193" aria-hidden="true" tabindex="-1"></a>      "version" = colDef(show = F, width = 80),</span>
<span id="cb53-194"><a href="#cb53-194" aria-hidden="true" tabindex="-1"></a>      "policy_areas" = colDef(width = 120),</span>
<span id="cb53-195"><a href="#cb53-195" aria-hidden="true" tabindex="-1"></a>      "legislative_subjects" = colDef(width = 200),</span>
<span id="cb53-196"><a href="#cb53-196" aria-hidden="true" tabindex="-1"></a>      "bill_summaries" = colDef(show=F),</span>
<span id="cb53-197"><a href="#cb53-197" aria-hidden="true" tabindex="-1"></a>      "bill_titles" = colDef(show=F),</span>
<span id="cb53-198"><a href="#cb53-198" aria-hidden="true" tabindex="-1"></a>      "bill_text_versions" = colDef(show=F),</span>
<span id="cb53-199"><a href="#cb53-199" aria-hidden="true" tabindex="-1"></a>      "latest_action_action_date" = colDef(name = "action_date", </span>
<span id="cb53-200"><a href="#cb53-200" aria-hidden="true" tabindex="-1"></a>                                           width = 110,</span>
<span id="cb53-201"><a href="#cb53-201" aria-hidden="true" tabindex="-1"></a>                                           format = colFormat(date = T)),</span>
<span id="cb53-202"><a href="#cb53-202" aria-hidden="true" tabindex="-1"></a>      "latest_action_text" = colDef(name = "action_text",</span>
<span id="cb53-203"><a href="#cb53-203" aria-hidden="true" tabindex="-1"></a>                                    minWidth = 200),</span>
<span id="cb53-204"><a href="#cb53-204" aria-hidden="true" tabindex="-1"></a>      "committees" = colDef(minWidth = 80),</span>
<span id="cb53-205"><a href="#cb53-205" aria-hidden="true" tabindex="-1"></a>      "votes" = colDef(width = 80),</span>
<span id="cb53-206"><a href="#cb53-206" aria-hidden="true" tabindex="-1"></a>      "actions" = colDef(width = 80),</span>
<span id="cb53-207"><a href="#cb53-207" aria-hidden="true" tabindex="-1"></a>      "action_counts" = colDef(show=F),</span>
<span id="cb53-208"><a href="#cb53-208" aria-hidden="true" tabindex="-1"></a>      "sponsors" = colDef(width = 80),</span>
<span id="cb53-209"><a href="#cb53-209" aria-hidden="true" tabindex="-1"></a>      "cosponsors" = colDef(width = 80)</span>
<span id="cb53-210"><a href="#cb53-210" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb53-211"><a href="#cb53-211" aria-hidden="true" tabindex="-1"></a>    columnGroups = list(</span>
<span id="cb53-212"><a href="#cb53-212" aria-hidden="true" tabindex="-1"></a>      colGroup(name = "Latest Action",</span>
<span id="cb53-213"><a href="#cb53-213" aria-hidden="true" tabindex="-1"></a>                            columns = c("latest_action_action_date",</span>
<span id="cb53-214"><a href="#cb53-214" aria-hidden="true" tabindex="-1"></a>                                        "latest_action_text")),</span>
<span id="cb53-215"><a href="#cb53-215" aria-hidden="true" tabindex="-1"></a>      colGroup(name = "Nested Data",</span>
<span id="cb53-216"><a href="#cb53-216" aria-hidden="true" tabindex="-1"></a>                            columns = c("committees", "votes", "actions", </span>
<span id="cb53-217"><a href="#cb53-217" aria-hidden="true" tabindex="-1"></a>                                        "sponsors", "cosponsors"))</span>
<span id="cb53-218"><a href="#cb53-218" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-219"><a href="#cb53-219" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-220"><a href="#cb53-220" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-221"><a href="#cb53-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-222"><a href="#cb53-222" aria-hidden="true" tabindex="-1"></a>Here's a `glimpse()` of some of the nested data:</span>
<span id="cb53-223"><a href="#cb53-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-224"><a href="#cb53-224" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb53-225"><a href="#cb53-225" aria-hidden="true" tabindex="-1"></a>## Committees</span>
<span id="cb53-226"><a href="#cb53-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-229"><a href="#cb53-229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-230"><a href="#cb53-230" aria-hidden="true" tabindex="-1"></a>#| label: glimpse-committees</span>
<span id="cb53-231"><a href="#cb53-231" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-232"><a href="#cb53-232" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df[["committees"]])</span>
<span id="cb53-233"><a href="#cb53-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-234"><a href="#cb53-234" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-235"><a href="#cb53-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-236"><a href="#cb53-236" aria-hidden="true" tabindex="-1"></a>## Votes</span>
<span id="cb53-237"><a href="#cb53-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-240"><a href="#cb53-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-241"><a href="#cb53-241" aria-hidden="true" tabindex="-1"></a>#| label: glimpse-votes</span>
<span id="cb53-242"><a href="#cb53-242" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-243"><a href="#cb53-243" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df[["votes"]])</span>
<span id="cb53-244"><a href="#cb53-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-245"><a href="#cb53-245" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-246"><a href="#cb53-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-247"><a href="#cb53-247" aria-hidden="true" tabindex="-1"></a>## Actions</span>
<span id="cb53-248"><a href="#cb53-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-251"><a href="#cb53-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-252"><a href="#cb53-252" aria-hidden="true" tabindex="-1"></a>#| label: glimpse-actio</span>
<span id="cb53-253"><a href="#cb53-253" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-254"><a href="#cb53-254" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df[["actions"]])</span>
<span id="cb53-255"><a href="#cb53-255" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-256"><a href="#cb53-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-257"><a href="#cb53-257" aria-hidden="true" tabindex="-1"></a>## Sponsors</span>
<span id="cb53-258"><a href="#cb53-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-261"><a href="#cb53-261" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-262"><a href="#cb53-262" aria-hidden="true" tabindex="-1"></a>#| label: glimpse-sponsors</span>
<span id="cb53-263"><a href="#cb53-263" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-264"><a href="#cb53-264" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df[["sponsors"]])</span>
<span id="cb53-265"><a href="#cb53-265" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-266"><a href="#cb53-266" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-267"><a href="#cb53-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-268"><a href="#cb53-268" aria-hidden="true" tabindex="-1"></a># Parsing</span>
<span id="cb53-269"><a href="#cb53-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-270"><a href="#cb53-270" aria-hidden="true" tabindex="-1"></a>With an understanding of your data's structure and your intended output, let's break down the process into extracting 1) singular elements i.e. only one value, and 2) nested elements. Your output should inform what you do with both, but for either case I convert XML to a list and use `{purrr]` to flatten and transform the list into a data frame.</span>
<span id="cb53-271"><a href="#cb53-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-272"><a href="#cb53-272" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb53-273"><a href="#cb53-273" aria-hidden="true" tabindex="-1"></a>## Write Functions</span>
<span id="cb53-274"><a href="#cb53-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-275"><a href="#cb53-275" aria-hidden="true" tabindex="-1"></a>For more complex cases, I would implore you to write functions. They make your code more reliable, easier to debug, and make you think critically about how you are handling data. A good resource to start learning about writing functions is [How to Write a Function in R](https://www.earthdatascience.org/courses/earth-analytics/automate-science-workflows/write-function-r-programming/).</span>
<span id="cb53-276"><a href="#cb53-276" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-277"><a href="#cb53-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-278"><a href="#cb53-278" aria-hidden="true" tabindex="-1"></a>## Singular elements</span>
<span id="cb53-279"><a href="#cb53-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-280"><a href="#cb53-280" aria-hidden="true" tabindex="-1"></a>You can think of singular elements as the contents of a single cell in a data frame. In the bookstore example, you could arrange each book as a row and each child node as a column.</span>
<span id="cb53-281"><a href="#cb53-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-284"><a href="#cb53-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-285"><a href="#cb53-285" aria-hidden="true" tabindex="-1"></a>bookstore_xml_text = '&lt;<span class="kw">bookstore</span>&gt;</span>
<span id="cb53-286"><a href="#cb53-286" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"children"</span>&gt;</span>
<span id="cb53-287"><a href="#cb53-287" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Harry Potter&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb53-288"><a href="#cb53-288" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;J K. Rowling&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb53-289"><a href="#cb53-289" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2005&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb53-290"><a href="#cb53-290" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;29.99&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb53-291"><a href="#cb53-291" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb53-292"><a href="#cb53-292" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"web"</span>&gt;</span>
<span id="cb53-293"><a href="#cb53-293" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Learning XML&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb53-294"><a href="#cb53-294" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;Erik T. Ray&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb53-295"><a href="#cb53-295" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2003&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb53-296"><a href="#cb53-296" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;39.95&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb53-297"><a href="#cb53-297" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb53-298"><a href="#cb53-298" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bookstore</span>&gt;'</span>
<span id="cb53-299"><a href="#cb53-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-300"><a href="#cb53-300" aria-hidden="true" tabindex="-1"></a>bookstore_xml_parsed = xmlParse(bookstore_xml_text)</span>
<span id="cb53-301"><a href="#cb53-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-302"><a href="#cb53-302" aria-hidden="true" tabindex="-1"></a>(bookstore_xml_df = xmlToDataFrame(bookstore_xml_parsed))</span>
<span id="cb53-303"><a href="#cb53-303" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-304"><a href="#cb53-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-305"><a href="#cb53-305" aria-hidden="true" tabindex="-1"></a>In cases where your data are entirely singular nodes, you can convert XML to a dataframe using two functions from `{XML}`[^8]: `xmlParse()` and `xmlToDataFrame()`. Because the congressional data has singular and nested element structures, the nested data in fields like `committees`, `actions`, and `sponsors` are combined into single columns. If your data is not all singular nodes like this, you'll need to do a little bit more work to get the data into a [tidy data](https://vita.had.co.nz/papers/tidy-data.html) frame.</span>
<span id="cb53-306"><a href="#cb53-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-307"><a href="#cb53-307" aria-hidden="true" tabindex="-1"></a>[^8]: When you're working with both the `{XML}` and `{xml2}` libraries, it is important to note that their functions often rely on different object types. In the case of `xmlToDataFrame()`, it does not take `{xml_document}` or `{xml_node}` objects. If you try to use them, you'll see an error like this:</span>
<span id="cb53-308"><a href="#cb53-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-309"><a href="#cb53-309" aria-hidden="true" tabindex="-1"></a>    ```{r}</span>
<span id="cb53-310"><a href="#cb53-310" aria-hidden="true" tabindex="-1"></a>    #| label: xml-df-error</span>
<span id="cb53-311"><a href="#cb53-311" aria-hidden="true" tabindex="-1"></a>    #| error: true</span>
<span id="cb53-312"><a href="#cb53-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-313"><a href="#cb53-313" aria-hidden="true" tabindex="-1"></a>    xmlToDataFrame(bill_xml)</span>
<span id="cb53-314"><a href="#cb53-314" aria-hidden="true" tabindex="-1"></a>    ```</span>
<span id="cb53-315"><a href="#cb53-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-318"><a href="#cb53-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-319"><a href="#cb53-319" aria-hidden="true" tabindex="-1"></a>#| label: xml-to-df</span>
<span id="cb53-320"><a href="#cb53-320" aria-hidden="true" tabindex="-1"></a>#| class-output: code-block-h</span>
<span id="cb53-321"><a href="#cb53-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-322"><a href="#cb53-322" aria-hidden="true" tabindex="-1"></a># First you need to use the xmlParse function</span>
<span id="cb53-323"><a href="#cb53-323" aria-hidden="true" tabindex="-1"></a>bill_xml_parse = xmlParse(bill_xml)</span>
<span id="cb53-324"><a href="#cb53-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-325"><a href="#cb53-325" aria-hidden="true" tabindex="-1"></a>xmlToDataFrame(getNodeSet(bill_xml_parse, "//bill")) %&gt;% </span>
<span id="cb53-326"><a href="#cb53-326" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-327"><a href="#cb53-327" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-328"><a href="#cb53-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-329"><a href="#cb53-329" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb53-330"><a href="#cb53-330" aria-hidden="true" tabindex="-1"></a>## Note</span>
<span id="cb53-331"><a href="#cb53-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-332"><a href="#cb53-332" aria-hidden="true" tabindex="-1"></a>In this example, we actually need to use `getNodeSet(., [path =] "//bill")` to select only nodes in `&lt;<span class="kw">bill</span>&gt;`. If we just passed `bill_xml_parse`, we would get a dataframe with two rows because the top-level nodes are bill and the metadata identifier node `&lt;<span class="kw">dublinCore</span>&gt;`.</span>
<span id="cb53-333"><a href="#cb53-333" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-334"><a href="#cb53-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-335"><a href="#cb53-335" aria-hidden="true" tabindex="-1"></a>To start building our congressional bill dataset, we need to isolate singular elements like `billNumber` and `billType` by selecting nodes which meet two criteria: 1) the node does not have any child nodes of its own, and 2) the node is not an empty string. I use to extract nodes based on an [XPath](https://www.w3schools.com/xml/xml_parser.asp) (XML Path Language) string. It returns an `{xml_nodeset}` which is then coerced to a list using `as_list()`.</span>
<span id="cb53-336"><a href="#cb53-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-337"><a href="#cb53-337" aria-hidden="true" tabindex="-1"></a>As the help file for `xml_find_all()` says, "XPath is like regular expressions for trees". The expression selects the nodes which match the given path or pattern[^9]. In the code below `//bill/*` selects the child nodes in a bill. The expressions `[` within the square brackets `]` are called predicates which I use to find nodes which have no children with the XPath `count` function and nodes which are not empty strings[^10].</span>
<span id="cb53-338"><a href="#cb53-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-339"><a href="#cb53-339" aria-hidden="true" tabindex="-1"></a>[^9]: [A very useful table of XPath syntax](https://www.w3schools.com/XML/xpath_syntax.asp){target="_blank"}</span>
<span id="cb53-340"><a href="#cb53-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-341"><a href="#cb53-341" aria-hidden="true" tabindex="-1"></a>[^10]: In the process of writing this, I discovered that using XPath made this \~5x faster than an equivalent function in R.</span>
<span id="cb53-342"><a href="#cb53-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-343"><a href="#cb53-343" aria-hidden="true" tabindex="-1"></a>    ```{r}</span>
<span id="cb53-344"><a href="#cb53-344" aria-hidden="true" tabindex="-1"></a>    #| label: singular-nodes</span>
<span id="cb53-345"><a href="#cb53-345" aria-hidden="true" tabindex="-1"></a>    #| code-fold: show</span>
<span id="cb53-346"><a href="#cb53-346" aria-hidden="true" tabindex="-1"></a>    # Function to select singular child nodes from XML node</span>
<span id="cb53-347"><a href="#cb53-347" aria-hidden="true" tabindex="-1"></a>    xml_singular_nodes = function(xml_node){</span>
<span id="cb53-348"><a href="#cb53-348" aria-hidden="true" tabindex="-1"></a>      # Return child nodes of current node</span>
<span id="cb53-349"><a href="#cb53-349" aria-hidden="true" tabindex="-1"></a>      child_nodes = xml_children(xml_node)</span>
<span id="cb53-350"><a href="#cb53-350" aria-hidden="true" tabindex="-1"></a>      # Select child nodes with 0 children</span>
<span id="cb53-351"><a href="#cb53-351" aria-hidden="true" tabindex="-1"></a>      zero_length_child_nodes = child_nodes[xml_length(child_nodes) == 0]</span>
<span id="cb53-352"><a href="#cb53-352" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-353"><a href="#cb53-353" aria-hidden="true" tabindex="-1"></a>      # Keep the nodes which are not empty strings</span>
<span id="cb53-354"><a href="#cb53-354" aria-hidden="true" tabindex="-1"></a>      keep(zero_length_child_nodes, ~(xml_text(.) != ""))</span>
<span id="cb53-355"><a href="#cb53-355" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-356"><a href="#cb53-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-357"><a href="#cb53-357" aria-hidden="true" tabindex="-1"></a>    ```</span>
<span id="cb53-358"><a href="#cb53-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-359"><a href="#cb53-359" aria-hidden="true" tabindex="-1"></a>    ```{r}</span>
<span id="cb53-360"><a href="#cb53-360" aria-hidden="true" tabindex="-1"></a>    #| label: bench-node-selection</span>
<span id="cb53-361"><a href="#cb53-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-362"><a href="#cb53-362" aria-hidden="true" tabindex="-1"></a>    # Using XPath:</span>
<span id="cb53-363"><a href="#cb53-363" aria-hidden="true" tabindex="-1"></a>    # singular_nodes1 = xml_find_all(bill_xml, </span>
<span id="cb53-364"><a href="#cb53-364" aria-hidden="true" tabindex="-1"></a>    #                                 "//bill/*[count(./*) = 0 and not(string-length(.) = 0)]")</span>
<span id="cb53-365"><a href="#cb53-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-366"><a href="#cb53-366" aria-hidden="true" tabindex="-1"></a>    # Using R function:</span>
<span id="cb53-367"><a href="#cb53-367" aria-hidden="true" tabindex="-1"></a>    # singular_nodes2 = xml_singular_nodes(bill_node)</span>
<span id="cb53-368"><a href="#cb53-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-369"><a href="#cb53-369" aria-hidden="true" tabindex="-1"></a>    # Check they are the same</span>
<span id="cb53-370"><a href="#cb53-370" aria-hidden="true" tabindex="-1"></a>    # all.equal(singular_nodes1, singular_nodes2)</span>
<span id="cb53-371"><a href="#cb53-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-372"><a href="#cb53-372" aria-hidden="true" tabindex="-1"></a>    # benchmark the two different ways of selecting nodes</span>
<span id="cb53-373"><a href="#cb53-373" aria-hidden="true" tabindex="-1"></a>    microbenchmark::microbenchmark(</span>
<span id="cb53-374"><a href="#cb53-374" aria-hidden="true" tabindex="-1"></a>      xml_singular_nodes = xml_singular_nodes(bill_node),</span>
<span id="cb53-375"><a href="#cb53-375" aria-hidden="true" tabindex="-1"></a>      xml_find_all = xml_find_all(bill_xml, "//bill/*[count(./*) = 0 and not(string-length(.) = 0)]")</span>
<span id="cb53-376"><a href="#cb53-376" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-377"><a href="#cb53-377" aria-hidden="true" tabindex="-1"></a>    ```</span>
<span id="cb53-378"><a href="#cb53-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-381"><a href="#cb53-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-382"><a href="#cb53-382" aria-hidden="true" tabindex="-1"></a>#| label: singular-nodes-list</span>
<span id="cb53-383"><a href="#cb53-383" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb53-384"><a href="#cb53-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-385"><a href="#cb53-385" aria-hidden="true" tabindex="-1"></a>singular_nodes = xml_find_all(</span>
<span id="cb53-386"><a href="#cb53-386" aria-hidden="true" tabindex="-1"></a>  bill_xml, </span>
<span id="cb53-387"><a href="#cb53-387" aria-hidden="true" tabindex="-1"></a>  "//bill/*[count(./*) = 0 and not(string-length(.) = 0)]"</span>
<span id="cb53-388"><a href="#cb53-388" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-389"><a href="#cb53-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-390"><a href="#cb53-390" aria-hidden="true" tabindex="-1"></a>(singular_list = as_list(singular_nodes)) %&gt;% </span>
<span id="cb53-391"><a href="#cb53-391" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-392"><a href="#cb53-392" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-393"><a href="#cb53-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-394"><a href="#cb53-394" aria-hidden="true" tabindex="-1"></a>Note that we didn't retain the element names so we need to assign them ourselves. When your data is in a named list, you can flatten each element in the list into a **d**ata **f**rame **c**olumn using purrr's `flatten_dfc()` .</span>
<span id="cb53-395"><a href="#cb53-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-398"><a href="#cb53-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-399"><a href="#cb53-399" aria-hidden="true" tabindex="-1"></a>#| label: singular-nodes-list-named</span>
<span id="cb53-400"><a href="#cb53-400" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb53-401"><a href="#cb53-401" aria-hidden="true" tabindex="-1"></a>singular_list_named = setNames(singular_list, </span>
<span id="cb53-402"><a href="#cb53-402" aria-hidden="true" tabindex="-1"></a>                                xml_name(singular_nodes))</span>
<span id="cb53-403"><a href="#cb53-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-404"><a href="#cb53-404" aria-hidden="true" tabindex="-1"></a>(bill_df = flatten_dfc(singular_list_named)) %&gt;% </span>
<span id="cb53-405"><a href="#cb53-405" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-406"><a href="#cb53-406" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-407"><a href="#cb53-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-410"><a href="#cb53-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-411"><a href="#cb53-411" aria-hidden="true" tabindex="-1"></a>#| label: singular-nodes-rt</span>
<span id="cb53-412"><a href="#cb53-412" aria-hidden="true" tabindex="-1"></a>#| column: page</span>
<span id="cb53-413"><a href="#cb53-413" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-414"><a href="#cb53-414" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb53-415"><a href="#cb53-415" aria-hidden="true" tabindex="-1"></a>reactable(bill_df,</span>
<span id="cb53-416"><a href="#cb53-416" aria-hidden="true" tabindex="-1"></a>          theme = moke_rt(),</span>
<span id="cb53-417"><a href="#cb53-417" aria-hidden="true" tabindex="-1"></a>            columns = list(</span>
<span id="cb53-418"><a href="#cb53-418" aria-hidden="true" tabindex="-1"></a>              "constitutionalAuthorityStatementText" = colDef(show=F),</span>
<span id="cb53-419"><a href="#cb53-419" aria-hidden="true" tabindex="-1"></a>              "createDate" = colDef(format = colFormat(date = T), width = 100),</span>
<span id="cb53-420"><a href="#cb53-420" aria-hidden="true" tabindex="-1"></a>              "updateDate" = colDef(format = colFormat(date = T), width = 100),</span>
<span id="cb53-421"><a href="#cb53-421" aria-hidden="true" tabindex="-1"></a>              "introducedDate" = colDef(format = colFormat(date = T), width = 120),</span>
<span id="cb53-422"><a href="#cb53-422" aria-hidden="true" tabindex="-1"></a>              "congress" = colDef(width = 90),</span>
<span id="cb53-423"><a href="#cb53-423" aria-hidden="true" tabindex="-1"></a>              "originChamber" = colDef(show=F),</span>
<span id="cb53-424"><a href="#cb53-424" aria-hidden="true" tabindex="-1"></a>              "version" = colDef(show=F, width = 80),</span>
<span id="cb53-425"><a href="#cb53-425" aria-hidden="true" tabindex="-1"></a>              "billNumber" = colDef(width = 105),</span>
<span id="cb53-426"><a href="#cb53-426" aria-hidden="true" tabindex="-1"></a>              "billType" = colDef(width = 85),</span>
<span id="cb53-427"><a href="#cb53-427" aria-hidden="true" tabindex="-1"></a>              "title" = colDef(minWidth = 180)</span>
<span id="cb53-428"><a href="#cb53-428" aria-hidden="true" tabindex="-1"></a>            ))</span>
<span id="cb53-429"><a href="#cb53-429" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-430"><a href="#cb53-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-431"><a href="#cb53-431" aria-hidden="true" tabindex="-1"></a>## Nested elements</span>
<span id="cb53-432"><a href="#cb53-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-433"><a href="#cb53-433" aria-hidden="true" tabindex="-1"></a>At this point I should be clear about one of my assumptions: that performance with list-columns scales reasonably in various dimensions. I have yet to hit a computational wall[^11], but I am sure at some point it would be much smarter to store this information in a relational database. In either case you may come across elements with multiple children, multiple children with their own sub-elements, and elements with nested XML data. I'll be As you dive deeper into your data you'll likely have to decide which information you're extracting and how.</span>
<span id="cb53-434"><a href="#cb53-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-435"><a href="#cb53-435" aria-hidden="true" tabindex="-1"></a>[^11]: Parsing \~12,000 congressional bills takes 20 minutes for my computer.</span>
<span id="cb53-436"><a href="#cb53-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-437"><a href="#cb53-437" aria-hidden="true" tabindex="-1"></a>To include actions and votes, we can take advantage of the `nest()`/`unnest()` functionality of `{tidyr}`. We use the same steps as before to convert the XML to a list and then nest them in a list column.</span>
<span id="cb53-438"><a href="#cb53-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-439"><a href="#cb53-439" aria-hidden="true" tabindex="-1"></a>### Multiple children</span>
<span id="cb53-440"><a href="#cb53-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-441"><a href="#cb53-441" aria-hidden="true" tabindex="-1"></a>This section's still under construction, if you're reading this and you're not someone I sent this to I am impressed you've managed to reach this corner of the internet.</span>
<span id="cb53-442"><a href="#cb53-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-443"><a href="#cb53-443" aria-hidden="true" tabindex="-1"></a>### Multiple children with sub-elements</span>
<span id="cb53-444"><a href="#cb53-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-445"><a href="#cb53-445" aria-hidden="true" tabindex="-1"></a>The actions node has an `&lt;<span class="kw">item</span>&gt;` child node for each congressional action taken for a bill, such as being introduced, sent to a committee, debated on the floor, etc.. Just as before, we use `as_list()` to convert the `{xml_nodeset}` to a list.</span>
<span id="cb53-446"><a href="#cb53-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-449"><a href="#cb53-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-450"><a href="#cb53-450" aria-hidden="true" tabindex="-1"></a>#| label: actions-list</span>
<span id="cb53-451"><a href="#cb53-451" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb53-452"><a href="#cb53-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-453"><a href="#cb53-453" aria-hidden="true" tabindex="-1"></a>actions_xml = xml_find_all(bill_node, "actions/item")</span>
<span id="cb53-454"><a href="#cb53-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-455"><a href="#cb53-455" aria-hidden="true" tabindex="-1"></a>actions_list = as_list(actions_xml)</span>
<span id="cb53-456"><a href="#cb53-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-457"><a href="#cb53-457" aria-hidden="true" tabindex="-1"></a># Look at first action</span>
<span id="cb53-458"><a href="#cb53-458" aria-hidden="true" tabindex="-1"></a>glimpse(actions_list[[1]])</span>
<span id="cb53-459"><a href="#cb53-459" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-460"><a href="#cb53-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-461"><a href="#cb53-461" aria-hidden="true" tabindex="-1"></a>In the individual action container, we have the date, a list of committees related to the action, some administrative information, the text and type of action. To deal with this, we can write a function (or set of functions) like the ones below to process an action.</span>
<span id="cb53-462"><a href="#cb53-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-465"><a href="#cb53-465" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-466"><a href="#cb53-466" aria-hidden="true" tabindex="-1"></a>#| label: actions-functions</span>
<span id="cb53-467"><a href="#cb53-467" aria-hidden="true" tabindex="-1"></a>#| code-fold: true</span>
<span id="cb53-468"><a href="#cb53-468" aria-hidden="true" tabindex="-1"></a>#| code-summary: "View Functions"</span>
<span id="cb53-469"><a href="#cb53-469" aria-hidden="true" tabindex="-1"></a># Helper function: flatten_dfc_rename</span>
<span id="cb53-470"><a href="#cb53-470" aria-hidden="true" tabindex="-1"></a># flatten a list to data frame and </span>
<span id="cb53-471"><a href="#cb53-471" aria-hidden="true" tabindex="-1"></a># rename the columns with a given prefix</span>
<span id="cb53-472"><a href="#cb53-472" aria-hidden="true" tabindex="-1"></a>flatten_dfc_rename = function(list_to_flatten, </span>
<span id="cb53-473"><a href="#cb53-473" aria-hidden="true" tabindex="-1"></a>                          name_prefix = "prefix"){</span>
<span id="cb53-474"><a href="#cb53-474" aria-hidden="true" tabindex="-1"></a>  rename_with(</span>
<span id="cb53-475"><a href="#cb53-475" aria-hidden="true" tabindex="-1"></a>    .data = flatten_dfc(list_to_flatten), </span>
<span id="cb53-476"><a href="#cb53-476" aria-hidden="true" tabindex="-1"></a>    .fn = ~str_c(name_prefix, "_", .),</span>
<span id="cb53-477"><a href="#cb53-477" aria-hidden="true" tabindex="-1"></a>    # Exclude columns which already start with the prefix</span>
<span id="cb53-478"><a href="#cb53-478" aria-hidden="true" tabindex="-1"></a>    .cols = -starts_with(name_prefix)</span>
<span id="cb53-479"><a href="#cb53-479" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-480"><a href="#cb53-480" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-481"><a href="#cb53-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-482"><a href="#cb53-482" aria-hidden="true" tabindex="-1"></a># Function: parse_action</span>
<span id="cb53-483"><a href="#cb53-483" aria-hidden="true" tabindex="-1"></a># Parse actions from list to data frame</span>
<span id="cb53-484"><a href="#cb53-484" aria-hidden="true" tabindex="-1"></a>parse_action = function(action){</span>
<span id="cb53-485"><a href="#cb53-485" aria-hidden="true" tabindex="-1"></a>  action %&gt;% </span>
<span id="cb53-486"><a href="#cb53-486" aria-hidden="true" tabindex="-1"></a>    # Flatten+rename sourceSystem elements</span>
<span id="cb53-487"><a href="#cb53-487" aria-hidden="true" tabindex="-1"></a>    map_at("sourceSystem", ~flatten_dfc_rename(.x, "source")) %&gt;% </span>
<span id="cb53-488"><a href="#cb53-488" aria-hidden="true" tabindex="-1"></a>    # Flatten+rename committees</span>
<span id="cb53-489"><a href="#cb53-489" aria-hidden="true" tabindex="-1"></a>    map_at("committees", function(committee){</span>
<span id="cb53-490"><a href="#cb53-490" aria-hidden="true" tabindex="-1"></a>      map_dfr(committee, ~flatten_dfc_rename(.x, "committee"))</span>
<span id="cb53-491"><a href="#cb53-491" aria-hidden="true" tabindex="-1"></a>    }) %&gt;% </span>
<span id="cb53-492"><a href="#cb53-492" aria-hidden="true" tabindex="-1"></a>    # Flatten object to data frame</span>
<span id="cb53-493"><a href="#cb53-493" aria-hidden="true" tabindex="-1"></a>    flatten_dfc_rename(., "action") %&gt;% </span>
<span id="cb53-494"><a href="#cb53-494" aria-hidden="true" tabindex="-1"></a>    # Lastly, clean the names</span>
<span id="cb53-495"><a href="#cb53-495" aria-hidden="true" tabindex="-1"></a>    janitor::clean_names()</span>
<span id="cb53-496"><a href="#cb53-496" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-497"><a href="#cb53-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-498"><a href="#cb53-498" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-499"><a href="#cb53-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-502"><a href="#cb53-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-503"><a href="#cb53-503" aria-hidden="true" tabindex="-1"></a>#| label: benchmark-parse-action</span>
<span id="cb53-504"><a href="#cb53-504" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb53-505"><a href="#cb53-505" aria-hidden="true" tabindex="-1"></a>#| include: false</span>
<span id="cb53-506"><a href="#cb53-506" aria-hidden="true" tabindex="-1"></a># Test modify_at vs map_at</span>
<span id="cb53-507"><a href="#cb53-507" aria-hidden="true" tabindex="-1"></a>parse_action2 = function(action){</span>
<span id="cb53-508"><a href="#cb53-508" aria-hidden="true" tabindex="-1"></a>  action %&gt;% </span>
<span id="cb53-509"><a href="#cb53-509" aria-hidden="true" tabindex="-1"></a>    # Flatten+rename  sourceSystem elements</span>
<span id="cb53-510"><a href="#cb53-510" aria-hidden="true" tabindex="-1"></a>    modify_at("sourceSystem", ~flatten_dfc_rename(.x, "source")) %&gt;% </span>
<span id="cb53-511"><a href="#cb53-511" aria-hidden="true" tabindex="-1"></a>    # Flatten+rename committees</span>
<span id="cb53-512"><a href="#cb53-512" aria-hidden="true" tabindex="-1"></a>    modify_at("committees", function(committee){</span>
<span id="cb53-513"><a href="#cb53-513" aria-hidden="true" tabindex="-1"></a>      map_dfr(committee, ~flatten_dfc_rename(.x, "committee"))</span>
<span id="cb53-514"><a href="#cb53-514" aria-hidden="true" tabindex="-1"></a>    }) %&gt;% </span>
<span id="cb53-515"><a href="#cb53-515" aria-hidden="true" tabindex="-1"></a>    # Flatten object to data frame</span>
<span id="cb53-516"><a href="#cb53-516" aria-hidden="true" tabindex="-1"></a>    flatten_dfc_rename(., "action") %&gt;% </span>
<span id="cb53-517"><a href="#cb53-517" aria-hidden="true" tabindex="-1"></a>    janitor::clean_names()</span>
<span id="cb53-518"><a href="#cb53-518" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-519"><a href="#cb53-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-520"><a href="#cb53-520" aria-hidden="true" tabindex="-1"></a># Parse the first action</span>
<span id="cb53-521"><a href="#cb53-521" aria-hidden="true" tabindex="-1"></a>parse_action2(actions_list[[1]])</span>
<span id="cb53-522"><a href="#cb53-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-523"><a href="#cb53-523" aria-hidden="true" tabindex="-1"></a># What about speed?</span>
<span id="cb53-524"><a href="#cb53-524" aria-hidden="true" tabindex="-1"></a>microbenchmark::microbenchmark(</span>
<span id="cb53-525"><a href="#cb53-525" aria-hidden="true" tabindex="-1"></a>  parse_action = parse_action(actions_list[[1]]),</span>
<span id="cb53-526"><a href="#cb53-526" aria-hidden="true" tabindex="-1"></a>  parse_action2 = parse_action2(actions_list[[1]]), times = 1000</span>
<span id="cb53-527"><a href="#cb53-527" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-528"><a href="#cb53-528" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-529"><a href="#cb53-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-530"><a href="#cb53-530" aria-hidden="true" tabindex="-1"></a>Using the `{purrr}` library's `map_dfr()`, we apply this function to each action and combine the results into **d**ata **f**rame **r**ows. Here's the output of this process:</span>
<span id="cb53-531"><a href="#cb53-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-534"><a href="#cb53-534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-535"><a href="#cb53-535" aria-hidden="true" tabindex="-1"></a># Parse the first action</span>
<span id="cb53-536"><a href="#cb53-536" aria-hidden="true" tabindex="-1"></a>(actions_df = map_dfr(actions_list, parse_action)) %&gt;% </span>
<span id="cb53-537"><a href="#cb53-537" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-538"><a href="#cb53-538" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-539"><a href="#cb53-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-540"><a href="#cb53-540" aria-hidden="true" tabindex="-1"></a>It is useful to be explicit about the data types when you plan to combine rows into a data frame or `unnest()` the data in the future. I do this using `type_convert()` to ensure the columns have a specific datatype. To add these actions data as a list column to `bill_df` we can simply use dollar assignment.</span>
<span id="cb53-541"><a href="#cb53-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-544"><a href="#cb53-544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-545"><a href="#cb53-545" aria-hidden="true" tabindex="-1"></a>#| label: actions-dfr</span>
<span id="cb53-546"><a href="#cb53-546" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb53-547"><a href="#cb53-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-548"><a href="#cb53-548" aria-hidden="true" tabindex="-1"></a>actions_df = type_convert(actions_df,</span>
<span id="cb53-549"><a href="#cb53-549" aria-hidden="true" tabindex="-1"></a>                          col_types = cols(</span>
<span id="cb53-550"><a href="#cb53-550" aria-hidden="true" tabindex="-1"></a>                            action_date = col_date(), </span>
<span id="cb53-551"><a href="#cb53-551" aria-hidden="true" tabindex="-1"></a>                            action_time = col_time(),</span>
<span id="cb53-552"><a href="#cb53-552" aria-hidden="true" tabindex="-1"></a>                            action_committee_systemCode = col_character(), </span>
<span id="cb53-553"><a href="#cb53-553" aria-hidden="true" tabindex="-1"></a>                            action_committee_name = col_character(), </span>
<span id="cb53-554"><a href="#cb53-554" aria-hidden="true" tabindex="-1"></a>                            action_source_code = col_character(),</span>
<span id="cb53-555"><a href="#cb53-555" aria-hidden="true" tabindex="-1"></a>                            action_source_name = col_character(),</span>
<span id="cb53-556"><a href="#cb53-556" aria-hidden="true" tabindex="-1"></a>                            action_text = col_character(), </span>
<span id="cb53-557"><a href="#cb53-557" aria-hidden="true" tabindex="-1"></a>                            action_type = col_character(), </span>
<span id="cb53-558"><a href="#cb53-558" aria-hidden="true" tabindex="-1"></a>                            action_code = col_character()</span>
<span id="cb53-559"><a href="#cb53-559" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb53-560"><a href="#cb53-560" aria-hidden="true" tabindex="-1"></a>                          )</span>
<span id="cb53-561"><a href="#cb53-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-562"><a href="#cb53-562" aria-hidden="true" tabindex="-1"></a>bill_df$actions = list(actions_df)</span>
<span id="cb53-563"><a href="#cb53-563" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-564"><a href="#cb53-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-567"><a href="#cb53-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-568"><a href="#cb53-568" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb53-569"><a href="#cb53-569" aria-hidden="true" tabindex="-1"></a>#| include: false</span>
<span id="cb53-570"><a href="#cb53-570" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-571"><a href="#cb53-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-572"><a href="#cb53-572" aria-hidden="true" tabindex="-1"></a>bill_actions = xml_find_all(actions_node, "item")</span>
<span id="cb53-573"><a href="#cb53-573" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-574"><a href="#cb53-574" aria-hidden="true" tabindex="-1"></a>bill_action_counts = as_list(xml_find_all(actions_node, "./*[not(self::item)]")) %&gt;%</span>
<span id="cb53-575"><a href="#cb53-575" aria-hidden="true" tabindex="-1"></a>  map_dfc(flatten_dfc) %&gt;% </span>
<span id="cb53-576"><a href="#cb53-576" aria-hidden="true" tabindex="-1"></a>  rename_with(.cols = everything(), ~str_c("actions_", .)) %&gt;% </span>
<span id="cb53-577"><a href="#cb53-577" aria-hidden="true" tabindex="-1"></a>  pivot_longer(everything(), names_to = "action", names_prefix = "actions_", values_to = "count")</span>
<span id="cb53-578"><a href="#cb53-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-579"><a href="#cb53-579" aria-hidden="true" tabindex="-1"></a># Coerce nodes to list</span>
<span id="cb53-580"><a href="#cb53-580" aria-hidden="true" tabindex="-1"></a>actions_df = as_list(bill_actions) %&gt;% </span>
<span id="cb53-581"><a href="#cb53-581" aria-hidden="true" tabindex="-1"></a>  map_dfr(parse_action) %&gt;% </span>
<span id="cb53-582"><a href="#cb53-582" aria-hidden="true" tabindex="-1"></a>  type_convert(col_types = col_specs$actions)</span>
<span id="cb53-583"><a href="#cb53-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-584"><a href="#cb53-584" aria-hidden="true" tabindex="-1"></a>bill_df$actions = list(actions_df)</span>
<span id="cb53-585"><a href="#cb53-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-586"><a href="#cb53-586" aria-hidden="true" tabindex="-1"></a>bill_df$action_counts = list(type_convert(bill_action_counts,</span>
<span id="cb53-587"><a href="#cb53-587" aria-hidden="true" tabindex="-1"></a>                                          col_types = cols(action = col_character(), count = col_integer())))</span>
<span id="cb53-588"><a href="#cb53-588" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-589"><a href="#cb53-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-590"><a href="#cb53-590" aria-hidden="true" tabindex="-1"></a>### Nested XML</span>
<span id="cb53-591"><a href="#cb53-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-592"><a href="#cb53-592" aria-hidden="true" tabindex="-1"></a>Sometimes you can even have links to other XML files in a node, as we can see in the `&lt;<span class="kw">recordedVotes</span>&gt;` element. Votes are particularly interesting because it provides a more discrete measure of our representatives' behaviour.</span>
<span id="cb53-593"><a href="#cb53-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-596"><a href="#cb53-596" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-597"><a href="#cb53-597" aria-hidden="true" tabindex="-1"></a>#| label: vote-nodes-contents</span>
<span id="cb53-598"><a href="#cb53-598" aria-hidden="true" tabindex="-1"></a>(bill_recorded_vote_nodes = xml_find_all(bill_node, "recordedVotes/recordedVote"))</span>
<span id="cb53-599"><a href="#cb53-599" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-600"><a href="#cb53-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-601"><a href="#cb53-601" aria-hidden="true" tabindex="-1"></a>You may have spotted why votes are interesting elements to parse because inside the `&lt;<span class="kw">url</span>&gt;` element we find **another** **XML file**![^12] Before we dive into that can of worms, I'll convert the top-level nodes to a list and flatten it into columns. Note we use `map_dfr()` with `votes_list` because there could be multiple vote objects.</span>
<span id="cb53-602"><a href="#cb53-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-603"><a href="#cb53-603" aria-hidden="true" tabindex="-1"></a>[^12]: ![They heard you like XML so they put XML in your XML](https://c.tenor.com/um2EhyMQyR8AAAAC/xzibit-meme.gif){width="267"}</span>
<span id="cb53-604"><a href="#cb53-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-607"><a href="#cb53-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-608"><a href="#cb53-608" aria-hidden="true" tabindex="-1"></a>#| label: vote-nodes-df</span>
<span id="cb53-609"><a href="#cb53-609" aria-hidden="true" tabindex="-1"></a># Coerce nodes to list</span>
<span id="cb53-610"><a href="#cb53-610" aria-hidden="true" tabindex="-1"></a>recorded_votes_list = as_list(bill_recorded_vote_nodes)</span>
<span id="cb53-611"><a href="#cb53-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-612"><a href="#cb53-612" aria-hidden="true" tabindex="-1"></a>(recorded_votes_df = map_dfr(recorded_votes_list, flatten_dfc)) %&gt;% </span>
<span id="cb53-613"><a href="#cb53-613" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-614"><a href="#cb53-614" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-615"><a href="#cb53-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-616"><a href="#cb53-616" aria-hidden="true" tabindex="-1"></a>Now we want to get the vote roll XML file, so we go back to `read_xml()` . There are two main nodes - `&lt;<span class="kw">vote-metadata</span>&gt;` and `&lt;<span class="kw">vote-data</span>&gt;`. One node contains the aggregated vote information, while `&lt;<span class="kw">vote-data</span>&gt;` contains the legislator-level vote data. Let's try to parse the legislator-level data first. Here is the XML for a single legislator's vote:</span>
<span id="cb53-617"><a href="#cb53-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-620"><a href="#cb53-620" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-621"><a href="#cb53-621" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-xml</span>
<span id="cb53-622"><a href="#cb53-622" aria-hidden="true" tabindex="-1"></a>vote_roll_xml = read_xml(recorded_votes_df$url)</span>
<span id="cb53-623"><a href="#cb53-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-624"><a href="#cb53-624" aria-hidden="true" tabindex="-1"></a>vote_data = xml_find_all(vote_roll_xml, "vote-data")</span>
<span id="cb53-625"><a href="#cb53-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-626"><a href="#cb53-626" aria-hidden="true" tabindex="-1"></a>vote_legislators = vote_data %&gt;% </span>
<span id="cb53-627"><a href="#cb53-627" aria-hidden="true" tabindex="-1"></a>  xml_find_all("recorded-vote")</span>
<span id="cb53-628"><a href="#cb53-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-629"><a href="#cb53-629" aria-hidden="true" tabindex="-1"></a>(legislators_list = as_list(vote_legislators))[1] %&gt;% </span>
<span id="cb53-630"><a href="#cb53-630" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-631"><a href="#cb53-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-632"><a href="#cb53-632" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-633"><a href="#cb53-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-634"><a href="#cb53-634" aria-hidden="true" tabindex="-1"></a>With a similar combination of `as_list()` , `flatten_dfr()`, and `unnest()` we can flatten the XML into one row per legislator but we lose all the attributes.</span>
<span id="cb53-635"><a href="#cb53-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-638"><a href="#cb53-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-639"><a href="#cb53-639" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-data-flat</span>
<span id="cb53-640"><a href="#cb53-640" aria-hidden="true" tabindex="-1"></a>(vote_roll_flattened = vote_data %&gt;% </span>
<span id="cb53-641"><a href="#cb53-641" aria-hidden="true" tabindex="-1"></a>  as_list() %&gt;% </span>
<span id="cb53-642"><a href="#cb53-642" aria-hidden="true" tabindex="-1"></a>  flatten_dfr() %&gt;% </span>
<span id="cb53-643"><a href="#cb53-643" aria-hidden="true" tabindex="-1"></a>    unnest(everything()))</span>
<span id="cb53-644"><a href="#cb53-644" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-645"><a href="#cb53-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-646"><a href="#cb53-646" aria-hidden="true" tabindex="-1"></a>Instead we'll need to extract the attributes before we flatten the data. We want to extract the attributes only for legislator using `map()` to apply `map_at()` on each legislator element and extract the attributes from each while retaining the value in `vote`. It can often feel like you're getting lost in a list of lists, but with some experimentation you'll be able to find your way back to the surface.</span>
<span id="cb53-647"><a href="#cb53-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-650"><a href="#cb53-650" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-651"><a href="#cb53-651" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-leg-df</span>
<span id="cb53-652"><a href="#cb53-652" aria-hidden="true" tabindex="-1"></a>(legislator_vote_df = legislators_list %&gt;% </span>
<span id="cb53-653"><a href="#cb53-653" aria-hidden="true" tabindex="-1"></a>    # Modify one level deeper using map_at to target legislator elements</span>
<span id="cb53-654"><a href="#cb53-654" aria-hidden="true" tabindex="-1"></a>    map(map_at, "legislator", attributes) %&gt;% </span>
<span id="cb53-655"><a href="#cb53-655" aria-hidden="true" tabindex="-1"></a>    map_dfr(flatten_dfc))</span>
<span id="cb53-656"><a href="#cb53-656" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-657"><a href="#cb53-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-658"><a href="#cb53-658" aria-hidden="true" tabindex="-1"></a>Now we have a table of legislator voting data! But what about the `&lt;<span class="kw">vote-metadata</span>&gt;`? Everything other than the `&lt;<span class="kw">vote-totals</span>&gt;` element is singular so we can get that out of the way the same way as before:</span>
<span id="cb53-659"><a href="#cb53-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-662"><a href="#cb53-662" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-663"><a href="#cb53-663" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-metadata-xml</span>
<span id="cb53-664"><a href="#cb53-664" aria-hidden="true" tabindex="-1"></a>vote_metadata = xml_find_all(vote_roll_xml, "vote-metadata")</span>
<span id="cb53-665"><a href="#cb53-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-666"><a href="#cb53-666" aria-hidden="true" tabindex="-1"></a>vote_singular_nodes = xml_singular_nodes(vote_metadata)</span>
<span id="cb53-667"><a href="#cb53-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-668"><a href="#cb53-668" aria-hidden="true" tabindex="-1"></a>(vote_df = as_list(vote_singular_nodes) %&gt;% </span>
<span id="cb53-669"><a href="#cb53-669" aria-hidden="true" tabindex="-1"></a>  # as_list() doesn't retain element names so we set names ourselves</span>
<span id="cb53-670"><a href="#cb53-670" aria-hidden="true" tabindex="-1"></a>  setNames(xml_name(vote_singular_nodes)) %&gt;% </span>
<span id="cb53-671"><a href="#cb53-671" aria-hidden="true" tabindex="-1"></a>  flatten_dfc()) %&gt;% </span>
<span id="cb53-672"><a href="#cb53-672" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-673"><a href="#cb53-673" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-674"><a href="#cb53-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-675"><a href="#cb53-675" aria-hidden="true" tabindex="-1"></a>The `&lt;<span class="kw">vote-totals</span>&gt;` are a bit of a unique little element, with 3 different types of nodes. This is another opportunity for us to be choosy with our data. The first node is table headers, which we don't need because the elements are tagged anyway. From these, we really only need the `&lt;<span class="kw">totals-by-party</span>&gt;` nodes as long as the totals of which agree with `&lt;<span class="kw">totals-by-vote</span>&gt;` , which is worth checking.</span>
<span id="cb53-676"><a href="#cb53-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-679"><a href="#cb53-679" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-680"><a href="#cb53-680" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-metadata-totals-contents</span>
<span id="cb53-681"><a href="#cb53-681" aria-hidden="true" tabindex="-1"></a>#| layout-nrow: 1</span>
<span id="cb53-682"><a href="#cb53-682" aria-hidden="true" tabindex="-1"></a>(vote_totals = xml_find_all(vote_metadata, "vote-totals")) %&gt;% </span>
<span id="cb53-683"><a href="#cb53-683" aria-hidden="true" tabindex="-1"></a>  xml_contents()</span>
<span id="cb53-684"><a href="#cb53-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-685"><a href="#cb53-685" aria-hidden="true" tabindex="-1"></a>vote_totals_by_party = xml_find_all(vote_totals, "totals-by-party")</span>
<span id="cb53-686"><a href="#cb53-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-687"><a href="#cb53-687" aria-hidden="true" tabindex="-1"></a>party_vote_totals_df = as_list(vote_totals_by_party) %&gt;% </span>
<span id="cb53-688"><a href="#cb53-688" aria-hidden="true" tabindex="-1"></a>  map_dfr(flatten_dfc) %&gt;% </span>
<span id="cb53-689"><a href="#cb53-689" aria-hidden="true" tabindex="-1"></a>    type_convert()</span>
<span id="cb53-690"><a href="#cb53-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-691"><a href="#cb53-691" aria-hidden="true" tabindex="-1"></a>(totals_by_vote = xml_find_all(vote_totals, "totals-by-vote")) %&gt;% </span>
<span id="cb53-692"><a href="#cb53-692" aria-hidden="true" tabindex="-1"></a>  xml_contents()</span>
<span id="cb53-693"><a href="#cb53-693" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-694"><a href="#cb53-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-695"><a href="#cb53-695" aria-hidden="true" tabindex="-1"></a>Once we have our nodeset (which at last are all singular), we use same listing, mapping, and flattening...or *lappening* as absolutely no one calls it.</span>
<span id="cb53-696"><a href="#cb53-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-699"><a href="#cb53-699" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-700"><a href="#cb53-700" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb53-701"><a href="#cb53-701" aria-hidden="true" tabindex="-1"></a>#| include: false</span>
<span id="cb53-702"><a href="#cb53-702" aria-hidden="true" tabindex="-1"></a># Check if totals match</span>
<span id="cb53-703"><a href="#cb53-703" aria-hidden="true" tabindex="-1"></a>as_list(totals_by_vote) %&gt;% </span>
<span id="cb53-704"><a href="#cb53-704" aria-hidden="true" tabindex="-1"></a>  map_dfr(flatten_dfc)</span>
<span id="cb53-705"><a href="#cb53-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-706"><a href="#cb53-706" aria-hidden="true" tabindex="-1"></a>summarise(party_vote_totals, </span>
<span id="cb53-707"><a href="#cb53-707" aria-hidden="true" tabindex="-1"></a>          across(.cols = -party, sum, na.rm=T))</span>
<span id="cb53-708"><a href="#cb53-708" aria-hidden="true" tabindex="-1"></a># They do!</span>
<span id="cb53-709"><a href="#cb53-709" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-710"><a href="#cb53-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-711"><a href="#cb53-711" aria-hidden="true" tabindex="-1"></a>Now that we have all of our vote data wrangled from the thorny grasp of XML, we can put it all together.</span>
<span id="cb53-712"><a href="#cb53-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-715"><a href="#cb53-715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-716"><a href="#cb53-716" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-build</span>
<span id="cb53-717"><a href="#cb53-717" aria-hidden="true" tabindex="-1"></a>vote_roll_df = vote_df %&gt;% </span>
<span id="cb53-718"><a href="#cb53-718" aria-hidden="true" tabindex="-1"></a>  mutate(legislator_votes = list(legislator_vote_df),</span>
<span id="cb53-719"><a href="#cb53-719" aria-hidden="true" tabindex="-1"></a>         party_votes = list(party_vote_totals_df)) %&gt;% </span>
<span id="cb53-720"><a href="#cb53-720" aria-hidden="true" tabindex="-1"></a>    janitor::clean_names()</span>
<span id="cb53-721"><a href="#cb53-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-722"><a href="#cb53-722" aria-hidden="true" tabindex="-1"></a>(recorded_votes_df = recorded_votes_df %&gt;% </span>
<span id="cb53-723"><a href="#cb53-723" aria-hidden="true" tabindex="-1"></a>  mutate(vote_roll = list(vote_roll_df))) %&gt;% </span>
<span id="cb53-724"><a href="#cb53-724" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-725"><a href="#cb53-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-726"><a href="#cb53-726" aria-hidden="true" tabindex="-1"></a>bill_df$votes = list(recorded_votes_df)</span>
<span id="cb53-727"><a href="#cb53-727" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-728"><a href="#cb53-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-729"><a href="#cb53-729" aria-hidden="true" tabindex="-1"></a>...all the way until we've gotten back to the bill-level. Now we have the bill-level characteristics with action and vote information nested in list columns. If we want to analyze the actions data, we simply have to `unnest()` it.</span>
<span id="cb53-730"><a href="#cb53-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-733"><a href="#cb53-733" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-734"><a href="#cb53-734" aria-hidden="true" tabindex="-1"></a>#| label: unnest-actions</span>
<span id="cb53-735"><a href="#cb53-735" aria-hidden="true" tabindex="-1"></a>unnest(bill_df, actions) %&gt;% </span>
<span id="cb53-736"><a href="#cb53-736" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb53-737"><a href="#cb53-737" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-738"><a href="#cb53-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-739"><a href="#cb53-739" aria-hidden="true" tabindex="-1"></a>I'll stop there for brevity's sake, but you can find the code for extracting the full XML file [here](https://github.com/MokeEire/my-reps/blob/master/R/parsing_functions.R)[^13].</span>
<span id="cb53-740"><a href="#cb53-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-741"><a href="#cb53-741" aria-hidden="true" tabindex="-1"></a>[^13]: Ctrl/Cmd+F: `extract_bill_status`</span>
<span id="cb53-742"><a href="#cb53-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-743"><a href="#cb53-743" aria-hidden="true" tabindex="-1"></a># TL;DR: Main Points</span>
<span id="cb53-744"><a href="#cb53-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-745"><a href="#cb53-745" aria-hidden="true" tabindex="-1"></a>Processing XML documents can be simple depending on their structure, so try the simplest method if you can. If your data is making use of XML's flexibility you might but it can be boiled down to these steps:</span>
<span id="cb53-746"><a href="#cb53-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-747"><a href="#cb53-747" aria-hidden="true" tabindex="-1"></a>1.  **Explore the structure**</span>
<span id="cb53-748"><a href="#cb53-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-749"><a href="#cb53-749" aria-hidden="true" tabindex="-1"></a>&gt; Go through any available documentation, and when you read in the XML file you can use functions like `xmlParse()`, `xml_structure()`, and `xml_contents()` .</span>
<span id="cb53-750"><a href="#cb53-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-751"><a href="#cb53-751" aria-hidden="true" tabindex="-1"></a>2.  **Define the output**</span>
<span id="cb53-752"><a href="#cb53-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-753"><a href="#cb53-753" aria-hidden="true" tabindex="-1"></a>&gt; Consider what you want the output to look like and think about how it needs to be transformed to match this target.</span>
<span id="cb53-754"><a href="#cb53-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-755"><a href="#cb53-755" aria-hidden="true" tabindex="-1"></a>3.  **Process a single element** (write a function if it gets too complicated)</span>
<span id="cb53-756"><a href="#cb53-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-757"><a href="#cb53-757" aria-hidden="true" tabindex="-1"></a>&gt; Get one element into the form you want. Writing functions can help you think through the data transformations being applied and make your code easier to read.</span>
<span id="cb53-758"><a href="#cb53-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-759"><a href="#cb53-759" aria-hidden="true" tabindex="-1"></a>4.  **Apply to all elements**</span>
<span id="cb53-760"><a href="#cb53-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-761"><a href="#cb53-761" aria-hidden="true" tabindex="-1"></a>&gt; Focus on processing of the entire file (or the subset of the file you're interested in). You might want an XML file to return a single row, a single column, or a data frame of size $n\times k$. Once you have a single file returned in the format you want, you can combine the outputs of multiple files.</span>
<span id="cb53-762"><a href="#cb53-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-763"><a href="#cb53-763" aria-hidden="true" tabindex="-1"></a>Please reach out with any questions or feedback! All is welcome, and there may even be a reward for anyone who finds a mistake in the code.</span>
<span id="cb53-764"><a href="#cb53-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-767"><a href="#cb53-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-768"><a href="#cb53-768" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb53-769"><a href="#cb53-769" aria-hidden="true" tabindex="-1"></a>#| include: false</span>
<span id="cb53-770"><a href="#cb53-770" aria-hidden="true" tabindex="-1"></a>parse_vote_roll = function(vote, logger, bill_type, bill_num){</span>
<span id="cb53-771"><a href="#cb53-771" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-772"><a href="#cb53-772" aria-hidden="true" tabindex="-1"></a>  tryCatch(</span>
<span id="cb53-773"><a href="#cb53-773" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb53-774"><a href="#cb53-774" aria-hidden="true" tabindex="-1"></a>      vote_xml = read_xml(vote, options = "RECOVER")</span>
<span id="cb53-775"><a href="#cb53-775" aria-hidden="true" tabindex="-1"></a>      vote_data = xml_find_all(vote_xml, "vote-data")</span>
<span id="cb53-776"><a href="#cb53-776" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-777"><a href="#cb53-777" aria-hidden="true" tabindex="-1"></a>      vote_roll_children = xml_children(vote_roll_xml)</span>
<span id="cb53-778"><a href="#cb53-778" aria-hidden="true" tabindex="-1"></a>      vote_data = xml_find_all(vote_roll_xml, "vote-data")</span>
<span id="cb53-779"><a href="#cb53-779" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-780"><a href="#cb53-780" aria-hidden="true" tabindex="-1"></a>      # Vote data</span>
<span id="cb53-781"><a href="#cb53-781" aria-hidden="true" tabindex="-1"></a>      vote_legislators = vote_data %&gt;% </span>
<span id="cb53-782"><a href="#cb53-782" aria-hidden="true" tabindex="-1"></a>        xml_find_all("recorded-vote")</span>
<span id="cb53-783"><a href="#cb53-783" aria-hidden="true" tabindex="-1"></a>      legislators_list = as_list(vote_legislators)</span>
<span id="cb53-784"><a href="#cb53-784" aria-hidden="true" tabindex="-1"></a>      legislator_vote_df = legislators_list %&gt;% </span>
<span id="cb53-785"><a href="#cb53-785" aria-hidden="true" tabindex="-1"></a>        # Modify one level deeper using map_at to target legislator elements</span>
<span id="cb53-786"><a href="#cb53-786" aria-hidden="true" tabindex="-1"></a>        map(map_at, "legislator", attributes) %&gt;% </span>
<span id="cb53-787"><a href="#cb53-787" aria-hidden="true" tabindex="-1"></a>        map_dfr(flatten_dfc)</span>
<span id="cb53-788"><a href="#cb53-788" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-789"><a href="#cb53-789" aria-hidden="true" tabindex="-1"></a>      # Vote metadata</span>
<span id="cb53-790"><a href="#cb53-790" aria-hidden="true" tabindex="-1"></a>      vote_metadata = xml_find_all(vote_roll_xml, "vote-metadata")</span>
<span id="cb53-791"><a href="#cb53-791" aria-hidden="true" tabindex="-1"></a>      vote_singular_nodes = xml_singular_nodes(vote_metadata)</span>
<span id="cb53-792"><a href="#cb53-792" aria-hidden="true" tabindex="-1"></a>      (vote_df = as_list(vote_singular_nodes) %&gt;% </span>
<span id="cb53-793"><a href="#cb53-793" aria-hidden="true" tabindex="-1"></a>          # as_list() doesn't retain element names so we set names ourselves</span>
<span id="cb53-794"><a href="#cb53-794" aria-hidden="true" tabindex="-1"></a>          setNames(xml_name(vote_singular_nodes)) %&gt;% </span>
<span id="cb53-795"><a href="#cb53-795" aria-hidden="true" tabindex="-1"></a>          flatten_dfc())</span>
<span id="cb53-796"><a href="#cb53-796" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-797"><a href="#cb53-797" aria-hidden="true" tabindex="-1"></a>      # Vote totals</span>
<span id="cb53-798"><a href="#cb53-798" aria-hidden="true" tabindex="-1"></a>      vote_totals = xml_find_all(vote_metadata, "vote-totals")</span>
<span id="cb53-799"><a href="#cb53-799" aria-hidden="true" tabindex="-1"></a>      vote_totals_by_party = xml_find_all(vote_totals, "totals-by-party")</span>
<span id="cb53-800"><a href="#cb53-800" aria-hidden="true" tabindex="-1"></a>      party_vote_totals_df = vote_totals_by_party %&gt;% </span>
<span id="cb53-801"><a href="#cb53-801" aria-hidden="true" tabindex="-1"></a>        as_list() %&gt;% </span>
<span id="cb53-802"><a href="#cb53-802" aria-hidden="true" tabindex="-1"></a>        map_dfr(flatten_dfc) %&gt;% </span>
<span id="cb53-803"><a href="#cb53-803" aria-hidden="true" tabindex="-1"></a>        type_convert()</span>
<span id="cb53-804"><a href="#cb53-804" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-805"><a href="#cb53-805" aria-hidden="true" tabindex="-1"></a>      vote_roll_df = vote_df %&gt;% </span>
<span id="cb53-806"><a href="#cb53-806" aria-hidden="true" tabindex="-1"></a>        mutate(legislator_votes = list(legislator_vote_df),</span>
<span id="cb53-807"><a href="#cb53-807" aria-hidden="true" tabindex="-1"></a>               party_votes = list(party_vote_totals_df)) %&gt;% </span>
<span id="cb53-808"><a href="#cb53-808" aria-hidden="true" tabindex="-1"></a>        janitor::clean_names()</span>
<span id="cb53-809"><a href="#cb53-809" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-810"><a href="#cb53-810" aria-hidden="true" tabindex="-1"></a>      vote_list = as_list(vote_data)</span>
<span id="cb53-811"><a href="#cb53-811" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb53-812"><a href="#cb53-812" aria-hidden="true" tabindex="-1"></a>      flatten_dfr(vote_list) %&gt;% </span>
<span id="cb53-813"><a href="#cb53-813" aria-hidden="true" tabindex="-1"></a>        unnest(everything())</span>
<span id="cb53-814"><a href="#cb53-814" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb53-815"><a href="#cb53-815" aria-hidden="true" tabindex="-1"></a>    error=function(cond) {</span>
<span id="cb53-816"><a href="#cb53-816" aria-hidden="true" tabindex="-1"></a>      log_info(logger, </span>
<span id="cb53-817"><a href="#cb53-817" aria-hidden="true" tabindex="-1"></a>               bill_type = bill_type,</span>
<span id="cb53-818"><a href="#cb53-818" aria-hidden="true" tabindex="-1"></a>               bill_num = bill_num, </span>
<span id="cb53-819"><a href="#cb53-819" aria-hidden="true" tabindex="-1"></a>               "ERROR: Vote roll could not be parsed")</span>
<span id="cb53-820"><a href="#cb53-820" aria-hidden="true" tabindex="-1"></a>      # Choose a return value in case of error</span>
<span id="cb53-821"><a href="#cb53-821" aria-hidden="true" tabindex="-1"></a>      return(tibble())</span>
<span id="cb53-822"><a href="#cb53-822" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-823"><a href="#cb53-823" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-824"><a href="#cb53-824" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-825"><a href="#cb53-825" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-826"><a href="#cb53-826" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-827"><a href="#cb53-827" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb53-828"><a href="#cb53-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-829"><a href="#cb53-829" aria-hidden="true" tabindex="-1"></a># Other helpful articles</span>
<span id="cb53-830"><a href="#cb53-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-831"><a href="#cb53-831" aria-hidden="true" tabindex="-1"></a>Here are some of the helpful articles I came across in the course of writing this:</span>
<span id="cb53-832"><a href="#cb53-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-833"><a href="#cb53-833" aria-hidden="true" tabindex="-1"></a>-   [From XML to Excel for Data Analysis](https://towardsdatascience.com/from-xml-to-excel-for-data-analysis-ac0c0c765b7d "Introduction to Processing XML In Python")</span>
<span id="cb53-834"><a href="#cb53-834" aria-hidden="true" tabindex="-1"></a>-   [Reading XML files in R](https://medium.com/geekculture/reading-xml-files-in-r-3122c3a2a8d9)</span>
<span id="cb53-835"><a href="#cb53-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-836"><a href="#cb53-836" aria-hidden="true" tabindex="-1"></a># Session Info</span>
<span id="cb53-837"><a href="#cb53-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-838"><a href="#cb53-838" aria-hidden="true" tabindex="-1"></a>Version information about R, OS, and loaded packages.</span>
<span id="cb53-839"><a href="#cb53-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-842"><a href="#cb53-842" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-843"><a href="#cb53-843" aria-hidden="true" tabindex="-1"></a>#| label: session-info</span>
<span id="cb53-844"><a href="#cb53-844" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb53-845"><a href="#cb53-845" aria-hidden="true" tabindex="-1"></a>sessioninfo::session_info("loaded")</span>
<span id="cb53-846"><a href="#cb53-846" aria-hidden="true" tabindex="-1"></a>```</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>