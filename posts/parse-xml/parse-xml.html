<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.615">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="dcterms.date" content="2022-07-14">
<title>Mark Barrett - Parsing XML with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://hypothes.is/embed.js"></script><script src="../../site_libs/core-js-2.5.3/shim.min.js"></script><script src="../../site_libs/react-17.0.0/react.min.js"></script><script src="../../site_libs/react-17.0.0/react-dom.min.js"></script><script src="../../site_libs/reactwidget-1.0.0/react-tools.js"></script><script src="../../site_libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="../../site_libs/reactable-binding-0.3.0/reactable.js"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Mark Barrett</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">Blog</a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/Mmm_JuicyFruit"><i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/MokeEire"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 </a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#what-is-xml" id="toc-what-is-xml" class="nav-link active" data-scroll-target="#what-is-xml">What is XML?</a></li>
  <li><a href="#read-xml-data-with-r" id="toc-read-xml-data-with-r" class="nav-link" data-scroll-target="#read-xml-data-with-r">Read XML data with R</a></li>
  <li><a href="#define-the-output" id="toc-define-the-output" class="nav-link" data-scroll-target="#define-the-output">Define the output</a></li>
  <li>
<a href="#parsing" id="toc-parsing" class="nav-link" data-scroll-target="#parsing">Parsing</a>
  <ul class="collapse">
<li><a href="#singular-elements" id="toc-singular-elements" class="nav-link" data-scroll-target="#singular-elements">Singular elements</a></li>
  <li>
<a href="#nested-elements" id="toc-nested-elements" class="nav-link" data-scroll-target="#nested-elements">Nested elements</a>
  <ul class="collapse">
<li><a href="#multiple-children" id="toc-multiple-children" class="nav-link" data-scroll-target="#multiple-children">Multiple children</a></li>
  <li><a href="#multiple-children-with-sub-elements" id="toc-multiple-children-with-sub-elements" class="nav-link" data-scroll-target="#multiple-children-with-sub-elements">Multiple children with sub-elements</a></li>
  <li><a href="#nested-xml" id="toc-nested-xml" class="nav-link" data-scroll-target="#nested-xml">Nested XML</a></li>
  </ul>
</li>
  </ul>
</li>
  <li><a href="#tldr-main-points" id="toc-tldr-main-points" class="nav-link" data-scroll-target="#tldr-main-points">TL;DR: Main Points</a></li>
  <li><a href="#other-helpful-articles" id="toc-other-helpful-articles" class="nav-link" data-scroll-target="#other-helpful-articles">Other helpful articles</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Parsing XML with R</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Untangling congressional legislative data</p>
  <div class="quarto-categories">
    <div class="quarto-category">data</div>
    <div class="quarto-category">governance</div>
    <div class="quarto-category">R</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 14, 2022</p>
    </div>
  </div>
    
  </div>
  

</header><div class="cell">

</div>
<div class="callout-tip callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What you’ll learn:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Load and parse XML files in R using the <a href="http://www.omegahat.net/RSXML/">XML</a> and <a href="https://xml2.r-lib.org/">xml2</a> packages</p></li>
<li><p>Explore the structure of XML documents</p></li>
<li><p>List, map, and flatten your data into a tabular format using <a href="http://purrr.tidyverse.org">purrr</a> and using list columns with <a href="https://tidyr.tidyverse.org">tidyr</a></p></li>
</ul>
</div>
</div>
<section id="what-is-xml" class="level1"><h1>What is XML?</h1>
<p>If someone asked me what my least favourite data format to work with is, I would of course say PDF, but XML would not be far behind it. Unlike Excel spreadsheets, text files, and other tabular formats, (e)Xtensible Markup Language (XML) is designed to store any “arbitrary” structure<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> of data. This flexibility makes XML useful for all kinds of information from financial transactions and recipes to webpage content and document formatting<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Although working with XML may not be as simple as with tabular data, the contents can be much richer.</p>
<p>At its core, XML is just “information wrapped in tags”. Here is an example from <a href="https://www.w3schools.com/XML/xml_usedfor.asp">w3schools</a> of information a bookstore might have in XML format:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bookstore</span>&gt;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"children"</span>&gt;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Harry Potter&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;J K. Rowling&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2005&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;29.99&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"web"</span>&gt;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Learning XML&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;Erik T. Ray&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2003&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;39.95&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bookstore</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>&lt;bookstore&gt;</code> parent, or <em>root</em> element contains child elements called <code>&lt;book&gt;</code> which themselves have child elements – <code>&lt;title&gt;</code>, <code>&lt;author&gt;</code>, <code>&lt;year&gt;</code>, and <code>&lt;price&gt;</code>. XML can be thought of as a tree, where each tree branch can have multiple leaves, or none.</p>
<p>Note the book elements also have <code>category</code> attributes. Attributes are a useful way to store data related to a specific element for HTML, but using child elements is typically preferred in XML. This post will touch on data stored using both methods. To learn more about what XML is and how to use it, I recommend going through <a href="https://www.w3schools.com/XML/default.asp">w3school’s XML tutorial</a>.</p>
</section><section id="read-xml-data-with-r" class="level1"><h1>Read XML data with R</h1>
<p>To illustrate potential complexities of XML structures, I’ll be using congressional bill data provided by the <a href="https://www.gpo.gov/">United States Government Publishing Office (GPO)</a>. To follow along, you can download the sample XML file <a href="https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml" title="HR-391: Global Health Security Act of 2021">here</a>. I chose <a href="https://www.govinfo.gov/app/details/BILLS-117hr391rfs"><em>HR-391: Global Health Security Act of 2021</em></a>because it contains good examples of some of the challenges of parsing XML data<em>.</em> As always, the first step of data analysis is to look at the documentation. Luckily, GovInfo provides a <a href="https://github.com/usgpo/bill-status/blob/main/BILLSTATUS-XML_User_User-Guide.md">user guide</a> for the Bill Status data.</p>
<p>In terms of R packages, four will be important for this article. <a href="http://www.omegahat.net/RSXML/">XML</a> and <a href="https://xml2.r-lib.org/">xml2</a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> provide functions for reading in XML data while <a href="http://purrr.tidyverse.org">purrr</a> and <a href="https://tidyr.tidyverse.org">tidyr</a> helps us parse and flatten the data into tabular form. To start, read in the file with <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml()</a></code> , which returns an <code>xml_document</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> object.</p>
<div class="cell">
<details open=""><summary>Load and view XML file</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.omegahat.net/RSXML/">XML</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">bill_xml</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="st">"https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the xml_document's contents</span></span>
<span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents</a></span><span class="op">(</span><span class="va">bill_xml</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (2)}
[1] &lt;bill&gt;\n  &lt;billNumber&gt;391&lt;/billNumber&gt;\n  &lt;createDate&gt;2021-01-22T08:12:10 ...
[2] &lt;dublinCore xmlns:dc="http://purl.org/dc/elements/1.1/"&gt;\n  &lt;dc:format&gt;te ...</code></pre>
</div>
</div>
<p>We can see the document has two top-level nodes - one <code>&lt;bill&gt;</code> node and one called <code>&lt;dublinCore&gt;</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> In this case we can look just at the <code>&lt;bill&gt;</code> node using <code><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child()</a></code>.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Return child nodes named bill</span></span>
<span><span class="op">(</span><span class="va">bill_node</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span><span class="va">bill_xml</span>, <span class="st">"bill"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_node}
&lt;bill&gt;
 [1] &lt;billNumber&gt;391&lt;/billNumber&gt;
 [2] &lt;createDate&gt;2021-01-22T08:12:10Z&lt;/createDate&gt;
 [3] &lt;updateDate&gt;2022-02-09T12:37:52Z&lt;/updateDate&gt;
 [4] &lt;originChamber&gt;House&lt;/originChamber&gt;
 [5] &lt;billType&gt;HR&lt;/billType&gt;
 [6] &lt;introducedDate&gt;2021-01-21&lt;/introducedDate&gt;
 [7] &lt;congress&gt;117&lt;/congress&gt;
 [8] &lt;constitutionalAuthorityStatementText&gt;&lt;![CDATA[&lt;pre&gt;[Congressional Recor ...
 [9] &lt;recordedVotes&gt;\n  &lt;recordedVote&gt;\n    &lt;rollNumber&gt;188&lt;/rollNumber&gt;\n    ...
[10] &lt;committees&gt;\n  &lt;billCommittees&gt;\n    &lt;item&gt;\n      &lt;systemCode&gt;ssfr00&lt;/ ...
[11] &lt;committeeReports/&gt;
[12] &lt;relatedBills/&gt;
[13] &lt;actions&gt;\n  &lt;item&gt;\n    &lt;actionDate&gt;2021-07-12&lt;/actionDate&gt;\n    &lt;commi ...
[14] &lt;sponsors&gt;\n  &lt;item&gt;\n    &lt;bioguideId&gt;C001078&lt;/bioguideId&gt;\n    &lt;fullNam ...
[15] &lt;cosponsors&gt;\n  &lt;item&gt;\n    &lt;bioguideId&gt;C000266&lt;/bioguideId&gt;\n    &lt;fullN ...
[16] &lt;cboCostEstimates&gt;\n  &lt;item&gt;\n    &lt;pubDate&gt;2021-05-11T15:11:11Z&lt;/pubDate ...
[17] &lt;laws/&gt;
[18] &lt;notes/&gt;
[19] &lt;policyArea&gt;\n  &lt;name&gt;International Affairs&lt;/name&gt;\n&lt;/policyArea&gt;
[20] &lt;subjects&gt;\n  &lt;billSubjects&gt;\n    &lt;legislativeSubjects&gt;\n      &lt;item&gt;\n  ...
...</code></pre>
</div>
</div>
<p>So if we want to have a dataframe with one row per bill, we have a few different kinds of elements to deal with. Firstly there are the elements which have <strong>only one value</strong> (i.e.&nbsp;<em>singular</em>) like <code>billNumber</code>, <code>createDate</code>, and <code>billType</code>. There are also elements which have information <em>nested</em> in them like <code>recordedVotes</code>, <code>committees</code>, and <code>actions</code>.</p>
<p>In cases where your data are entirely singular nodes, you may be able to use <code><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame()</a></code> and be done. You’ll need to use <code><a href="https://rdrr.io/pkg/XML/man/xmlTreeParse.html">xmlParse()</a></code> which creates an XMLInternalDocument/XMLAbstractDocument object. In this example, we need to use <code>getNodeSet(., [path =] "//bill")</code> to select only nodes under <code>&lt;bill&gt;</code><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> because we have the metadata node mentioned above.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># First you need to use the xmlParse function</span></span>
<span><span class="va">bill_xml_parse</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlTreeParse.html">xmlParse</a></span><span class="op">(</span><span class="va">bill_xml</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># You can wrap a variable assignment in ( ) to print it, </span></span>
<span><span class="co"># or in this case pass it to another function via the pipe %&gt;% </span></span>
<span><span class="op">(</span> <span class="va">bill_xml_df_attempt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/XML/man/getNodeSet.html">getNodeSet</a></span><span class="op">(</span><span class="va">bill_xml_parse</span>, <span class="st">"//bill"</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># View the dataframe structure</span></span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre class="code-block-h"><code>Rows: 1
Columns: 28
$ billNumber                           &lt;chr&gt; "391"
$ createDate                           &lt;chr&gt; "2021-01-22T08:12:10Z"
$ updateDate                           &lt;chr&gt; "2022-02-09T12:37:52Z"
$ originChamber                        &lt;chr&gt; "House"
$ billType                             &lt;chr&gt; "HR"
$ introducedDate                       &lt;chr&gt; "2021-01-21"
$ congress                             &lt;chr&gt; "117"
$ constitutionalAuthorityStatementText &lt;chr&gt; "&lt;pre&gt;[Congressional Record Volum…
$ recordedVotes                        &lt;chr&gt; "188https://clerk.house.gov/evs/2…
$ committees                           &lt;chr&gt; "ssfr00Foreign Relations Committe…
$ committeeReports                     &lt;chr&gt; ""
$ relatedBills                         &lt;chr&gt; ""
$ actions                              &lt;chr&gt; "2021-07-12ssfr00Foreign Relation…
$ sponsors                             &lt;chr&gt; "C001078Rep. Connolly, Gerald E. …
$ cosponsors                           &lt;chr&gt; "C000266Rep. Chabot, Steve [R-OH-…
$ cboCostEstimates                     &lt;chr&gt; "2021-05-11T15:11:11ZH.R. 391, Gl…
$ laws                                 &lt;chr&gt; ""
$ notes                                &lt;chr&gt; ""
$ policyArea                           &lt;chr&gt; "International Affairs"
$ subjects                             &lt;chr&gt; "Advisory bodiesAnimal and plant …
$ summaries                            &lt;chr&gt; "002021-01-21Introduced in House2…
$ title                                &lt;chr&gt; "Global Health Security Act of 20…
$ titles                               &lt;chr&gt; "Display TitleGlobal Health Secur…
$ amendments                           &lt;chr&gt; ""
$ textVersions                         &lt;chr&gt; "Referred in Senate2021-07-12T04:…
$ latestAction                         &lt;chr&gt; "2021-07-12Received in the Senate…
$ calendarNumbers                      &lt;chr&gt; ""
$ version                              &lt;chr&gt; "1.0.0"</code></pre>
</div>
</div>
<p>Because the congressional data has singular and nested element structures, a number of fields like <code>committees</code>, <code>actions</code>, and <code>sponsors</code> have had their values combined into a single column. With nested data, you may need to do a little bit more work to get the data into a <a href="https://vita.had.co.nz/papers/tidy-data.html">tidy data</a> frame, but this approach can work for simpler XML structures. The importance of understanding the structure of your data brings us to one of the cardinal rules of data analysis:</p>
<div class="callout-tip callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Look at your data
</div>
</div>
<div class="callout-body-container callout-body">
<p>In fact, you could even say <em>stare</em> at it. Understanding the structure and contents of your data is essential for designing a solution to consistently process the data.</p>
</div>
</div>
</section><section id="define-the-output" class="level1 page-columns page-full"><h1>Define the output</h1>
<p>As well as looking at your data, it’s also usually helpful to look to your intended output. This determines how to transform the data.</p>
<p><strong>Example:</strong> I want the congressional data to have one row per bill, with the nested characteristics stored in list columns. This will produce a comprehensive dataset which can easily be subset and transformed to various levels of observation as needed. The end result should look like this:</p>
<div class="cell page-columns page-full">
<div class="cell-output-display column-screen-inset-shaded">

<div id="htmlwidget-16d75ce7a8e7fbd10c56" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-16d75ce7a8e7fbd10c56">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"bill_number":["391"],"create_date":["2021-01-22T08:12:10Z"],"update_date":["2022-02-09T12:37:52Z"],"origin_chamber":["House"],"bill_type":["HR"],"introduced_date":["2021-01-21T00:00:00Z"],"congress":["117"],"constitutional_authority_statement_text":["<pre>[Congressional Record Volume 167, Number 17 (Thursday, January 28, 2021)][House]From the Congressional Record Online through the Government Publishing Office [<a href=\"https://www.gpo.gov\">www.gpo.gov<\/a>]By Ms. SANCHEZ:H.J. Res. 22.Congress has the power to enact this legislation pursuantto the following:Article 1 Section 8ADDITIONAL SPONSORSUnder clause 7 of rule XII, sponsors were added to public bills andresolutions, as follows:H.R. 28: Mr. Chabot, Mr. Armstrong, Mrs. Fischbach, Mr.Lucas, Mr. Mast, and Mr. Womack.H.R. 40: Mr. Kahele, Ms. Roybal-Allard, Mr. Aguilar, Ms.Waters, Mr. Vela, Mr. Sires, and Mr. Huffman.H.R. 51: Mr. Mrvan and Ms. Davids of Kansas.H.R. 55: Ms. Ross, Mr. Lynch, Mr. Larsen of Washington, Mr.Thompson of California, Ms. Manning, Ms. Jayapal, Ms. Adams,Mr. Schneider, Mr. Veasey, and Ms. Wild.H.R. 77: Mr. Grothman.H.R. 78: Mr. Smith of New Jersey, Mr. Hice of Georgia, Mr.Bucshon, Mr. Burgess, and Mr. Norman.H.R. 97: Mrs. Hayes, Mr. Welch, Mr. Torres of New York, Mr.Cicilline, and Mr. Danny K. Davis of Illinois.H.R. 147: Mr. Ryan and Mr. Brown.H.R. 197: Mr. Brendan F. Boyle of Pennsylvania and Mr.Hastings.H.R. 217: Mr. Hice of Georgia.H.R. 235: Mr. Meeks and Mr. Torres of New York.H.R. 243: Mr. Armstrong.H.R. 255: Mr. Auchincloss, Mr. DeSaulnier, Mr. Schrader,and Ms. Chu.H.R. 256: Mr. Schrader and Ms. Chu.H.R. 262: Mr. Cicilline and Mr. Torres of New York.H.R. 265: Mr. Veasey.H.R. 275: Mr. Jacobs of New York, Ms. Herrera Beutler, Mr.McCaul, Mr. Joyce of Ohio, Mrs. Bice of Oklahoma, Mr.LaMalfa, Mrs. Steel, Mr. Hill, Mr. Garbarino, Mr. Pfluger,Mr. Gimenez, and Mrs. Cammack.H.R. 279: Mr. Neguse, Mr. Crow, and Mr. DeSaulnier.H.R. 289: Mr. Perry.H.R. 295: Mr. Cloud.H.R. 302: Mr. Costa.H.R. 304: Mr. Raskin, Mr. Lynch, Mr. Carson, Ms. Norton,and Mr. Kilmer.H.R. 305: Ms. Ross, Mr. Kind, and Mr. Michael F. Doyle ofPennsylvania.H.R. 322: Mr. Wilson of South Carolina.H.R. 326: Mr. Costa.H.R. 332: Mr. Stanton and Mrs. Wagner.H.R. 349: Ms. Williams of Georgia, Ms. Brownley, Ms. BluntRochester, and Mrs. Trahan.H.R. 359: Mr. Rodney Davis of Illinois.H.R. 369: Mrs. Hayes and Ms. Schrier.H.R. 377: Mr. Rice of South Carolina and Ms. Herrell.H.R. 378: Mr. Rice of South Carolina and Ms. Herrell.H.R. 384: Mr. Cohen, Ms. Mace, Mr. Huffman, Mr. Hastings,and Ms. Eshoo.H.R. 391: Mr. DeSaulnier, Mrs. Napolitano, Ms. Chu, Mr.Harder of California, Mr. Cohen, and Mrs. Fletcher.H.R. 392: Mr. Smith of Washington, Ms. Moore of Wisconsin,Mr. Sablan, and Mr. Sires.H.R. 398: Ms. Herrell.H.R. 407: Mr. Mast.H.R. 421: Ms. Plaskett, Mr. Rush, and Mr. Correa.H.R. 426: Mr. Hagedorn, Mr. Mooney, Mr. Green of Tennessee,Mr. Norman, and Mr. Davidson.H.R. 447: Mr. DeSaulnier, Mr. Courtney, Ms. Adams, Mrs.McBath, Mr. Kinzinger, Mr. Castro of Texas, Mr. Stivers, Mr.Morelle, Mr. Smith of Washington, Mr. Khanna, Mr. Sarbanes,Ms. Norton, Ms. Stevens, Mr. Grijalva, Ms. Blunt Rochester,Mr. Cardenas, Ms. Schakowsky, Ms. Jackson Lee, Mr.Krishnamoorthi, Mr. Danny K. Davis of Illinois, Mrs. Demings,Mr. Foster, Ms. Houlahan, Mr. Moulton, Mr. Kilmer, Ms. Meng,Mr. Gallego, Mr. Brown, Mr. Suozzi, Mr. Garamendi, Mr.Neguse, Ms. McCollum, Mr. Kildee, Mrs. Beatty, Mr. Carbajal,Ms. Craig, Mr. Trone, Ms. Waters, Mr. Casten, Mrs. Bustos,Mr. Langevin, Mr. Sires, Mr. Kahele, Mr. Ryan, Ms. Underwood,Mr. Stanton, Mr. Carson, Mr. David Scott of Georgia, Ms. Leeof California, Mrs. Dingell, Mrs. Axne, Mr. Horsford, and Mr.Lamb.H.R. 448: Mr. Jones.H.R. 449: Mrs. Miller of Illinois.H.R. 450: Mrs. Miller of Illinois.H.R. 452: Mr. Nunes and Mr. Joyce of Ohio.H.R. 465: Mr. Costa and Mr. Valadao.H.R. 471: Mr. Buck, Ms. Mace, Mr. Perry, Mr. Wright, Mr.Babin, Mr. Norman, and Mr. Gibbs.H.R. 472: Mr. Feenstra.H.R. 485: Mrs. Hayes, Mr. Castro of Texas, Ms. Wild, Mr.Takano, Mr. Morelle, Mrs. Trahan, Mr. Levin of Michigan, andMs. Adams.H.R. 488: Mr. Newhouse, Mr. Stewart,[...][Page H254]<\/pre>"],"title":["Global Health Security Act of 2021"],"version":["1.0.0"],"latest_action_action_date":["2021-07-12T00:00:00Z"],"latest_action_text":["Received in the Senate and Read twice and referred to the Committee on Foreign Relations."]},"columns":[{"accessor":"bill_number","name":"bill_number","type":"character","width":100},{"accessor":"create_date","name":"create_date","type":"Date","format":{"cell":{"date":true},"aggregated":{"date":true}},"width":100},{"accessor":"update_date","name":"update_date","type":"Date","format":{"cell":{"date":true},"aggregated":{"date":true}},"width":100},{"accessor":"origin_chamber","name":"origin_chamber","type":"character","show":false},{"accessor":"bill_type","name":"bill_type","type":"character","width":80},{"accessor":"introduced_date","name":"introduced_date","type":"Date","format":{"cell":{"date":true},"aggregated":{"date":true}},"width":135},{"accessor":"congress","name":"congress","type":"character","width":80},{"accessor":"constitutional_authority_statement_text","name":"constitutional_authority_statement_text","type":"character","show":false},{"accessor":"title","name":"title","type":"character","minWidth":180},{"accessor":"version","name":"version","type":"character","show":false,"width":80},{"accessor":"latest_action_action_date","name":"action_date","type":"Date","format":{"cell":{"date":true},"aggregated":{"date":true}},"width":115},{"accessor":"latest_action_text","name":"action_text","type":"character","minWidth":180,"maxWidth":240}],"columnGroups":[{"name":"Latest Action","columns":["latest_action_action_date","latest_action_text"]}],"resizable":true,"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"compact":true,"nowrap":true,"theme":{"color":"#474d4d","backgroundColor":"#FFFFFF","borderColor":"#dddddd","borderWidth":"1px","stripedColor":"#dddddd","highlightColor":"#f0f0f0","cellPadding":"8px 12px","style":{"padding":"16px 8px"},"tableStyle":{"fontSize":14,"borderBottom":"3px solid #222222","fontFamily":"Noto Sans, sans-serif"},"headerStyle":{"borderWidth":"3px","paddingTop":"12px","verticalAlign":"bottom","textAlign":"bottom","background":"#FFFFFF","textTransform":"uppercase","borderColor":"#474d4d","color":"#051414","&:hover":{"background":"#dddddd"},"&[aria-sort='ascending'], &[aria-sort='descending']":{"background":"#5b5e5f","color":"#FFFFFF"},"borderColor.1":"#333","fontSize":12,"fontFamily":"Heebo Light, sans-serif"},"groupHeaderStyle":{"&:not(:empty)":{"paddingBottom":"3px","verticalAlign":"bottom","textAlign":"bottom","backgroundColor":"#FFFFFF","textTransform":"uppercase","fontSize":12,"color":"#474d4d"}},"rowSelectedStyle":{"backgroundColor":"#dddddd"},"inputStyle":{"backgroundColor":"#FFFFFF","color":"#474d4d"},"searchInputStyle":{"textTransform":"uppercase","color":"#474d4d","fontSize":"14px"},"paginationStyle":{"textTransform":"uppercase","fontSize":"14px"},"pageButtonStyle":{"textTransform":"uppercase","fontSize":"14px"}},"dataKey":"4b76f59ceb6630e1b6464cd70c3bfbb4"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>With the following list columns (among others):</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Committees</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Votes</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Actions</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">Sponsors</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [2 × 6] (S3: tbl_df/tbl/data.frame)
  ..$ committee_system_code  : chr [1:2] "ssfr00" "hsfa00"
  ..$ committee_name         : chr [1:2] "Foreign Relations Committee" "Foreign Affairs Committee"
  ..$ committee_chamber      : chr [1:2] "Senate" "House"
  ..$ committee_type         : chr [1:2] "Standing" "Standing"
  ..$ committee_activities   :List of 2
  ..$ subcommittee_activities:List of 2</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [1 × 9] (S3: tbl_df/tbl/data.frame)
  ..$ roll_number     : chr "188"
  ..$ url             : chr "https://clerk.house.gov/evs/2021/roll188.xml"
  ..$ full_action_name: chr "Final Passage Under Suspension of the Rules Results"
  ..$ chamber         : chr "House"
  ..$ congress        : chr "117"
  ..$ date            : chr "2021-06-28T23:46:02Z"
  ..$ session_number  : chr "1"
  ..$ vote_roll       :List of 1
  ..$ roll_found      : logi TRUE</code></pre>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [14 × 9] (S3: tbl_df/tbl/data.frame)
  ..$ action_date                 : Date[1:14], format: "2021-07-12" "2021-06-28" ...
  ..$ action_committee_system_code: chr [1:14] "ssfr00" NA NA NA ...
  ..$ action_committee_name       : chr [1:14] "Foreign Relations Committee" NA NA NA ...
  ..$ action_source_code          : chr [1:14] "0" "2" "2" "9" ...
  ..$ action_source_name          : chr [1:14] "Senate" "House floor actions" "House floor actions" "Library of Congress" ...
  ..$ action_text                 : chr [1:14] "Received in the Senate and Read twice and referred to the Committee on Foreign Relations." "Motion to reconsider laid on the table Agreed to without objection." "On motion to suspend the rules and pass the bill, as amended Agreed to by the Yeas and Nays: (2/3 required): 30"| __truncated__ "Passed/agreed to in House: On motion to suspend the rules and pass the bill, as amended Agreed to by the Yeas a"| __truncated__ ...
  ..$ action_type                 : Ord.factor w/ 6 levels "IntroReferral"&lt;..: 1 3 3 3 3 3 3 3 3 2 ...
  ..$ action_time                 : 'hms' num [1:14] NA 19:46:03 19:46:02 19:46:02 ...
  .. ..- attr(*, "units")= chr "secs"
  ..$ action_code                 : chr [1:14] NA "H38310" "H37300" "8000" ...</code></pre>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [1 × 11] (S3: tbl_df/tbl/data.frame)
  ..$ sponsor_bioguide_id            : chr "C001078"
  ..$ sponsor_full_name              : chr "Rep. Connolly, Gerald E. [D-VA-11]"
  ..$ sponsor_first_name             : chr "Gerald"
  ..$ sponsor_middle_name            : chr "E."
  ..$ sponsor_last_name              : chr "Connolly"
  ..$ sponsor_party                  : chr "D"
  ..$ sponsor_state                  : chr "VA"
  ..$ sponsor_identifiers_lis_id     : chr "1959"
  ..$ sponsor_identifiers_bioguide_id: chr "C001078"
  ..$ sponsor_identifiers_gpo_id     : chr "8202"
  ..$ sponsor_district               : chr "11"</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="parsing" class="level1 page-columns page-full"><h1>Parsing</h1>
<p>With this output in mind and an understanding of the data structure, we can break down the process into extracting singular elements, and nested elements. In both cases, we convert XML to a list and use <code>{purrr]</code> to flatten and transform the list into the desired output format.</p>
<section id="singular-elements" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="singular-elements">Singular elements</h2>
<p>In the bookstore example, each of the book’s children were singular, which means they are well suited to be flattened into a dataframe. In the congressional data, we’ll need to single out the singular elements like <code>billNumber</code> and <code>billType</code> before converting to a dataframe. To do this, I find nodes which meet two criteria: 1) the node does not have any child elements, and 2) the node is not an empty string.</p>
<p><code><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all()</a></code> extracts nodes based on an <a href="https://www.w3schools.com/xml/xml_parser.asp">XPath</a> (XML Path Language) string and returns an <code>{xml_nodeset}</code> which can be coerced to a list using <code><a href="http://xml2.r-lib.org/reference/as_list.html">as_list()</a></code>. As the function’s help file says, “XPath is like regular expressions for trees”. When writing an XPath expression, you are selecting the nodes which match the given pattern. In this case <code>//bill/*</code> selects all the child nodes in a bill node, while the text <code>[</code> within the square brackets <code>]</code> indexes these nodes to select those which have no children using the XPath function <code>count</code> and nodes which are not empty strings<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">singular_nodes</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span></span>
<span>  <span class="va">bill_xml</span>, </span>
<span>  <span class="st">"//bill/*[count(./*) = 0 and not(string-length(.) = 0)]"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">singular_list</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">singular_nodes</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ :List of 1
  ..$ : chr "391"
 $ :List of 1
  ..$ : chr "2021-01-22T08:12:10Z"
 $ :List of 1
  ..$ : chr "2022-02-09T12:37:52Z"
 $ :List of 1
  ..$ : chr "House"
 $ :List of 1
  ..$ : chr "HR"
 $ :List of 1
  ..$ : chr "2021-01-21"
 $ :List of 1
  ..$ : chr "117"
 $ :List of 1
  ..$ : chr "&lt;pre&gt;[Congressional Record Volume 167, Number 17 (Thursday, January 28, 2021)][House]From the Congressional Rec"| __truncated__
 $ :List of 1
  ..$ : chr "Global Health Security Act of 2021"
 $ :List of 1
  ..$ : chr "1.0.0"</code></pre>
</div>
</div>
<p>Note that we didn’t retain the element names so we need to assign them ourselves. When your data is in a named list, you can flatten each element in the list into a <strong>d</strong>ata<strong>f</strong>rame <strong>c</strong>olumn using purrr’s <code><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfc()</a></code> .</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">singular_list_named</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">singular_list</span>, </span>
<span>                                <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_name.html">xml_name</a></span><span class="op">(</span><span class="va">singular_nodes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">bill_df</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfc</a></span><span class="op">(</span><span class="va">singular_list_named</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 10
$ billNumber                           &lt;chr&gt; "391"
$ createDate                           &lt;chr&gt; "2021-01-22T08:12:10Z"
$ updateDate                           &lt;chr&gt; "2022-02-09T12:37:52Z"
$ originChamber                        &lt;chr&gt; "House"
$ billType                             &lt;chr&gt; "HR"
$ introducedDate                       &lt;chr&gt; "2021-01-21"
$ congress                             &lt;chr&gt; "117"
$ constitutionalAuthorityStatementText &lt;chr&gt; "&lt;pre&gt;[Congressional Record Volum…
$ title                                &lt;chr&gt; "Global Health Security Act of 20…
$ version                              &lt;chr&gt; "1.0.0"</code></pre>
</div>
</div>
<div class="cell page-columns page-full">
<div class="cell-output-display column-page">

<div id="htmlwidget-f1f849d807535a1a3d90" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-f1f849d807535a1a3d90">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"billNumber":["391"],"createDate":["2021-01-22T08:12:10Z"],"updateDate":["2022-02-09T12:37:52Z"],"originChamber":["House"],"billType":["HR"],"introducedDate":["2021-01-21"],"congress":["117"],"constitutionalAuthorityStatementText":["<pre>[Congressional Record Volume 167, Number 17 (Thursday, January 28, 2021)][House]From the Congressional Record Online through the Government Publishing Office [<a href=\"https://www.gpo.gov\">www.gpo.gov<\/a>]By Ms. SANCHEZ:H.J. Res. 22.Congress has the power to enact this legislation pursuantto the following:Article 1 Section 8ADDITIONAL SPONSORSUnder clause 7 of rule XII, sponsors were added to public bills andresolutions, as follows:H.R. 28: Mr. Chabot, Mr. Armstrong, Mrs. Fischbach, Mr.Lucas, Mr. Mast, and Mr. Womack.H.R. 40: Mr. Kahele, Ms. Roybal-Allard, Mr. Aguilar, Ms.Waters, Mr. Vela, Mr. Sires, and Mr. Huffman.H.R. 51: Mr. Mrvan and Ms. Davids of Kansas.H.R. 55: Ms. Ross, Mr. Lynch, Mr. Larsen of Washington, Mr.Thompson of California, Ms. Manning, Ms. Jayapal, Ms. Adams,Mr. Schneider, Mr. Veasey, and Ms. Wild.H.R. 77: Mr. Grothman.H.R. 78: Mr. Smith of New Jersey, Mr. Hice of Georgia, Mr.Bucshon, Mr. Burgess, and Mr. Norman.H.R. 97: Mrs. Hayes, Mr. Welch, Mr. Torres of New York, Mr.Cicilline, and Mr. Danny K. Davis of Illinois.H.R. 147: Mr. Ryan and Mr. Brown.H.R. 197: Mr. Brendan F. Boyle of Pennsylvania and Mr.Hastings.H.R. 217: Mr. Hice of Georgia.H.R. 235: Mr. Meeks and Mr. Torres of New York.H.R. 243: Mr. Armstrong.H.R. 255: Mr. Auchincloss, Mr. DeSaulnier, Mr. Schrader,and Ms. Chu.H.R. 256: Mr. Schrader and Ms. Chu.H.R. 262: Mr. Cicilline and Mr. Torres of New York.H.R. 265: Mr. Veasey.H.R. 275: Mr. Jacobs of New York, Ms. Herrera Beutler, Mr.McCaul, Mr. Joyce of Ohio, Mrs. Bice of Oklahoma, Mr.LaMalfa, Mrs. Steel, Mr. Hill, Mr. Garbarino, Mr. Pfluger,Mr. Gimenez, and Mrs. Cammack.H.R. 279: Mr. Neguse, Mr. Crow, and Mr. DeSaulnier.H.R. 289: Mr. Perry.H.R. 295: Mr. Cloud.H.R. 302: Mr. Costa.H.R. 304: Mr. Raskin, Mr. Lynch, Mr. Carson, Ms. Norton,and Mr. Kilmer.H.R. 305: Ms. Ross, Mr. Kind, and Mr. Michael F. Doyle ofPennsylvania.H.R. 322: Mr. Wilson of South Carolina.H.R. 326: Mr. Costa.H.R. 332: Mr. Stanton and Mrs. Wagner.H.R. 349: Ms. Williams of Georgia, Ms. Brownley, Ms. BluntRochester, and Mrs. Trahan.H.R. 359: Mr. Rodney Davis of Illinois.H.R. 369: Mrs. Hayes and Ms. Schrier.H.R. 377: Mr. Rice of South Carolina and Ms. Herrell.H.R. 378: Mr. Rice of South Carolina and Ms. Herrell.H.R. 384: Mr. Cohen, Ms. Mace, Mr. Huffman, Mr. Hastings,and Ms. Eshoo.H.R. 391: Mr. DeSaulnier, Mrs. Napolitano, Ms. Chu, Mr.Harder of California, Mr. Cohen, and Mrs. Fletcher.H.R. 392: Mr. Smith of Washington, Ms. Moore of Wisconsin,Mr. Sablan, and Mr. Sires.H.R. 398: Ms. Herrell.H.R. 407: Mr. Mast.H.R. 421: Ms. Plaskett, Mr. Rush, and Mr. Correa.H.R. 426: Mr. Hagedorn, Mr. Mooney, Mr. Green of Tennessee,Mr. Norman, and Mr. Davidson.H.R. 447: Mr. DeSaulnier, Mr. Courtney, Ms. Adams, Mrs.McBath, Mr. Kinzinger, Mr. Castro of Texas, Mr. Stivers, Mr.Morelle, Mr. Smith of Washington, Mr. Khanna, Mr. Sarbanes,Ms. Norton, Ms. Stevens, Mr. Grijalva, Ms. Blunt Rochester,Mr. Cardenas, Ms. Schakowsky, Ms. Jackson Lee, Mr.Krishnamoorthi, Mr. Danny K. Davis of Illinois, Mrs. Demings,Mr. Foster, Ms. Houlahan, Mr. Moulton, Mr. Kilmer, Ms. Meng,Mr. Gallego, Mr. Brown, Mr. Suozzi, Mr. Garamendi, Mr.Neguse, Ms. McCollum, Mr. Kildee, Mrs. Beatty, Mr. Carbajal,Ms. Craig, Mr. Trone, Ms. Waters, Mr. Casten, Mrs. Bustos,Mr. Langevin, Mr. Sires, Mr. Kahele, Mr. Ryan, Ms. Underwood,Mr. Stanton, Mr. Carson, Mr. David Scott of Georgia, Ms. Leeof California, Mrs. Dingell, Mrs. Axne, Mr. Horsford, and Mr.Lamb.H.R. 448: Mr. Jones.H.R. 449: Mrs. Miller of Illinois.H.R. 450: Mrs. Miller of Illinois.H.R. 452: Mr. Nunes and Mr. Joyce of Ohio.H.R. 465: Mr. Costa and Mr. Valadao.H.R. 471: Mr. Buck, Ms. Mace, Mr. Perry, Mr. Wright, Mr.Babin, Mr. Norman, and Mr. Gibbs.H.R. 472: Mr. Feenstra.H.R. 485: Mrs. Hayes, Mr. Castro of Texas, Ms. Wild, Mr.Takano, Mr. Morelle, Mrs. Trahan, Mr. Levin of Michigan, andMs. Adams.H.R. 488: Mr. Newhouse, Mr. Stewart,[...][Page H254]<\/pre>"],"title":["Global Health Security Act of 2021"],"version":["1.0.0"]},"columns":[{"accessor":"billNumber","name":"billNumber","type":"character","width":105},{"accessor":"createDate","name":"createDate","type":"character","format":{"cell":{"date":true},"aggregated":{"date":true}},"width":100},{"accessor":"updateDate","name":"updateDate","type":"character","format":{"cell":{"date":true},"aggregated":{"date":true}},"width":100},{"accessor":"originChamber","name":"originChamber","type":"character","show":false},{"accessor":"billType","name":"billType","type":"character","width":85},{"accessor":"introducedDate","name":"introducedDate","type":"character","format":{"cell":{"date":true},"aggregated":{"date":true}},"width":120},{"accessor":"congress","name":"congress","type":"character","width":90},{"accessor":"constitutionalAuthorityStatementText","name":"constitutionalAuthorityStatementText","type":"character","show":false},{"accessor":"title","name":"title","type":"character","minWidth":180},{"accessor":"version","name":"version","type":"character","show":false,"width":80}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"theme":{"color":"#474d4d","backgroundColor":"#FFFFFF","borderColor":"#dddddd","borderWidth":"1px","stripedColor":"#dddddd","highlightColor":"#f0f0f0","cellPadding":"8px 12px","style":{"padding":"16px 8px"},"tableStyle":{"fontSize":14,"borderBottom":"3px solid #222222","fontFamily":"Noto Sans, sans-serif"},"headerStyle":{"borderWidth":"3px","paddingTop":"12px","verticalAlign":"bottom","textAlign":"bottom","background":"#FFFFFF","textTransform":"uppercase","borderColor":"#474d4d","color":"#051414","&:hover":{"background":"#dddddd"},"&[aria-sort='ascending'], &[aria-sort='descending']":{"background":"#5b5e5f","color":"#FFFFFF"},"borderColor.1":"#333","fontSize":12,"fontFamily":"Heebo Light, sans-serif"},"groupHeaderStyle":{"&:not(:empty)":{"paddingBottom":"3px","verticalAlign":"bottom","textAlign":"bottom","backgroundColor":"#FFFFFF","textTransform":"uppercase","fontSize":12,"color":"#474d4d"}},"rowSelectedStyle":{"backgroundColor":"#dddddd"},"inputStyle":{"backgroundColor":"#FFFFFF","color":"#474d4d"},"searchInputStyle":{"textTransform":"uppercase","color":"#474d4d","fontSize":"14px"},"paginationStyle":{"textTransform":"uppercase","fontSize":"14px"},"pageButtonStyle":{"textTransform":"uppercase","fontSize":"14px"}},"dataKey":"2a124a35ba7bcd958c473a8f8914c0f7"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section><section id="nested-elements" class="level2"><h2 class="anchored" data-anchor-id="nested-elements">Nested elements</h2>
<p>It’s nice when things are simple, but often times they’re not. In congressional data, three such cases are: elements with multiple children, elements with multiple children with their own sub-elements, and elements with nested XML data.</p>
<p>we might want to know what happened to the bill over time – when it was introduced, voted on, and/or passed. Each of these could be represented as a column representing the date of the action like <code>introducedDate</code>, but this becomes unruly as the different action types and characteristics increase. Below is an example of an individual action element.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">actions_xml</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">bill_node</span>, <span class="st">"actions/item"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (14)}
 [1] &lt;item&gt;\n  &lt;actionDate&gt;2021-07-12&lt;/actionDate&gt;\n  &lt;committees&gt;\n    &lt;item ...
 [2] &lt;item&gt;\n  &lt;actionDate&gt;2021-06-28&lt;/actionDate&gt;\n  &lt;actionTime&gt;19:46:03&lt;/a ...
 [3] &lt;item&gt;\n  &lt;actionDate&gt;2021-06-28&lt;/actionDate&gt;\n  &lt;actionTime&gt;19:46:02&lt;/a ...
 [4] &lt;item&gt;\n  &lt;actionDate&gt;2021-06-28&lt;/actionDate&gt;\n  &lt;actionTime&gt;19:46:02&lt;/a ...
 [5] &lt;item&gt;\n  &lt;actionDate&gt;2021-06-28&lt;/actionDate&gt;\n  &lt;actionTime&gt;19:24:39&lt;/a ...
 [6] &lt;item&gt;\n  &lt;actionDate&gt;2021-06-28&lt;/actionDate&gt;\n  &lt;actionTime&gt;15:20:02&lt;/a ...
 [7] &lt;item&gt;\n  &lt;actionDate&gt;2021-06-28&lt;/actionDate&gt;\n  &lt;actionTime&gt;15:05:31&lt;/a ...
 [8] &lt;item&gt;\n  &lt;actionDate&gt;2021-06-28&lt;/actionDate&gt;\n  &lt;actionTime&gt;15:05:26&lt;/a ...
 [9] &lt;item&gt;\n  &lt;actionDate&gt;2021-06-28&lt;/actionDate&gt;\n  &lt;actionTime&gt;15:05:13&lt;/a ...
[10] &lt;item&gt;\n  &lt;actionDate&gt;2021-03-25&lt;/actionDate&gt;\n  &lt;committees&gt;\n    &lt;item ...
[11] &lt;item&gt;\n  &lt;actionDate&gt;2021-03-25&lt;/actionDate&gt;\n  &lt;committees&gt;\n    &lt;item ...
[12] &lt;item&gt;\n  &lt;actionDate&gt;2021-01-21&lt;/actionDate&gt;\n  &lt;links/&gt;\n  &lt;text&gt;Refer ...
[13] &lt;item&gt;\n  &lt;actionDate&gt;2021-01-21&lt;/actionDate&gt;\n  &lt;links/&gt;\n  &lt;text&gt;Intro ...
[14] &lt;item&gt;\n  &lt;actionDate&gt;2021-01-21&lt;/actionDate&gt;\n  &lt;links/&gt;\n  &lt;text&gt;Intro ...</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Look at first action</span></span>
<span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents</a></span><span class="op">(</span><span class="va">actions_xml</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (6)}
[1] &lt;actionDate&gt;2021-07-12&lt;/actionDate&gt;
[2] &lt;committees&gt;\n  &lt;item&gt;\n    &lt;systemCode&gt;ssfr00&lt;/systemCode&gt;\n    &lt;name&gt;Fo ...
[3] &lt;links/&gt;
[4] &lt;sourceSystem&gt;\n  &lt;code&gt;0&lt;/code&gt;\n  &lt;name&gt;Senate&lt;/name&gt;\n&lt;/sourceSystem&gt;
[5] &lt;text&gt;Received in the Senate and Read twice and referred to the Committee ...
[6] &lt;type&gt;IntroReferral&lt;/type&gt;</code></pre>
</div>
</div>
<p>To include actions and votes, we use the same steps as before and nest them in a list column such that each row will have a nested dataframe. This strategy takes advantage of the <code>nest()</code>/<code>unnest()</code> functionality of <a href="https://tidyr.tidyverse.org">tidyr</a>. For more complex cases like this, I would implore you to write functions<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. Functions can make your code more reliable, easier to debug, and they make you think critically about how you are handling data.</p>
<section id="multiple-children" class="level3"><h3 class="anchored" data-anchor-id="multiple-children">Multiple children</h3>
</section><section id="multiple-children-with-sub-elements" class="level3"><h3 class="anchored" data-anchor-id="multiple-children-with-sub-elements">Multiple children with sub-elements</h3>
<p>The actions node has an <code>&lt;item&gt;</code> child node for each congressional action taken for a bill, such as being introduced, sent to a committee, debated on the floor, etc.. Just as before, we use <code><a href="http://xml2.r-lib.org/reference/as_list.html">as_list()</a></code> to convert the <code>{xml_nodeset}</code> to a list.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">actions_list</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">actions_xml</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at first action</span></span>
<span><span class="fu">glimpse</span><span class="op">(</span><span class="va">actions_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 6
 $ actionDate  :List of 1
  ..$ : chr "2021-07-12"
 $ committees  :List of 1
  ..$ item:List of 2
  .. ..$ systemCode:List of 1
  .. ..$ name      :List of 1
 $ links       : list()
 $ sourceSystem:List of 2
  ..$ code:List of 1
  .. ..$ : chr "0"
  ..$ name:List of 1
  .. ..$ : chr "Senate"
 $ text        :List of 1
  ..$ : chr "Received in the Senate and Read twice and referred to the Committee on Foreign Relations."
 $ type        :List of 1
  ..$ : chr "IntroReferral"</code></pre>
</div>
</div>
<p>In the individual action container, we can see we have the type, text, and date of the action, a list of committees related to the action, and some elements which are singular and some which are not. To deal with this, we can write a function (or set of functions) like the ones below to process an action.</p>
<div class="cell">
<details><summary>Functions</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Helper function: flatten_dfc_rename</span></span>
<span><span class="co"># flatten a list to dataframe and </span></span>
<span><span class="co"># rename the columns with a given prefix</span></span>
<span><span class="va">flatten_dfc_rename</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">list_to_flatten</span>, </span>
<span>                          <span class="va">name_prefix</span> <span class="op">=</span> <span class="st">"prefix"</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">rename_with</span><span class="op">(</span></span>
<span>    .data <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfc</a></span><span class="op">(</span><span class="va">list_to_flatten</span><span class="op">)</span>, </span>
<span>    .fn <span class="op">=</span> <span class="op">~</span><span class="fu">str_c</span><span class="op">(</span><span class="va">name_prefix</span>, <span class="st">"_"</span>, <span class="va">.</span><span class="op">)</span>,</span>
<span>    <span class="co"># Exclude columns which already start with the prefix</span></span>
<span>    .cols <span class="op">=</span> <span class="op">-</span><span class="fu">starts_with</span><span class="op">(</span><span class="va">name_prefix</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Function: parse_action</span></span>
<span><span class="co"># Parse actions from list to dataframe</span></span>
<span><span class="va">parse_action</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">action</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">action</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Flatten+rename sourceSystem elements</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at</a></span><span class="op">(</span><span class="st">"sourceSystem"</span>, <span class="op">~</span><span class="fu">flatten_dfc_rename</span><span class="op">(</span><span class="va">.x</span>, <span class="st">"source"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Flatten+rename committees</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at</a></span><span class="op">(</span><span class="st">"committees"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">committee</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">committee</span>, <span class="op">~</span><span class="fu">flatten_dfc_rename</span><span class="op">(</span><span class="va">.x</span>, <span class="st">"committee"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Flatten object to dataframe</span></span>
<span>    <span class="fu">flatten_dfc_rename</span><span class="op">(</span><span class="va">.</span>, <span class="st">"action"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Lastly, clean the names</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Parse the first action</span></span>
<span><span class="fu">parse_action</span><span class="op">(</span><span class="va">actions_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 7
$ action_date                  &lt;chr&gt; "2021-07-12"
$ action_committee_system_code &lt;chr&gt; "ssfr00"
$ action_committee_name        &lt;chr&gt; "Foreign Relations Committee"
$ action_source_code           &lt;chr&gt; "0"
$ action_source_name           &lt;chr&gt; "Senate"
$ action_text                  &lt;chr&gt; "Received in the Senate and Read twice an…
$ action_type                  &lt;chr&gt; "IntroReferral"</code></pre>
</div>
</div>
<p>Using the <a href="http://purrr.tidyverse.org">purrr</a> library’s <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code>, we apply this function to each action and combine the results into <strong>d</strong>ata<strong>f</strong>rame <strong>r</strong>ows. It is useful to be explicit about the data types when you plan to combine rows into a dataframe or <code>unnest()</code> the data in the future. I do this using <code>type_convert()</code> to ensure the columns have a specific datatype. To add these actions data as a list column to <code>bill_df</code> we can simply use dollar assignment.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">actions_df</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">actions_list</span>, <span class="va">parse_action</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">actions_df</span> <span class="op">=</span> <span class="fu">type_convert</span><span class="op">(</span><span class="va">actions_df</span>,</span>
<span>                          col_types <span class="op">=</span> <span class="fu">cols</span><span class="op">(</span></span>
<span>                            action_date <span class="op">=</span> <span class="fu">col_date</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_time <span class="op">=</span> <span class="fu">col_time</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                            action_committee_systemCode <span class="op">=</span> <span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_committee_name <span class="op">=</span> <span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_source_code <span class="op">=</span> <span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                            action_source_name <span class="op">=</span> <span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                            action_text <span class="op">=</span> <span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_type <span class="op">=</span> <span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>, </span>
<span>                            action_code <span class="op">=</span> <span class="fu">col_character</span><span class="op">(</span><span class="op">)</span></span>
<span>                            <span class="op">)</span></span>
<span>                          <span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 9
   action_date action_committee_system_code action_committee_n… action_source_c…
   &lt;date&gt;      &lt;chr&gt;                        &lt;chr&gt;               &lt;chr&gt;           
 1 2021-07-12  ssfr00                       Foreign Relations … 0               
 2 2021-06-28  &lt;NA&gt;                         &lt;NA&gt;                2               
 3 2021-06-28  &lt;NA&gt;                         &lt;NA&gt;                2               
 4 2021-06-28  &lt;NA&gt;                         &lt;NA&gt;                9               
 5 2021-06-28  &lt;NA&gt;                         &lt;NA&gt;                2               
 6 2021-06-28  &lt;NA&gt;                         &lt;NA&gt;                2               
 7 2021-06-28  &lt;NA&gt;                         &lt;NA&gt;                2               
 8 2021-06-28  &lt;NA&gt;                         &lt;NA&gt;                2               
 9 2021-06-28  &lt;NA&gt;                         &lt;NA&gt;                2               
10 2021-03-25  hsfa00                       Foreign Affairs Co… 1               
11 2021-03-25  hsfa00                       Foreign Affairs Co… 1               
12 2021-01-21  hsfa00                       Foreign Affairs Co… 2               
13 2021-01-21  &lt;NA&gt;                         &lt;NA&gt;                9               
14 2021-01-21  &lt;NA&gt;                         &lt;NA&gt;                9               
# … with 5 more variables: action_source_name &lt;chr&gt;, action_text &lt;chr&gt;,
#   action_type &lt;chr&gt;, action_time &lt;time&gt;, action_code &lt;chr&gt;</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bill_df</span><span class="op">$</span><span class="va">actions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">actions_df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="nested-xml" class="level3"><h3 class="anchored" data-anchor-id="nested-xml">Nested XML</h3>
<p>Votes are particularly interesting because it provides a more discrete measure of our representatives’ behaviour. Individual votes are stored in the <code>&lt;recordedVotes&gt;</code> container. We can access child elements in XML using a forward slash (this uses a language called XPATH).</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">bill_recorded_vote_nodes</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">bill_node</span>, <span class="st">"recordedVotes/recordedVote"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (7)}
[1] &lt;rollNumber&gt;188&lt;/rollNumber&gt;
[2] &lt;url&gt;https://clerk.house.gov/evs/2021/roll188.xml&lt;/url&gt;
[3] &lt;fullActionName&gt;Final Passage Under Suspension of the Rules Results&lt;/full ...
[4] &lt;chamber&gt;House&lt;/chamber&gt;
[5] &lt;congress&gt;117&lt;/congress&gt;
[6] &lt;date&gt;2021-06-28T23:46:02Z&lt;/date&gt;
[7] &lt;sessionNumber&gt;1&lt;/sessionNumber&gt;</code></pre>
</div>
</div>
<p>You may have spotted why votes are interesting elements to parse because inside the <code>&lt;url&gt;</code> element we find <strong>another</strong> <strong>XML file</strong>!<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> Before we dive into that can of worms, I’ll convert the top-level nodes to a list and flatten it into columns. Note we use <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> with <code>votes_list</code> because there could be multiple vote objects.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Coerce nodes to list</span></span>
<span><span class="va">recorded_votes_list</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">bill_recorded_vote_nodes</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">recorded_votes_df</span> <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">recorded_votes_list</span>, <span class="va">flatten_dfc</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 7
$ rollNumber     &lt;chr&gt; "188"
$ url            &lt;chr&gt; "https://clerk.house.gov/evs/2021/roll188.xml"
$ fullActionName &lt;chr&gt; "Final Passage Under Suspension of the Rules Results"
$ chamber        &lt;chr&gt; "House"
$ congress       &lt;chr&gt; "117"
$ date           &lt;chr&gt; "2021-06-28T23:46:02Z"
$ sessionNumber  &lt;chr&gt; "1"</code></pre>
</div>
</div>
<p>Now we want to get the vote roll XML file, so we go back to <code><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml()</a></code> . There are two main nodes - <code>&lt;vote-metadata&gt;</code> and <code>&lt;vote-data&gt;</code>. One node contains the aggregated vote information, while <code>&lt;vote-data&gt;</code> contains the legislator-level vote data. Let’s try to parse the legislator-level data first. Here is the XML for a single legislator’s vote:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vote_roll_xml</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="va">recorded_votes_df</span><span class="op">$</span><span class="va">url</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vote_data</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_roll_xml</span>, <span class="st">"vote-data"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_child</a></span><span class="op">(</span><span class="va">vote_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>{xml_node}
&lt;recorded-vote&gt;
[1] &lt;legislator name-id="A000370" sort-field="Adams" unaccented-name="Adams"  ...
[2] &lt;vote&gt;Yea&lt;/vote&gt;</code></pre>
</div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># (vote_roll_children = xml_children(vote_roll_xml)) %&gt;% </span></span>
<span><span class="co">#   map(xml_contents)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With a similar combination of <code><a href="http://xml2.r-lib.org/reference/as_list.html">as_list()</a></code> , <code><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfr()</a></code>, and <code>unnest()</code> we can flatten the XML into one row per legislator but we lose all the attributes.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">vote_roll_flattened</span> <span class="op">=</span> <span class="va">vote_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfr</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">unnest</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 430 × 2
   legislator  vote 
   &lt;chr&gt;       &lt;chr&gt;
 1 Adams       Yea  
 2 Aderholt    Nay  
 3 Aguilar     Yea  
 4 Allen       Nay  
 5 Allred      Yea  
 6 Amodei      Yea  
 7 Armstrong   Yea  
 8 Arrington   Nay  
 9 Auchincloss Yea  
10 Axne        Yea  
# … with 420 more rows</code></pre>
</div>
</div>
<p>Instead we’ll need to extract the attributes before we flatten the data. Let’s take another look at the legislators structure.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vote_legislators</span> <span class="op">=</span> <span class="va">vote_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="st">"recorded-vote"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">legislators_list</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">vote_legislators</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ :List of 2
  ..$ legislator:List of 1
  .. ..$ : chr "Adams"
  .. ..- attr(*, "name-id")= chr "A000370"
  .. ..- attr(*, "sort-field")= chr "Adams"
  .. ..- attr(*, "unaccented-name")= chr "Adams"
  .. ..- attr(*, "party")= chr "D"
  .. ..- attr(*, "state")= chr "NC"
  .. ..- attr(*, "role")= chr "legislator"
  ..$ vote      :List of 1
  .. ..$ : chr "Yea"</code></pre>
</div>
</div>
<p>The legislator element has all the attributes, while the vote element only has a value. We want to extract the attributes only for legislator using <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> to apply <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at()</a></code> on each legislator element and extract the attributes from each while retaining the value in <code>vote</code>. It can often feel like you’re getting lost in a list of lists, but with some experimentation you’ll be able to find your way back to the surface.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">legislator_vote_df</span> <span class="op">=</span> <span class="va">legislators_list</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co"># Modify one level deeper using map_at to target legislator elements</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">map_at</span>, <span class="st">"legislator"</span>, <span class="va">attributes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">flatten_dfc</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 430 × 7
   `name-id` `sort-field` `unaccented-name` party state role       vote 
   &lt;chr&gt;     &lt;chr&gt;        &lt;chr&gt;             &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
 1 A000370   Adams        Adams             D     NC    legislator Yea  
 2 A000055   Aderholt     Aderholt          R     AL    legislator Nay  
 3 A000371   Aguilar      Aguilar           D     CA    legislator Yea  
 4 A000372   Allen        Allen             R     GA    legislator Nay  
 5 A000376   Allred       Allred            D     TX    legislator Yea  
 6 A000369   Amodei       Amodei            R     NV    legislator Yea  
 7 A000377   Armstrong    Armstrong         R     ND    legislator Yea  
 8 A000375   Arrington    Arrington         R     TX    legislator Nay  
 9 A000148   Auchincloss  Auchincloss       D     MA    legislator Yea  
10 A000378   Axne         Axne              D     IA    legislator Yea  
# … with 420 more rows</code></pre>
</div>
</div>
<p>Now we have a table of legislator voting data! But what about the <code>&lt;vote-metadata&gt;</code>? Everything other than the <code>&lt;vote-totals&gt;</code> element is singular so we can get that out of the way the same way as before:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vote_metadata</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_roll_xml</span>, <span class="st">"vote-metadata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vote_singular_nodes</span> <span class="op">=</span> <span class="fu">xml_singular_nodes</span><span class="op">(</span><span class="va">vote_metadata</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">vote_df</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">vote_singular_nodes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># as_list() doesn't retain element names so we set names ourselves</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_name.html">xml_name</a></span><span class="op">(</span><span class="va">vote_singular_nodes</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/flatten.html">flatten_dfc</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 12
$ majority        &lt;chr&gt; "D"
$ congress        &lt;chr&gt; "117"
$ session         &lt;chr&gt; "1st"
$ chamber         &lt;chr&gt; "U.S. House of Representatives"
$ `rollcall-num`  &lt;chr&gt; "188"
$ `legis-num`     &lt;chr&gt; "H R 391"
$ `vote-question` &lt;chr&gt; "On Motion to Suspend the Rules and Pass, as Amended"
$ `vote-type`     &lt;chr&gt; "2/3 YEA-AND-NAY"
$ `vote-result`   &lt;chr&gt; "Passed"
$ `action-date`   &lt;chr&gt; "28-Jun-2021"
$ `action-time`   &lt;chr&gt; "7:42 PM"
$ `vote-desc`     &lt;chr&gt; "Global Health Security Act"</code></pre>
</div>
</div>
<p>The <code>&lt;vote-totals&gt;</code> are a bit of a unique little element, with 3 different types of nodes. This is another opportunity for us to be choosy with our data. The first node is table headers, which we don’t need because the elements are tagged anyway. From these, we really only need the <code>&lt;totals-by-party&gt;</code> nodes as long as the totals of which agree with <code>&lt;totals-by-vote&gt;</code> , which is worth checking.</p>
<div>
<details open=""><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">vote_totals</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_metadata</span>, <span class="st">"vote-totals"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">vote_totals_by_party</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_totals</span>, <span class="st">"totals-by-party"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">totals_by_vote</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">vote_totals</span>, <span class="st">"totals-by-vote"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<pre><code>{xml_nodeset (5)}
[1] &lt;totals-by-party-header&gt;\n  &lt;party-header&gt;Party&lt;/party-header&gt;\n  &lt;yea-he ...
[2] &lt;totals-by-party&gt;\n  &lt;party&gt;Republican&lt;/party&gt;\n  &lt;yea-total&gt;90&lt;/yea-tota ...
[3] &lt;totals-by-party&gt;\n  &lt;party&gt;Democratic&lt;/party&gt;\n  &lt;yea-total&gt;217&lt;/yea-tot ...
[4] &lt;totals-by-party&gt;\n  &lt;party&gt;Independent&lt;/party&gt;\n  &lt;yea-total&gt;0&lt;/yea-tota ...
[5] &lt;totals-by-vote&gt;\n  &lt;total-stub&gt;Totals&lt;/total-stub&gt;\n  &lt;yea-total&gt;307&lt;/ye ...</code></pre>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<pre><code>{xml_nodeset (3)}
[1] &lt;totals-by-party&gt;\n  &lt;party&gt;Republican&lt;/party&gt;\n  &lt;yea-total&gt;90&lt;/yea-tota ...
[2] &lt;totals-by-party&gt;\n  &lt;party&gt;Democratic&lt;/party&gt;\n  &lt;yea-total&gt;217&lt;/yea-tot ...
[3] &lt;totals-by-party&gt;\n  &lt;party&gt;Independent&lt;/party&gt;\n  &lt;yea-total&gt;0&lt;/yea-tota ...</code></pre>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<pre><code>{xml_nodeset (5)}
[1] &lt;total-stub&gt;Totals&lt;/total-stub&gt;
[2] &lt;yea-total&gt;307&lt;/yea-total&gt;
[3] &lt;nay-total&gt;112&lt;/nay-total&gt;
[4] &lt;present-total&gt;0&lt;/present-total&gt;
[5] &lt;not-voting-total&gt;11&lt;/not-voting-total&gt;</code></pre>
</div>
</div>
</div>
</div>
<p>Once we have our nodeset (which at last are all singular), we use same listing, mapping, and flattening…or <em>lappening</em> as absolutely no one calls it.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">party_vote_totals_df</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/as_list.html">as_list</a></span><span class="op">(</span><span class="va">vote_totals_by_party</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">flatten_dfc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">type_convert</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  party       `yea-total` `nay-total` `present-total` `not-voting-total`
  &lt;chr&gt;             &lt;dbl&gt;       &lt;dbl&gt;           &lt;dbl&gt;              &lt;dbl&gt;
1 Republican           90         112               0                  9
2 Democratic          217           0               0                  2
3 Independent           0           0               0                  0</code></pre>
</div>
</div>
<p>Now that we have all of our vote data wrangled from the thorny grasp of XML, we can put it all together.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vote_roll_df</span> <span class="op">=</span> <span class="va">vote_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>legislator_votes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">legislator_vote_df</span><span class="op">)</span>,</span>
<span>         party_votes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">party_vote_totals_df</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">recorded_votes_df</span> <span class="op">=</span> <span class="va">recorded_votes_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>vote_roll <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">vote_roll_df</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 8
$ rollNumber     &lt;chr&gt; "188"
$ url            &lt;chr&gt; "https://clerk.house.gov/evs/2021/roll188.xml"
$ fullActionName &lt;chr&gt; "Final Passage Under Suspension of the Rules Results"
$ chamber        &lt;chr&gt; "House"
$ congress       &lt;chr&gt; "117"
$ date           &lt;chr&gt; "2021-06-28T23:46:02Z"
$ sessionNumber  &lt;chr&gt; "1"
$ vote_roll      &lt;list&gt; [&lt;tbl_df[1 x 14]&gt;]</code></pre>
</div>
</div>
<p>…all the way until we’ve gotten back to the bill-level. Now we have the bill-level characteristics with action and vote information nested in list columns. If we want to analyze the actions data, we simply have to <code>unnest()</code> it.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bill_df</span><span class="op">$</span><span class="va">votes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">recorded_votes_df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">unnest</span><span class="op">(</span><span class="va">bill_df</span>, <span class="va">actions</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Rows: 14
Columns: 20
$ billNumber                           &lt;chr&gt; "391", "391", "391", "391", "391"…
$ createDate                           &lt;chr&gt; "2021-01-22T08:12:10Z", "2021-01-…
$ updateDate                           &lt;chr&gt; "2022-02-09T12:37:52Z", "2022-02-…
$ originChamber                        &lt;chr&gt; "House", "House", "House", "House…
$ billType                             &lt;chr&gt; "HR", "HR", "HR", "HR", "HR", "HR…
$ introducedDate                       &lt;chr&gt; "2021-01-21", "2021-01-21", "2021…
$ congress                             &lt;chr&gt; "117", "117", "117", "117", "117"…
$ constitutionalAuthorityStatementText &lt;chr&gt; "&lt;pre&gt;[Congressional Record Volum…
$ title                                &lt;chr&gt; "Global Health Security Act of 20…
$ version                              &lt;chr&gt; "1.0.0", "1.0.0", "1.0.0", "1.0.0…
$ action_date                          &lt;date&gt; 2021-07-12, 2021-06-28, 2021-06-…
$ action_committee_system_code         &lt;chr&gt; "ssfr00", NA, NA, NA, NA, NA, NA,…
$ action_committee_name                &lt;chr&gt; "Foreign Relations Committee", NA…
$ action_source_code                   &lt;chr&gt; "0", "2", "2", "9", "2", "2", "2"…
$ action_source_name                   &lt;chr&gt; "Senate", "House floor actions", …
$ action_text                          &lt;chr&gt; "Received in the Senate and Read …
$ action_type                          &lt;chr&gt; "IntroReferral", "Floor", "Floor"…
$ action_time                          &lt;time&gt;       NA, 19:46:03, 19:46:02, 19…
$ action_code                          &lt;chr&gt; NA, "H38310", "H37300", "8000", "…
$ votes                                &lt;list&gt; [&lt;tbl_df[1 x 8]&gt;], [&lt;tbl_df[1 x …</code></pre>
</div>
</div>
<p>I’ll stop there for brevity’s sake, but you can find the code for extracting the full XML file <a href="https://github.com/MokeEire/my-reps/blob/master/R/parsing_functions.R">here</a><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>.</p>
</section></section></section><section id="tldr-main-points" class="level1"><h1>TL;DR: Main Points</h1>
<p>Processing XML documents can be simple depending on their structure, so try the simplest method if you can. If your data is making use of XML’s flexibility you might but it can be boiled down to these steps:</p>
<ol type="1">
<li><strong>Explore the structure</strong></li>
</ol>
<blockquote class="blockquote">
<p>Go through any available documentation, and when you read in the XML file you can use functions like <code><a href="https://rdrr.io/pkg/XML/man/xmlTreeParse.html">xmlParse()</a></code>, <code><a href="http://xml2.r-lib.org/reference/xml_structure.html">xml_structure()</a></code>, and <code><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_contents()</a></code> .</p>
</blockquote>
<ol start="2" type="1">
<li><strong>Define the output</strong></li>
</ol>
<blockquote class="blockquote">
<p>Consider what you want the output to look like and think about how it needs to be transformed to match this target.</p>
</blockquote>
<ol start="3" type="1">
<li>
<strong>Process a single element</strong> (write a function if it gets too complicated)</li>
</ol>
<blockquote class="blockquote">
<p>Get one element into the form you want. Writing functions can help you think through the data transformations being applied and make your code easier to read.</p>
</blockquote>
<ol start="4" type="1">
<li><strong>Apply to all elements</strong></li>
</ol>
<blockquote class="blockquote">
<p>Focus on processing of the entire file (or the subset of the file you’re interested in). You might want an XML file to return a single row, a single column, or a dataframe of size <span class="math inline">\(n\times k\)</span>. Once you have a single file returned in the format you want, you can combine the outputs of multiple files.</p>
</blockquote>
<p>Please reach out with any questions or feedback! All is welcome, and there may even be a reward for anyone who finds a mistake in the code.</p>
</section><section id="other-helpful-articles" class="level1"><h1>Other helpful articles</h1>
<p>Here are some of the helpful articles I came across in the course of writing this:</p>
<ul>
<li><a href="https://towardsdatascience.com/from-xml-to-excel-for-data-analysis-ac0c0c765b7d" title="Introduction to Processing XML In Python">From XML to Excel for Data Analysis</a></li>
<li><a href="https://medium.com/geekculture/reading-xml-files-in-r-3122c3a2a8d9">Reading XML files in R</a></li>
</ul></section><section id="session-info" class="level1"><h1>Session Info</h1>
<p>Version information about R, OS, and loaded packages.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.2.1 (2022-06-23 ucrt)
 os       Windows 10 x64 (build 19043)
 system   x86_64, mingw32
 ui       RTerm
 language (EN)
 collate  English_United States.utf8
 ctype    English_United States.utf8
 tz       America/Los_Angeles
 date     2022-08-03
 pandoc   2.18 @ C:/Program Files/RStudio/bin/quarto/bin/tools/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────────
 package     * version   date (UTC) lib source
 assertthat    0.2.1     2019-03-21 [1] CRAN (R 4.2.0)
 backports     1.4.1     2021-12-13 [1] CRAN (R 4.2.0)
 bit           4.0.4     2020-08-04 [1] CRAN (R 4.2.0)
 bit64         4.0.5     2020-08-30 [1] CRAN (R 4.2.0)
 bitops        1.0-7     2021-04-24 [1] CRAN (R 4.2.0)
 broom         1.0.0     2022-07-01 [1] CRAN (R 4.2.1)
 cellranger    1.1.0     2016-07-27 [1] CRAN (R 4.2.0)
 cli           3.3.0     2022-04-25 [1] CRAN (R 4.2.0)
 colorspace    2.0-3     2022-02-21 [1] CRAN (R 4.2.0)
 crayon        1.5.1     2022-03-26 [1] CRAN (R 4.2.0)
 curl          4.3.2     2021-06-23 [1] CRAN (R 4.2.0)
 DBI           1.1.3     2022-06-18 [1] CRAN (R 4.2.0)
 dbplyr        2.2.1     2022-06-27 [1] CRAN (R 4.2.1)
 digest        0.6.29    2021-12-01 [1] CRAN (R 4.2.0)
 dplyr       * 1.0.9     2022-04-28 [1] CRAN (R 4.2.0)
 ellipsis      0.3.2     2021-04-29 [1] CRAN (R 4.2.0)
 evaluate      0.15      2022-02-18 [1] CRAN (R 4.2.0)
 extrafont   * 0.18      2022-04-12 [1] CRAN (R 4.2.0)
 extrafontdb   1.0       2012-06-11 [1] CRAN (R 4.2.0)
 fansi         1.0.3     2022-03-24 [1] CRAN (R 4.2.0)
 fastmap       1.1.0     2021-01-25 [1] CRAN (R 4.2.0)
 forcats     * 0.5.1     2021-01-27 [1] CRAN (R 4.2.0)
 fs            1.5.2     2021-12-08 [1] CRAN (R 4.2.0)
 generics      0.1.2     2022-01-31 [1] CRAN (R 4.2.0)
 ggplot2     * 3.3.6     2022-05-03 [1] CRAN (R 4.2.0)
 glue          1.6.2     2022-02-24 [1] CRAN (R 4.2.0)
 gtable        0.3.0     2019-03-25 [1] CRAN (R 4.2.0)
 haven         2.5.0     2022-04-15 [1] CRAN (R 4.2.0)
 hms           1.1.1     2021-09-26 [1] CRAN (R 4.2.0)
 htmltools     0.5.2     2021-08-25 [1] CRAN (R 4.2.0)
 htmlwidgets   1.5.4     2021-09-08 [1] CRAN (R 4.2.0)
 httr          1.4.3     2022-05-04 [1] CRAN (R 4.2.0)
 janitor       2.1.0     2021-01-05 [1] CRAN (R 4.2.1)
 jsonlite    * 1.8.0     2022-02-22 [1] CRAN (R 4.2.0)
 knitr         1.39      2022-04-26 [1] CRAN (R 4.2.0)
 lifecycle     1.0.1     2021-09-24 [1] CRAN (R 4.2.0)
 log4r       * 0.4.2     2021-11-04 [1] CRAN (R 4.2.0)
 lubridate   * 1.8.0     2021-10-07 [1] CRAN (R 4.2.0)
 magrittr    * 2.0.3     2022-03-30 [1] CRAN (R 4.2.0)
 modelr        0.1.8     2020-05-19 [1] CRAN (R 4.2.0)
 mokeR       * 0.1.0     2022-07-16 [1] local
 munsell       0.5.0     2018-06-12 [1] CRAN (R 4.2.0)
 pillar        1.7.0     2022-02-01 [1] CRAN (R 4.2.0)
 pkgconfig     2.0.3     2019-09-22 [1] CRAN (R 4.2.0)
 purrr       * 0.3.4     2020-04-17 [1] CRAN (R 4.2.0)
 R6            2.5.1     2021-08-19 [1] CRAN (R 4.2.0)
 RCurl       * 1.98-1.7  2022-06-09 [1] CRAN (R 4.2.0)
 reactable   * 0.3.0     2022-05-26 [1] CRAN (R 4.2.0)
 reactR        0.4.4     2021-02-22 [1] CRAN (R 4.2.0)
 readr       * 2.1.2     2022-01-30 [1] CRAN (R 4.2.0)
 readxl        1.4.0     2022-03-28 [1] CRAN (R 4.2.0)
 reprex        2.0.1     2021-08-05 [1] CRAN (R 4.2.0)
 rjson       * 0.2.21    2022-01-09 [1] CRAN (R 4.2.0)
 rlang         1.0.4     2022-07-12 [1] CRAN (R 4.2.1)
 rmarkdown     2.14      2022-04-25 [1] CRAN (R 4.2.0)
 rstudioapi    0.13      2020-11-12 [1] CRAN (R 4.2.0)
 Rttf2pt1      1.3.8     2020-01-10 [1] CRAN (R 4.2.1)
 rvest         1.0.2     2021-10-16 [1] CRAN (R 4.2.0)
 scales        1.2.0     2022-04-13 [1] CRAN (R 4.2.0)
 sessioninfo   1.2.2     2021-12-06 [1] CRAN (R 4.2.0)
 snakecase     0.11.0    2019-05-25 [1] CRAN (R 4.2.1)
 stringi       1.7.6     2021-11-29 [1] CRAN (R 4.2.0)
 stringr     * 1.4.0     2019-02-10 [1] CRAN (R 4.2.0)
 tibble      * 3.1.7     2022-05-03 [1] CRAN (R 4.2.0)
 tidyjson    * 0.3.1     2020-05-31 [1] CRAN (R 4.2.0)
 tidyr       * 1.2.0     2022-02-01 [1] CRAN (R 4.2.0)
 tidyselect    1.1.2     2022-02-21 [1] CRAN (R 4.2.0)
 tidyverse   * 1.3.1     2021-04-15 [1] CRAN (R 4.2.0)
 tzdb          0.3.0     2022-03-28 [1] CRAN (R 4.2.0)
 utf8          1.2.2     2021-07-24 [1] CRAN (R 4.2.0)
 vctrs         0.4.1     2022-04-13 [1] CRAN (R 4.2.0)
 vroom         1.5.7     2021-11-30 [1] CRAN (R 4.2.0)
 withr         2.5.0     2022-03-03 [1] CRAN (R 4.2.0)
 xfun          0.31      2022-05-10 [1] CRAN (R 4.2.0)
 XML         * 3.99-0.10 2022-06-09 [1] CRAN (R 4.2.0)
 xml2        * 1.3.3     2021-11-30 [1] CRAN (R 4.2.0)
 yaml          2.3.5     2022-02-21 [1] CRAN (R 4.2.0)

 [1] C:/Users/Mark/AppData/Local/R/win-library/4.2
 [2] C:/Program Files/R/R-4.2.1/library

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>


<!-- -->

</section><div id="quarto-appendix" class="default"><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://en.wikipedia.org/wiki/XML">Wikipedia</a> for the curious. Don’t miss the drama about Microsoft’s “vociferous protests” as one of the co-editors started working with Netscape.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>The <em>x</em> at the end of Microsoft file types (e.g.&nbsp;.docx, .xlsx, .pptx) stands for XML.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>Between <a href="http://www.omegahat.net/RSXML/">XML</a> and <a href="https://xml2.r-lib.org/">xml2</a> there are numerous ways to load XML data with R. I generally prefer <a href="https://xml2.r-lib.org/">xml2</a> but I suggest looking through the packages’ documentation to find the right function for your task<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p><code>xml_document</code> is one of the “key classes” used in the <a href="https://xml2.r-lib.org/">xml2</a> library, the others being <code>xml_node</code> (a single node), and <code>xml_nodeset</code> (a set of nodes).<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>Which is a document metadata identifier, not an Irish metal music genre. While very useful in its own right, it isn’t relevant for our task here.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote">
<p>When you’re working with both the <a href="http://www.omegahat.net/RSXML/">XML</a> and <a href="https://xml2.r-lib.org/">xml2</a> libraries, it is important to note that their functions often rely on different object types. In the case of <code><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame()</a></code>, it does not take <code>{xml_document}</code> or <code>{xml_node}</code> objects. If you try to use them, you’ll see an error like this:</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/XML/man/xmlToDataFrame.html">xmlToDataFrame</a></span><span class="op">(</span><span class="va">bill_xml</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error in (function (classes, fdef, mtable) : unable to find an inherited method for function 'xmlToDataFrame' for signature '"xml_document", "missing", "missing", "missing", "missing"'</code></pre>
</div>
</div>
<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a>
</li>
<li id="fn7" role="doc-endnote">
<p>In the process of writing this, I discovered that using XPath made this ~5x faster but I include the R function because XPath can be tricky and it may be useful to some.</p>
<div class="cell">
<details open=""><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to select singular child nodes from XML node</span></span>
<span><span class="va">xml_singular_nodes</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xml_node</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Return child nodes of current node</span></span>
<span>  <span class="va">child_nodes</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_children</a></span><span class="op">(</span><span class="va">xml_node</span><span class="op">)</span></span>
<span>  <span class="co"># Select child nodes with 0 children</span></span>
<span>  <span class="va">zero_length_child_nodes</span> <span class="op">=</span> <span class="va">child_nodes</span><span class="op">[</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_length</a></span><span class="op">(</span><span class="va">child_nodes</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Keep the nodes which are not empty strings</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">keep</a></span><span class="op">(</span><span class="va">zero_length_child_nodes</span>, <span class="op">~</span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_text</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Using XPath:</span></span>
<span><span class="va">singular_nodes1</span> <span class="op">=</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">bill_xml</span>, </span>
<span>                                <span class="st">"//bill/*[count(./*) = 0 and not(string-length(.) = 0)]"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Using R function:</span></span>
<span><span class="va">singular_nodes2</span> <span class="op">=</span> <span class="fu">xml_singular_nodes</span><span class="op">(</span><span class="va">bill_node</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check they are the same</span></span>
<span><span class="co"># all.equal(singular_nodes1, singular_nodes2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">

</div>
<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a>
</li>
<li id="fn8" role="doc-endnote"><p><a href="https://www.earthdatascience.org/courses/earth-analytics/automate-science-workflows/write-function-r-programming/">How to Write a Function in R</a> is a good place to start learning about writing functions.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9" role="doc-endnote">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://c.tenor.com/um2EhyMQyR8AAAAC/xzibit-meme.gif" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">They heard you like XML</figcaption><p></p>
</figure>
</div>
<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a>
</li>
<li id="fn10" role="doc-endnote"><p>Ctrl/Cmd+F: <code>extract_bill_status</code><a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb56" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Parsing XML with R"</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Untangling congressional legislative data"</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2022-07-14"</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> </span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - data</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - governance</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - R</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co">    comments:</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="co">      hypothesis: true</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(extrafont)</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reactable)</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"https://github.com/MokeEire/my-reps/raw/master/R/parsing_functions.R"</span>)</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>bill_xml_link <span class="ot">=</span> <span class="st">"https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml"</span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>bill_xml_file <span class="ot">=</span> <span class="fu">read_xml</span>(bill_xml_link)</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: df-print-fct</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>knit_print.data.frame <span class="ot">=</span> <span class="cf">function</span>(x, ...){</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">knit_print</span>(</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reactable</span>(x,</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>              <span class="at">compact =</span> T, </span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>              <span class="at">resizable =</span> T,</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip appearance="simple"}</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## What you'll learn:</span></span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Load and parse XML files in R using the <span class="in">`{XML}`</span> and <span class="in">`{xml2}`</span> packages</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Explore the structure of XML documents</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>List, map, and flatten your data into a tabular format using <span class="in">`{purrr}`</span> and using list columns with <span class="in">`{tidyr}`</span></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a><span class="fu"># What is XML?</span></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>If someone asked me what my least favourite data format to work with is, I would of course say PDF, but XML would not be far behind it. Unlike Excel spreadsheets, text files, and other tabular formats, (e)Xtensible Markup Language (XML) is designed to store any "arbitrary" structure<span class="ot">[^1]</span> of data. This flexibility makes XML useful for all kinds of information from financial transactions and recipes to webpage content and document formatting<span class="ot">[^2]</span>. Although working with XML may not be as simple as with tabular data, the contents can be much richer.</span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span><span class="co">[</span><span class="ot">Wikipedia</span><span class="co">](https://en.wikipedia.org/wiki/XML)</span> for the curious. Don't miss the drama about Microsoft's "vociferous protests" as one of the co-editors started working with Netscape.</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>The *x* at the end of Microsoft file types (e.g. .docx, .xlsx, .pptx) stands for XML.</span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>At its core, XML is just "information wrapped in tags". Here is an example from <span class="co">[</span><span class="ot">w3schools</span><span class="co">](https://www.w3schools.com/XML/xml_usedfor.asp)</span> of information a bookstore might have in XML format:</span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a><span class="in">``` xml</span></span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bookstore</span>&gt;</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"children"</span>&gt;</span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Harry Potter&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;J K. Rowling&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2005&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;29.99&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">book</span><span class="ot"> category=</span><span class="st">"web"</span>&gt;</span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">title</span>&gt;Learning XML&lt;/<span class="kw">title</span>&gt;</span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">author</span>&gt;Erik T. Ray&lt;/<span class="kw">author</span>&gt;</span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">year</span>&gt;2003&lt;/<span class="kw">year</span>&gt;</span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">price</span>&gt;39.95&lt;/<span class="kw">price</span>&gt;</span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">book</span>&gt;</span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bookstore</span>&gt;</span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>The `&lt;<span class="kw">bookstore</span>&gt;` parent, or *root* element contains child elements called `&lt;<span class="kw">book</span>&gt;` which themselves have child elements -- `&lt;<span class="kw">title</span>&gt;`, `&lt;<span class="kw">author</span>&gt;`, `&lt;<span class="kw">year</span>&gt;`, and `&lt;<span class="kw">price</span>&gt;`. XML can be thought of as a tree, where each tree branch can have multiple leaves, or none.</span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>Note the book elements also have `category` attributes. Attributes are a useful way to store data related to a specific element for HTML, but using child elements is typically preferred in XML. This post will touch on data stored using both methods. To learn more about what XML is and how to use it, I recommend going through [w3school's XML tutorial](https://www.w3schools.com/XML/default.asp).</span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a># Read XML data with R</span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>To illustrate potential complexities of XML structures, I'll be using congressional bill data provided by the [United States Government Publishing Office (GPO)](https://www.gpo.gov/). To follow along, you can download the sample XML file [here](https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml "HR-391: Global Health Security Act of 2021"). I chose [*HR-391: Global Health Security Act of 2021*](https://www.govinfo.gov/app/details/BILLS-117hr391rfs)because it contains good examples of some of the challenges of parsing XML data*.* As always, the first step of data analysis is to look at the documentation. Luckily, GovInfo provides a [user guide](https://github.com/usgpo/bill-status/blob/main/BILLSTATUS-XML_User_User-Guide.md) for the Bill Status data.</span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>In terms of R packages, four will be important for this article. `{XML}` and `{xml2}`[^3] provide functions for reading in XML data while `{purrr}` and `{tidyr}` helps us parse and flatten the data into tabular form. To start, read in the file with `read_xml()` , which returns an `xml_document`[^4] object.</span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>[^3]: Between `{XML}` and `{xml2}` there are numerous ways to load XML data with R. I generally prefer `{xml2}` but I suggest looking through the packages' documentation to find the right function for your task</span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a>[^4]: `xml_document` is one of the "key classes" used in the `{xml2}` library, the others being `xml_node` (a single node), and `xml_nodeset` (a set of nodes).</span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a>#| label: read-xml</span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a>#| code-summary: "Load and view XML file"</span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a>library(XML)</span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a>library(xml2)</span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a>library(purrr)</span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>bill_xml = read_xml("https://www.govinfo.gov/bulkdata/BILLSTATUS/117/hr/BILLSTATUS-117hr391.xml")</span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a># Look at the xml_document's contents</span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a>xml_contents(bill_xml)</span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a>We can see the document has two top-level nodes - one `&lt;<span class="kw">bill</span>&gt;` node and one called `&lt;<span class="kw">dublinCore</span>&gt;`[^5] In this case we can look just at the `&lt;<span class="kw">bill</span>&gt;` node using `xml_child()`.</span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>[^5]: Which is a document metadata identifier, not an Irish metal music genre. While very useful in its own right, it isn't relevant for our task here.</span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a>#| label: xml-bill-child</span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a>#| code-overflow: wrap</span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a># Return child nodes named bill</span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a>(bill_node = xml_child(bill_xml, "bill"))</span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a>So if we want to have a dataframe with one row per bill, we have a few different kinds of elements to deal with. Firstly there are the elements which have **only one value** (i.e. *singular*) like `billNumber`, `createDate`, and `billType`. There are also elements which have information *nested* in them like `recordedVotes`, `committees`, and `actions`.</span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a>In cases where your data are entirely singular nodes, you may be able to use `xmlToDataFrame()` and be done. You'll need to use `xmlParse()` which creates an `r str_c(class(xmlParse(bill_xml)), collapse = "/")` object. In this example, we need to use `getNodeSet(., [path =] "//bill")` to select only nodes under `&lt;<span class="kw">bill</span>&gt;`[^6] because we have the metadata node mentioned above.</span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a>[^6]: When you're working with both the `{XML}` and `{xml2}` libraries, it is important to note that their functions often rely on different object types. In the case of `xmlToDataFrame()`, it does not take `{xml_document}` or `{xml_node}` objects. If you try to use them, you'll see an error like this:</span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a>    ```{r}</span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a>    #| label: xml-df-error</span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a>    #| error: true</span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-143"><a href="#cb56-143" aria-hidden="true" tabindex="-1"></a>    xmlToDataFrame(bill_xml)</span>
<span id="cb56-144"><a href="#cb56-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-145"><a href="#cb56-145" aria-hidden="true" tabindex="-1"></a>    ```</span>
<span id="cb56-146"><a href="#cb56-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-149"><a href="#cb56-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-150"><a href="#cb56-150" aria-hidden="true" tabindex="-1"></a>#| label: xml-to-df</span>
<span id="cb56-151"><a href="#cb56-151" aria-hidden="true" tabindex="-1"></a>#| class-output: code-block-h</span>
<span id="cb56-152"><a href="#cb56-152" aria-hidden="true" tabindex="-1"></a># First you need to use the xmlParse function</span>
<span id="cb56-153"><a href="#cb56-153" aria-hidden="true" tabindex="-1"></a>bill_xml_parse = xmlParse(bill_xml)</span>
<span id="cb56-154"><a href="#cb56-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-155"><a href="#cb56-155" aria-hidden="true" tabindex="-1"></a># You can wrap a variable assignment in ( ) to print it, </span>
<span id="cb56-156"><a href="#cb56-156" aria-hidden="true" tabindex="-1"></a># or in this case pass it to another function via the pipe %&gt;% </span>
<span id="cb56-157"><a href="#cb56-157" aria-hidden="true" tabindex="-1"></a>( bill_xml_df_attempt = xmlToDataFrame(getNodeSet(bill_xml_parse, "//bill")) ) %&gt;% </span>
<span id="cb56-158"><a href="#cb56-158" aria-hidden="true" tabindex="-1"></a>  # View the dataframe structure</span>
<span id="cb56-159"><a href="#cb56-159" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-160"><a href="#cb56-160" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-161"><a href="#cb56-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-162"><a href="#cb56-162" aria-hidden="true" tabindex="-1"></a>Because the congressional data has singular and nested element structures, a number of fields like `committees`, `actions`, and `sponsors` have had their values combined into a single column. With nested data, you may need to do a little bit more work to get the data into a [tidy data](https://vita.had.co.nz/papers/tidy-data.html) frame, but this approach can work for simpler XML structures. The importance of understanding the structure of your data brings us to one of the cardinal rules of data analysis:</span>
<span id="cb56-163"><a href="#cb56-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-164"><a href="#cb56-164" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip appearance="simple"}</span>
<span id="cb56-165"><a href="#cb56-165" aria-hidden="true" tabindex="-1"></a>## Look at your data</span>
<span id="cb56-166"><a href="#cb56-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-167"><a href="#cb56-167" aria-hidden="true" tabindex="-1"></a>In fact, you could even say *stare* at it. Understanding the structure and contents of your data is essential for designing a solution to consistently process the data.</span>
<span id="cb56-168"><a href="#cb56-168" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-169"><a href="#cb56-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-170"><a href="#cb56-170" aria-hidden="true" tabindex="-1"></a># Define the output</span>
<span id="cb56-171"><a href="#cb56-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-172"><a href="#cb56-172" aria-hidden="true" tabindex="-1"></a>As well as looking at your data, it's also usually helpful to look to your intended output. This determines how to transform the data.</span>
<span id="cb56-173"><a href="#cb56-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-174"><a href="#cb56-174" aria-hidden="true" tabindex="-1"></a>**Example:** I want the congressional data to have one row per bill, with the nested characteristics stored in list columns. This will produce a comprehensive dataset which can easily be subset and transformed to various levels of observation as needed. The end result should look like this:</span>
<span id="cb56-175"><a href="#cb56-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-178"><a href="#cb56-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-179"><a href="#cb56-179" aria-hidden="true" tabindex="-1"></a>#| label: example-bill</span>
<span id="cb56-180"><a href="#cb56-180" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb56-181"><a href="#cb56-181" aria-hidden="true" tabindex="-1"></a>#| message: false</span>
<span id="cb56-182"><a href="#cb56-182" aria-hidden="true" tabindex="-1"></a>#| column: screen-inset-shaded</span>
<span id="cb56-183"><a href="#cb56-183" aria-hidden="true" tabindex="-1"></a>example_bill_df = extract_bill_status(bill_xml_link, log_types = NULL)</span>
<span id="cb56-184"><a href="#cb56-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-185"><a href="#cb56-185" aria-hidden="true" tabindex="-1"></a>example_bill_df %&gt;% # glimpse() # here to check the data</span>
<span id="cb56-186"><a href="#cb56-186" aria-hidden="true" tabindex="-1"></a>  select(</span>
<span id="cb56-187"><a href="#cb56-187" aria-hidden="true" tabindex="-1"></a>    -bill_id, -where(is_list) # remove list columns?</span>
<span id="cb56-188"><a href="#cb56-188" aria-hidden="true" tabindex="-1"></a>  ) %&gt;%</span>
<span id="cb56-189"><a href="#cb56-189" aria-hidden="true" tabindex="-1"></a>  reactable::reactable(</span>
<span id="cb56-190"><a href="#cb56-190" aria-hidden="true" tabindex="-1"></a>    theme = moke_rt(),</span>
<span id="cb56-191"><a href="#cb56-191" aria-hidden="true" tabindex="-1"></a>    compact = T,</span>
<span id="cb56-192"><a href="#cb56-192" aria-hidden="true" tabindex="-1"></a>    resizable = T,</span>
<span id="cb56-193"><a href="#cb56-193" aria-hidden="true" tabindex="-1"></a>    wrap = F,</span>
<span id="cb56-194"><a href="#cb56-194" aria-hidden="true" tabindex="-1"></a>    columns = list(</span>
<span id="cb56-195"><a href="#cb56-195" aria-hidden="true" tabindex="-1"></a>      "latest_action_action_date" = colDef(name = "action_date", </span>
<span id="cb56-196"><a href="#cb56-196" aria-hidden="true" tabindex="-1"></a>                                           width = 115,</span>
<span id="cb56-197"><a href="#cb56-197" aria-hidden="true" tabindex="-1"></a>                                           format = colFormat(date = T)),</span>
<span id="cb56-198"><a href="#cb56-198" aria-hidden="true" tabindex="-1"></a>     "latest_action_text" = colDef(name = "action_text",</span>
<span id="cb56-199"><a href="#cb56-199" aria-hidden="true" tabindex="-1"></a>                                   minWidth = 180,</span>
<span id="cb56-200"><a href="#cb56-200" aria-hidden="true" tabindex="-1"></a>                                   maxWidth = 240),</span>
<span id="cb56-201"><a href="#cb56-201" aria-hidden="true" tabindex="-1"></a>       "constitutional_authority_statement_text" = colDef(show=F),</span>
<span id="cb56-202"><a href="#cb56-202" aria-hidden="true" tabindex="-1"></a>      "create_date" = colDef(format = colFormat(date = T), width = 100),</span>
<span id="cb56-203"><a href="#cb56-203" aria-hidden="true" tabindex="-1"></a>      "update_date" = colDef(format = colFormat(date = T), width = 100),</span>
<span id="cb56-204"><a href="#cb56-204" aria-hidden="true" tabindex="-1"></a>      "introduced_date" = colDef(format = colFormat(date = T), width = 135),</span>
<span id="cb56-205"><a href="#cb56-205" aria-hidden="true" tabindex="-1"></a>      "congress" = colDef(width = 80),</span>
<span id="cb56-206"><a href="#cb56-206" aria-hidden="true" tabindex="-1"></a>     "origin_chamber" = colDef(show=F),</span>
<span id="cb56-207"><a href="#cb56-207" aria-hidden="true" tabindex="-1"></a>      "version" = colDef(show = F, width = 80),</span>
<span id="cb56-208"><a href="#cb56-208" aria-hidden="true" tabindex="-1"></a>      "bill_number" = colDef(width = 100),</span>
<span id="cb56-209"><a href="#cb56-209" aria-hidden="true" tabindex="-1"></a>      "bill_type" = colDef(width = 80),</span>
<span id="cb56-210"><a href="#cb56-210" aria-hidden="true" tabindex="-1"></a>      "title" = colDef(minWidth = 180)</span>
<span id="cb56-211"><a href="#cb56-211" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb56-212"><a href="#cb56-212" aria-hidden="true" tabindex="-1"></a>    columnGroups = list(</span>
<span id="cb56-213"><a href="#cb56-213" aria-hidden="true" tabindex="-1"></a>      colGroup(name = "Latest Action",</span>
<span id="cb56-214"><a href="#cb56-214" aria-hidden="true" tabindex="-1"></a>                            columns = c("latest_action_action_date",</span>
<span id="cb56-215"><a href="#cb56-215" aria-hidden="true" tabindex="-1"></a>                                        "latest_action_text"))</span>
<span id="cb56-216"><a href="#cb56-216" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-217"><a href="#cb56-217" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-218"><a href="#cb56-218" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-219"><a href="#cb56-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-220"><a href="#cb56-220" aria-hidden="true" tabindex="-1"></a>With the following list columns (among others):</span>
<span id="cb56-221"><a href="#cb56-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-222"><a href="#cb56-222" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb56-223"><a href="#cb56-223" aria-hidden="true" tabindex="-1"></a>## Committees</span>
<span id="cb56-224"><a href="#cb56-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-227"><a href="#cb56-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-228"><a href="#cb56-228" aria-hidden="true" tabindex="-1"></a>#| label: glimpse-committees</span>
<span id="cb56-229"><a href="#cb56-229" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb56-230"><a href="#cb56-230" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df[["committees"]])</span>
<span id="cb56-231"><a href="#cb56-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-232"><a href="#cb56-232" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-233"><a href="#cb56-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-234"><a href="#cb56-234" aria-hidden="true" tabindex="-1"></a>## Votes</span>
<span id="cb56-235"><a href="#cb56-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-238"><a href="#cb56-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-239"><a href="#cb56-239" aria-hidden="true" tabindex="-1"></a>#| label: glimpse-votes</span>
<span id="cb56-240"><a href="#cb56-240" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb56-241"><a href="#cb56-241" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df[["votes"]])</span>
<span id="cb56-242"><a href="#cb56-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-243"><a href="#cb56-243" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-244"><a href="#cb56-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-245"><a href="#cb56-245" aria-hidden="true" tabindex="-1"></a>## Actions</span>
<span id="cb56-246"><a href="#cb56-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-249"><a href="#cb56-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-250"><a href="#cb56-250" aria-hidden="true" tabindex="-1"></a>#| label: glimpse-actio</span>
<span id="cb56-251"><a href="#cb56-251" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb56-252"><a href="#cb56-252" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df[["actions"]])</span>
<span id="cb56-253"><a href="#cb56-253" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-254"><a href="#cb56-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-255"><a href="#cb56-255" aria-hidden="true" tabindex="-1"></a>## Sponsors</span>
<span id="cb56-256"><a href="#cb56-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-259"><a href="#cb56-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-260"><a href="#cb56-260" aria-hidden="true" tabindex="-1"></a>#| label: glimpse-sponsors</span>
<span id="cb56-261"><a href="#cb56-261" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb56-262"><a href="#cb56-262" aria-hidden="true" tabindex="-1"></a>glimpse(example_bill_df[["sponsors"]])</span>
<span id="cb56-263"><a href="#cb56-263" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-264"><a href="#cb56-264" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-265"><a href="#cb56-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-266"><a href="#cb56-266" aria-hidden="true" tabindex="-1"></a># Parsing</span>
<span id="cb56-267"><a href="#cb56-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-268"><a href="#cb56-268" aria-hidden="true" tabindex="-1"></a>With this output in mind and an understanding of the data structure, we can break down the process into extracting singular elements, and nested elements. In both cases, we convert XML to a list and use `{purrr]` to flatten and transform the list into the desired output format.</span>
<span id="cb56-269"><a href="#cb56-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-270"><a href="#cb56-270" aria-hidden="true" tabindex="-1"></a>## Singular elements</span>
<span id="cb56-271"><a href="#cb56-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-272"><a href="#cb56-272" aria-hidden="true" tabindex="-1"></a>In the bookstore example, each of the book's children were singular, which means they are well suited to be flattened into a dataframe. In the congressional data, we'll need to single out the singular elements like `billNumber` and `billType` before converting to a dataframe. To do this, I find nodes which meet two criteria: 1) the node does not have any child elements, and 2) the node is not an empty string.</span>
<span id="cb56-273"><a href="#cb56-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-274"><a href="#cb56-274" aria-hidden="true" tabindex="-1"></a>`xml_find_all()` extracts nodes based on an [XPath](https://www.w3schools.com/xml/xml_parser.asp) (XML Path Language) string and returns an `{xml_nodeset}` which can be coerced to a list using `as_list()`. As the function's help file says, "XPath is like regular expressions for trees". When writing an XPath expression, you are selecting the nodes which match the given pattern. In this case `//bill/*` selects all the child nodes in a bill node, while the text `[` within the square brackets `]` indexes these nodes to select those which have no children using the XPath function `count` and nodes which are not empty strings[^7].</span>
<span id="cb56-275"><a href="#cb56-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-276"><a href="#cb56-276" aria-hidden="true" tabindex="-1"></a>[^7]: In the process of writing this, I discovered that using XPath made this \~5x faster but I include the R function because XPath can be tricky and it may be useful to some.</span>
<span id="cb56-277"><a href="#cb56-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-278"><a href="#cb56-278" aria-hidden="true" tabindex="-1"></a>    ```{r}</span>
<span id="cb56-279"><a href="#cb56-279" aria-hidden="true" tabindex="-1"></a>    #| label: singular-nodes</span>
<span id="cb56-280"><a href="#cb56-280" aria-hidden="true" tabindex="-1"></a>    #| code-fold: show</span>
<span id="cb56-281"><a href="#cb56-281" aria-hidden="true" tabindex="-1"></a>    # Function to select singular child nodes from XML node</span>
<span id="cb56-282"><a href="#cb56-282" aria-hidden="true" tabindex="-1"></a>    xml_singular_nodes = function(xml_node){</span>
<span id="cb56-283"><a href="#cb56-283" aria-hidden="true" tabindex="-1"></a>      # Return child nodes of current node</span>
<span id="cb56-284"><a href="#cb56-284" aria-hidden="true" tabindex="-1"></a>      child_nodes = xml_children(xml_node)</span>
<span id="cb56-285"><a href="#cb56-285" aria-hidden="true" tabindex="-1"></a>      # Select child nodes with 0 children</span>
<span id="cb56-286"><a href="#cb56-286" aria-hidden="true" tabindex="-1"></a>      zero_length_child_nodes = child_nodes[xml_length(child_nodes) == 0]</span>
<span id="cb56-287"><a href="#cb56-287" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-288"><a href="#cb56-288" aria-hidden="true" tabindex="-1"></a>      # Keep the nodes which are not empty strings</span>
<span id="cb56-289"><a href="#cb56-289" aria-hidden="true" tabindex="-1"></a>      keep(zero_length_child_nodes, ~(xml_text(.) != ""))</span>
<span id="cb56-290"><a href="#cb56-290" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-291"><a href="#cb56-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-292"><a href="#cb56-292" aria-hidden="true" tabindex="-1"></a>    # Using XPath:</span>
<span id="cb56-293"><a href="#cb56-293" aria-hidden="true" tabindex="-1"></a>    singular_nodes1 = xml_find_all(bill_xml, </span>
<span id="cb56-294"><a href="#cb56-294" aria-hidden="true" tabindex="-1"></a>                                    "//bill/*[count(./*) = 0 and not(string-length(.) = 0)]")</span>
<span id="cb56-295"><a href="#cb56-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-296"><a href="#cb56-296" aria-hidden="true" tabindex="-1"></a>    # Using R function:</span>
<span id="cb56-297"><a href="#cb56-297" aria-hidden="true" tabindex="-1"></a>    singular_nodes2 = xml_singular_nodes(bill_node)</span>
<span id="cb56-298"><a href="#cb56-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-299"><a href="#cb56-299" aria-hidden="true" tabindex="-1"></a>    # Check they are the same</span>
<span id="cb56-300"><a href="#cb56-300" aria-hidden="true" tabindex="-1"></a>    # all.equal(singular_nodes1, singular_nodes2)</span>
<span id="cb56-301"><a href="#cb56-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-302"><a href="#cb56-302" aria-hidden="true" tabindex="-1"></a>    ```</span>
<span id="cb56-303"><a href="#cb56-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-304"><a href="#cb56-304" aria-hidden="true" tabindex="-1"></a>    ```{r}</span>
<span id="cb56-305"><a href="#cb56-305" aria-hidden="true" tabindex="-1"></a>    #| label: bench-node-selection</span>
<span id="cb56-306"><a href="#cb56-306" aria-hidden="true" tabindex="-1"></a>    #| eval: false</span>
<span id="cb56-307"><a href="#cb56-307" aria-hidden="true" tabindex="-1"></a>    #| echo: false</span>
<span id="cb56-308"><a href="#cb56-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-309"><a href="#cb56-309" aria-hidden="true" tabindex="-1"></a>    # benchmark the two different ways of selecting nodes</span>
<span id="cb56-310"><a href="#cb56-310" aria-hidden="true" tabindex="-1"></a>    microbenchmark::microbenchmark(</span>
<span id="cb56-311"><a href="#cb56-311" aria-hidden="true" tabindex="-1"></a>      xml_singular_nodes = xml_singular_nodes(bill_node),</span>
<span id="cb56-312"><a href="#cb56-312" aria-hidden="true" tabindex="-1"></a>      xml_find_all = xml_find_all(bill_xml, "//bill/*[count(./*) = 0 and not(string-length(.) = 0)]")</span>
<span id="cb56-313"><a href="#cb56-313" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-314"><a href="#cb56-314" aria-hidden="true" tabindex="-1"></a>    ```</span>
<span id="cb56-315"><a href="#cb56-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-318"><a href="#cb56-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-319"><a href="#cb56-319" aria-hidden="true" tabindex="-1"></a>#| label: singular-nodes-list</span>
<span id="cb56-320"><a href="#cb56-320" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb56-321"><a href="#cb56-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-322"><a href="#cb56-322" aria-hidden="true" tabindex="-1"></a>singular_nodes = xml_find_all(</span>
<span id="cb56-323"><a href="#cb56-323" aria-hidden="true" tabindex="-1"></a>  bill_xml, </span>
<span id="cb56-324"><a href="#cb56-324" aria-hidden="true" tabindex="-1"></a>  "//bill/*[count(./*) = 0 and not(string-length(.) = 0)]"</span>
<span id="cb56-325"><a href="#cb56-325" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-326"><a href="#cb56-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-327"><a href="#cb56-327" aria-hidden="true" tabindex="-1"></a>(singular_list = as_list(singular_nodes)) %&gt;% </span>
<span id="cb56-328"><a href="#cb56-328" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-329"><a href="#cb56-329" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-330"><a href="#cb56-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-331"><a href="#cb56-331" aria-hidden="true" tabindex="-1"></a>Note that we didn't retain the element names so we need to assign them ourselves. When your data is in a named list, you can flatten each element in the list into a **d**ata**f**rame **c**olumn using purrr's `flatten_dfc()` .</span>
<span id="cb56-332"><a href="#cb56-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-335"><a href="#cb56-335" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-336"><a href="#cb56-336" aria-hidden="true" tabindex="-1"></a>#| label: singular-nodes-list-named</span>
<span id="cb56-337"><a href="#cb56-337" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb56-338"><a href="#cb56-338" aria-hidden="true" tabindex="-1"></a>singular_list_named = setNames(singular_list, </span>
<span id="cb56-339"><a href="#cb56-339" aria-hidden="true" tabindex="-1"></a>                                xml_name(singular_nodes))</span>
<span id="cb56-340"><a href="#cb56-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-341"><a href="#cb56-341" aria-hidden="true" tabindex="-1"></a>(bill_df = flatten_dfc(singular_list_named)) %&gt;% </span>
<span id="cb56-342"><a href="#cb56-342" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-343"><a href="#cb56-343" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-344"><a href="#cb56-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-347"><a href="#cb56-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-348"><a href="#cb56-348" aria-hidden="true" tabindex="-1"></a>#| label: singular-nodes-rt</span>
<span id="cb56-349"><a href="#cb56-349" aria-hidden="true" tabindex="-1"></a>#| column: page</span>
<span id="cb56-350"><a href="#cb56-350" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb56-351"><a href="#cb56-351" aria-hidden="true" tabindex="-1"></a>reactable(bill_df,</span>
<span id="cb56-352"><a href="#cb56-352" aria-hidden="true" tabindex="-1"></a>          theme = moke_rt(),</span>
<span id="cb56-353"><a href="#cb56-353" aria-hidden="true" tabindex="-1"></a>            columns = list(</span>
<span id="cb56-354"><a href="#cb56-354" aria-hidden="true" tabindex="-1"></a>              "constitutionalAuthorityStatementText" = colDef(show=F),</span>
<span id="cb56-355"><a href="#cb56-355" aria-hidden="true" tabindex="-1"></a>              "createDate" = colDef(format = colFormat(date = T), width = 100),</span>
<span id="cb56-356"><a href="#cb56-356" aria-hidden="true" tabindex="-1"></a>              "updateDate" = colDef(format = colFormat(date = T), width = 100),</span>
<span id="cb56-357"><a href="#cb56-357" aria-hidden="true" tabindex="-1"></a>              "introducedDate" = colDef(format = colFormat(date = T), width = 120),</span>
<span id="cb56-358"><a href="#cb56-358" aria-hidden="true" tabindex="-1"></a>              "congress" = colDef(width = 90),</span>
<span id="cb56-359"><a href="#cb56-359" aria-hidden="true" tabindex="-1"></a>              "originChamber" = colDef(show=F),</span>
<span id="cb56-360"><a href="#cb56-360" aria-hidden="true" tabindex="-1"></a>              "version" = colDef(show=F, width = 80),</span>
<span id="cb56-361"><a href="#cb56-361" aria-hidden="true" tabindex="-1"></a>              "billNumber" = colDef(width = 105),</span>
<span id="cb56-362"><a href="#cb56-362" aria-hidden="true" tabindex="-1"></a>              "billType" = colDef(width = 85),</span>
<span id="cb56-363"><a href="#cb56-363" aria-hidden="true" tabindex="-1"></a>              "title" = colDef(minWidth = 180)</span>
<span id="cb56-364"><a href="#cb56-364" aria-hidden="true" tabindex="-1"></a>            ))</span>
<span id="cb56-365"><a href="#cb56-365" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-366"><a href="#cb56-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-367"><a href="#cb56-367" aria-hidden="true" tabindex="-1"></a>## Nested elements</span>
<span id="cb56-368"><a href="#cb56-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-369"><a href="#cb56-369" aria-hidden="true" tabindex="-1"></a>It's nice when things are simple, but often times they're not. In congressional data, three such cases are: elements with multiple children, elements with multiple children with their own sub-elements, and elements with nested XML data.</span>
<span id="cb56-370"><a href="#cb56-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-371"><a href="#cb56-371" aria-hidden="true" tabindex="-1"></a>we might want to know what happened to the bill over time -- when it was introduced, voted on, and/or passed. Each of these could be represented as a column representing the date of the action like `introducedDate`, but this becomes unruly as the different action types and characteristics increase. Below is an example of an individual action element.</span>
<span id="cb56-372"><a href="#cb56-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-375"><a href="#cb56-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-376"><a href="#cb56-376" aria-hidden="true" tabindex="-1"></a>#| label: actions-xml</span>
<span id="cb56-377"><a href="#cb56-377" aria-hidden="true" tabindex="-1"></a>(actions_xml = xml_find_all(bill_node, "actions/item"))</span>
<span id="cb56-378"><a href="#cb56-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-379"><a href="#cb56-379" aria-hidden="true" tabindex="-1"></a># Look at first action</span>
<span id="cb56-380"><a href="#cb56-380" aria-hidden="true" tabindex="-1"></a>xml_contents(actions_xml[1])</span>
<span id="cb56-381"><a href="#cb56-381" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-382"><a href="#cb56-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-383"><a href="#cb56-383" aria-hidden="true" tabindex="-1"></a>To include actions and votes, we use the same steps as before and nest them in a list column such that each row will have a nested dataframe. This strategy takes advantage of the `nest()`/`unnest()` functionality of `{tidyr}`. For more complex cases like this, I would implore you to write functions[^8]. Functions can make your code more reliable, easier to debug, and they make you think critically about how you are handling data.</span>
<span id="cb56-384"><a href="#cb56-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-385"><a href="#cb56-385" aria-hidden="true" tabindex="-1"></a>[^8]: [How to Write a Function in R](https://www.earthdatascience.org/courses/earth-analytics/automate-science-workflows/write-function-r-programming/) is a good place to start learning about writing functions.</span>
<span id="cb56-386"><a href="#cb56-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-387"><a href="#cb56-387" aria-hidden="true" tabindex="-1"></a>### Multiple children</span>
<span id="cb56-388"><a href="#cb56-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-389"><a href="#cb56-389" aria-hidden="true" tabindex="-1"></a>### Multiple children with sub-elements</span>
<span id="cb56-390"><a href="#cb56-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-391"><a href="#cb56-391" aria-hidden="true" tabindex="-1"></a>The actions node has an `&lt;<span class="kw">item</span>&gt;` child node for each congressional action taken for a bill, such as being introduced, sent to a committee, debated on the floor, etc.. Just as before, we use `as_list()` to convert the `{xml_nodeset}` to a list.</span>
<span id="cb56-392"><a href="#cb56-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-395"><a href="#cb56-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-396"><a href="#cb56-396" aria-hidden="true" tabindex="-1"></a>#| label: actions-list</span>
<span id="cb56-397"><a href="#cb56-397" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb56-398"><a href="#cb56-398" aria-hidden="true" tabindex="-1"></a>actions_list = as_list(actions_xml)</span>
<span id="cb56-399"><a href="#cb56-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-400"><a href="#cb56-400" aria-hidden="true" tabindex="-1"></a># Look at first action</span>
<span id="cb56-401"><a href="#cb56-401" aria-hidden="true" tabindex="-1"></a>glimpse(actions_list[[1]])</span>
<span id="cb56-402"><a href="#cb56-402" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-403"><a href="#cb56-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-404"><a href="#cb56-404" aria-hidden="true" tabindex="-1"></a>In the individual action container, we can see we have the type, text, and date of the action, a list of committees related to the action, and some elements which are singular and some which are not. To deal with this, we can write a function (or set of functions) like the ones below to process an action.</span>
<span id="cb56-405"><a href="#cb56-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-408"><a href="#cb56-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-409"><a href="#cb56-409" aria-hidden="true" tabindex="-1"></a>#| label: actions-functions</span>
<span id="cb56-410"><a href="#cb56-410" aria-hidden="true" tabindex="-1"></a>#| code-fold: true</span>
<span id="cb56-411"><a href="#cb56-411" aria-hidden="true" tabindex="-1"></a>#| code-summary: "Functions"</span>
<span id="cb56-412"><a href="#cb56-412" aria-hidden="true" tabindex="-1"></a># Helper function: flatten_dfc_rename</span>
<span id="cb56-413"><a href="#cb56-413" aria-hidden="true" tabindex="-1"></a># flatten a list to dataframe and </span>
<span id="cb56-414"><a href="#cb56-414" aria-hidden="true" tabindex="-1"></a># rename the columns with a given prefix</span>
<span id="cb56-415"><a href="#cb56-415" aria-hidden="true" tabindex="-1"></a>flatten_dfc_rename = function(list_to_flatten, </span>
<span id="cb56-416"><a href="#cb56-416" aria-hidden="true" tabindex="-1"></a>                          name_prefix = "prefix"){</span>
<span id="cb56-417"><a href="#cb56-417" aria-hidden="true" tabindex="-1"></a>  rename_with(</span>
<span id="cb56-418"><a href="#cb56-418" aria-hidden="true" tabindex="-1"></a>    .data = flatten_dfc(list_to_flatten), </span>
<span id="cb56-419"><a href="#cb56-419" aria-hidden="true" tabindex="-1"></a>    .fn = ~str_c(name_prefix, "_", .),</span>
<span id="cb56-420"><a href="#cb56-420" aria-hidden="true" tabindex="-1"></a>    # Exclude columns which already start with the prefix</span>
<span id="cb56-421"><a href="#cb56-421" aria-hidden="true" tabindex="-1"></a>    .cols = -starts_with(name_prefix)</span>
<span id="cb56-422"><a href="#cb56-422" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-423"><a href="#cb56-423" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-424"><a href="#cb56-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-425"><a href="#cb56-425" aria-hidden="true" tabindex="-1"></a># Function: parse_action</span>
<span id="cb56-426"><a href="#cb56-426" aria-hidden="true" tabindex="-1"></a># Parse actions from list to dataframe</span>
<span id="cb56-427"><a href="#cb56-427" aria-hidden="true" tabindex="-1"></a>parse_action = function(action){</span>
<span id="cb56-428"><a href="#cb56-428" aria-hidden="true" tabindex="-1"></a>  action %&gt;% </span>
<span id="cb56-429"><a href="#cb56-429" aria-hidden="true" tabindex="-1"></a>    # Flatten+rename sourceSystem elements</span>
<span id="cb56-430"><a href="#cb56-430" aria-hidden="true" tabindex="-1"></a>    map_at("sourceSystem", ~flatten_dfc_rename(.x, "source")) %&gt;% </span>
<span id="cb56-431"><a href="#cb56-431" aria-hidden="true" tabindex="-1"></a>    # Flatten+rename committees</span>
<span id="cb56-432"><a href="#cb56-432" aria-hidden="true" tabindex="-1"></a>    map_at("committees", function(committee){</span>
<span id="cb56-433"><a href="#cb56-433" aria-hidden="true" tabindex="-1"></a>      map_dfr(committee, ~flatten_dfc_rename(.x, "committee"))</span>
<span id="cb56-434"><a href="#cb56-434" aria-hidden="true" tabindex="-1"></a>    }) %&gt;% </span>
<span id="cb56-435"><a href="#cb56-435" aria-hidden="true" tabindex="-1"></a>    # Flatten object to dataframe</span>
<span id="cb56-436"><a href="#cb56-436" aria-hidden="true" tabindex="-1"></a>    flatten_dfc_rename(., "action") %&gt;% </span>
<span id="cb56-437"><a href="#cb56-437" aria-hidden="true" tabindex="-1"></a>    # Lastly, clean the names</span>
<span id="cb56-438"><a href="#cb56-438" aria-hidden="true" tabindex="-1"></a>    janitor::clean_names()</span>
<span id="cb56-439"><a href="#cb56-439" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-440"><a href="#cb56-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-441"><a href="#cb56-441" aria-hidden="true" tabindex="-1"></a># Parse the first action</span>
<span id="cb56-442"><a href="#cb56-442" aria-hidden="true" tabindex="-1"></a>parse_action(actions_list[[1]]) %&gt;% </span>
<span id="cb56-443"><a href="#cb56-443" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-444"><a href="#cb56-444" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-445"><a href="#cb56-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-448"><a href="#cb56-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-449"><a href="#cb56-449" aria-hidden="true" tabindex="-1"></a>#| label: benchmark-parse-action</span>
<span id="cb56-450"><a href="#cb56-450" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb56-451"><a href="#cb56-451" aria-hidden="true" tabindex="-1"></a>#| include: false</span>
<span id="cb56-452"><a href="#cb56-452" aria-hidden="true" tabindex="-1"></a># Test modify_at vs map_at</span>
<span id="cb56-453"><a href="#cb56-453" aria-hidden="true" tabindex="-1"></a>parse_action2 = function(action){</span>
<span id="cb56-454"><a href="#cb56-454" aria-hidden="true" tabindex="-1"></a>  action %&gt;% </span>
<span id="cb56-455"><a href="#cb56-455" aria-hidden="true" tabindex="-1"></a>    # Flatten+rename  sourceSystem elements</span>
<span id="cb56-456"><a href="#cb56-456" aria-hidden="true" tabindex="-1"></a>    modify_at("sourceSystem", ~flatten_dfc_rename(.x, "source")) %&gt;% </span>
<span id="cb56-457"><a href="#cb56-457" aria-hidden="true" tabindex="-1"></a>    # Flatten+rename committees</span>
<span id="cb56-458"><a href="#cb56-458" aria-hidden="true" tabindex="-1"></a>    modify_at("committees", function(committee){</span>
<span id="cb56-459"><a href="#cb56-459" aria-hidden="true" tabindex="-1"></a>      map_dfr(committee, ~flatten_dfc_rename(.x, "committee"))</span>
<span id="cb56-460"><a href="#cb56-460" aria-hidden="true" tabindex="-1"></a>    }) %&gt;% </span>
<span id="cb56-461"><a href="#cb56-461" aria-hidden="true" tabindex="-1"></a>    # Flatten object to dataframe</span>
<span id="cb56-462"><a href="#cb56-462" aria-hidden="true" tabindex="-1"></a>    flatten_dfc_rename(., "action") %&gt;% </span>
<span id="cb56-463"><a href="#cb56-463" aria-hidden="true" tabindex="-1"></a>    janitor::clean_names()</span>
<span id="cb56-464"><a href="#cb56-464" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-465"><a href="#cb56-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-466"><a href="#cb56-466" aria-hidden="true" tabindex="-1"></a># Parse the first action</span>
<span id="cb56-467"><a href="#cb56-467" aria-hidden="true" tabindex="-1"></a>parse_action2(actions_list[[1]])</span>
<span id="cb56-468"><a href="#cb56-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-469"><a href="#cb56-469" aria-hidden="true" tabindex="-1"></a># What about speed?</span>
<span id="cb56-470"><a href="#cb56-470" aria-hidden="true" tabindex="-1"></a>microbenchmark::microbenchmark(</span>
<span id="cb56-471"><a href="#cb56-471" aria-hidden="true" tabindex="-1"></a>  parse_action = parse_action(actions_list[[1]]),</span>
<span id="cb56-472"><a href="#cb56-472" aria-hidden="true" tabindex="-1"></a>  parse_action2 = parse_action2(actions_list[[1]]), times = 1000</span>
<span id="cb56-473"><a href="#cb56-473" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-474"><a href="#cb56-474" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-475"><a href="#cb56-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-476"><a href="#cb56-476" aria-hidden="true" tabindex="-1"></a>Using the `{purrr}` library's `map_dfr()`, we apply this function to each action and combine the results into **d**ata**f**rame **r**ows. It is useful to be explicit about the data types when you plan to combine rows into a dataframe or `unnest()` the data in the future. I do this using `type_convert()` to ensure the columns have a specific datatype. To add these actions data as a list column to `bill_df` we can simply use dollar assignment.</span>
<span id="cb56-477"><a href="#cb56-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-480"><a href="#cb56-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-481"><a href="#cb56-481" aria-hidden="true" tabindex="-1"></a>#| label: actions-dfr</span>
<span id="cb56-482"><a href="#cb56-482" aria-hidden="true" tabindex="-1"></a>#| code-fold: show</span>
<span id="cb56-483"><a href="#cb56-483" aria-hidden="true" tabindex="-1"></a>actions_df = map_dfr(actions_list, parse_action)</span>
<span id="cb56-484"><a href="#cb56-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-485"><a href="#cb56-485" aria-hidden="true" tabindex="-1"></a>(actions_df = type_convert(actions_df,</span>
<span id="cb56-486"><a href="#cb56-486" aria-hidden="true" tabindex="-1"></a>                          col_types = cols(</span>
<span id="cb56-487"><a href="#cb56-487" aria-hidden="true" tabindex="-1"></a>                            action_date = col_date(), </span>
<span id="cb56-488"><a href="#cb56-488" aria-hidden="true" tabindex="-1"></a>                            action_time = col_time(),</span>
<span id="cb56-489"><a href="#cb56-489" aria-hidden="true" tabindex="-1"></a>                            action_committee_systemCode = col_character(), </span>
<span id="cb56-490"><a href="#cb56-490" aria-hidden="true" tabindex="-1"></a>                            action_committee_name = col_character(), </span>
<span id="cb56-491"><a href="#cb56-491" aria-hidden="true" tabindex="-1"></a>                            action_source_code = col_character(),</span>
<span id="cb56-492"><a href="#cb56-492" aria-hidden="true" tabindex="-1"></a>                            action_source_name = col_character(),</span>
<span id="cb56-493"><a href="#cb56-493" aria-hidden="true" tabindex="-1"></a>                            action_text = col_character(), </span>
<span id="cb56-494"><a href="#cb56-494" aria-hidden="true" tabindex="-1"></a>                            action_type = col_character(), </span>
<span id="cb56-495"><a href="#cb56-495" aria-hidden="true" tabindex="-1"></a>                            action_code = col_character()</span>
<span id="cb56-496"><a href="#cb56-496" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb56-497"><a href="#cb56-497" aria-hidden="true" tabindex="-1"></a>                          ))</span>
<span id="cb56-498"><a href="#cb56-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-499"><a href="#cb56-499" aria-hidden="true" tabindex="-1"></a>bill_df$actions = list(actions_df)</span>
<span id="cb56-500"><a href="#cb56-500" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-501"><a href="#cb56-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-504"><a href="#cb56-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-505"><a href="#cb56-505" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb56-506"><a href="#cb56-506" aria-hidden="true" tabindex="-1"></a>#| include: false</span>
<span id="cb56-507"><a href="#cb56-507" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb56-508"><a href="#cb56-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-509"><a href="#cb56-509" aria-hidden="true" tabindex="-1"></a>bill_actions = xml_find_all(actions_node, "item")</span>
<span id="cb56-510"><a href="#cb56-510" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-511"><a href="#cb56-511" aria-hidden="true" tabindex="-1"></a>bill_action_counts = as_list(xml_find_all(actions_node, "./*[not(self::item)]")) %&gt;%</span>
<span id="cb56-512"><a href="#cb56-512" aria-hidden="true" tabindex="-1"></a>  map_dfc(flatten_dfc) %&gt;% </span>
<span id="cb56-513"><a href="#cb56-513" aria-hidden="true" tabindex="-1"></a>  rename_with(.cols = everything(), ~str_c("actions_", .)) %&gt;% </span>
<span id="cb56-514"><a href="#cb56-514" aria-hidden="true" tabindex="-1"></a>  pivot_longer(everything(), names_to = "action", names_prefix = "actions_", values_to = "count")</span>
<span id="cb56-515"><a href="#cb56-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-516"><a href="#cb56-516" aria-hidden="true" tabindex="-1"></a># Coerce nodes to list</span>
<span id="cb56-517"><a href="#cb56-517" aria-hidden="true" tabindex="-1"></a>actions_df = as_list(bill_actions) %&gt;% </span>
<span id="cb56-518"><a href="#cb56-518" aria-hidden="true" tabindex="-1"></a>  map_dfr(parse_action) %&gt;% </span>
<span id="cb56-519"><a href="#cb56-519" aria-hidden="true" tabindex="-1"></a>  type_convert(col_types = col_specs$actions)</span>
<span id="cb56-520"><a href="#cb56-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-521"><a href="#cb56-521" aria-hidden="true" tabindex="-1"></a>bill_df$actions = list(actions_df)</span>
<span id="cb56-522"><a href="#cb56-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-523"><a href="#cb56-523" aria-hidden="true" tabindex="-1"></a>bill_df$action_counts = list(type_convert(bill_action_counts,</span>
<span id="cb56-524"><a href="#cb56-524" aria-hidden="true" tabindex="-1"></a>                                          col_types = cols(action = col_character(), count = col_integer())))</span>
<span id="cb56-525"><a href="#cb56-525" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-526"><a href="#cb56-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-527"><a href="#cb56-527" aria-hidden="true" tabindex="-1"></a>### Nested XML</span>
<span id="cb56-528"><a href="#cb56-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-529"><a href="#cb56-529" aria-hidden="true" tabindex="-1"></a>Votes are particularly interesting because it provides a more discrete measure of our representatives' behaviour. Individual votes are stored in the `&lt;<span class="kw">recordedVotes</span>&gt;` container. We can access child elements in XML using a forward slash (this uses a language called XPATH).</span>
<span id="cb56-530"><a href="#cb56-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-533"><a href="#cb56-533" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-534"><a href="#cb56-534" aria-hidden="true" tabindex="-1"></a>#| label: vote-nodes-contents</span>
<span id="cb56-535"><a href="#cb56-535" aria-hidden="true" tabindex="-1"></a>(bill_recorded_vote_nodes = xml_find_all(bill_node, "recordedVotes/recordedVote")) %&gt;% </span>
<span id="cb56-536"><a href="#cb56-536" aria-hidden="true" tabindex="-1"></a>  xml_contents()</span>
<span id="cb56-537"><a href="#cb56-537" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-538"><a href="#cb56-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-539"><a href="#cb56-539" aria-hidden="true" tabindex="-1"></a>You may have spotted why votes are interesting elements to parse because inside the `&lt;<span class="kw">url</span>&gt;` element we find **another** **XML file**![^9] Before we dive into that can of worms, I'll convert the top-level nodes to a list and flatten it into columns. Note we use `map_dfr()` with `votes_list` because there could be multiple vote objects.</span>
<span id="cb56-540"><a href="#cb56-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-541"><a href="#cb56-541" aria-hidden="true" tabindex="-1"></a>[^9]: ![They heard you like XML](https://c.tenor.com/um2EhyMQyR8AAAAC/xzibit-meme.gif)</span>
<span id="cb56-542"><a href="#cb56-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-545"><a href="#cb56-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-546"><a href="#cb56-546" aria-hidden="true" tabindex="-1"></a>#| label: vote-nodes-df</span>
<span id="cb56-547"><a href="#cb56-547" aria-hidden="true" tabindex="-1"></a># Coerce nodes to list</span>
<span id="cb56-548"><a href="#cb56-548" aria-hidden="true" tabindex="-1"></a>recorded_votes_list = as_list(bill_recorded_vote_nodes)</span>
<span id="cb56-549"><a href="#cb56-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-550"><a href="#cb56-550" aria-hidden="true" tabindex="-1"></a>(recorded_votes_df = map_dfr(recorded_votes_list, flatten_dfc)) %&gt;% </span>
<span id="cb56-551"><a href="#cb56-551" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-552"><a href="#cb56-552" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-553"><a href="#cb56-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-554"><a href="#cb56-554" aria-hidden="true" tabindex="-1"></a>Now we want to get the vote roll XML file, so we go back to `read_xml()` . There are two main nodes - `&lt;<span class="kw">vote-metadata</span>&gt;` and `&lt;<span class="kw">vote-data</span>&gt;`. One node contains the aggregated vote information, while `&lt;<span class="kw">vote-data</span>&gt;` contains the legislator-level vote data. Let's try to parse the legislator-level data first. Here is the XML for a single legislator's vote:</span>
<span id="cb56-555"><a href="#cb56-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-558"><a href="#cb56-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-559"><a href="#cb56-559" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-xml</span>
<span id="cb56-560"><a href="#cb56-560" aria-hidden="true" tabindex="-1"></a>vote_roll_xml = read_xml(recorded_votes_df$url)</span>
<span id="cb56-561"><a href="#cb56-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-562"><a href="#cb56-562" aria-hidden="true" tabindex="-1"></a>vote_data = xml_find_all(vote_roll_xml, "vote-data")</span>
<span id="cb56-563"><a href="#cb56-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-564"><a href="#cb56-564" aria-hidden="true" tabindex="-1"></a>xml_child(vote_data)</span>
<span id="cb56-565"><a href="#cb56-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-566"><a href="#cb56-566" aria-hidden="true" tabindex="-1"></a># (vote_roll_children = xml_children(vote_roll_xml)) %&gt;% </span>
<span id="cb56-567"><a href="#cb56-567" aria-hidden="true" tabindex="-1"></a>#   map(xml_contents)</span>
<span id="cb56-568"><a href="#cb56-568" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-569"><a href="#cb56-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-570"><a href="#cb56-570" aria-hidden="true" tabindex="-1"></a>With a similar combination of `as_list()` , `flatten_dfr()`, and `unnest()` we can flatten the XML into one row per legislator but we lose all the attributes.</span>
<span id="cb56-571"><a href="#cb56-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-574"><a href="#cb56-574" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-575"><a href="#cb56-575" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-data-flat</span>
<span id="cb56-576"><a href="#cb56-576" aria-hidden="true" tabindex="-1"></a>(vote_roll_flattened = vote_data %&gt;% </span>
<span id="cb56-577"><a href="#cb56-577" aria-hidden="true" tabindex="-1"></a>  as_list() %&gt;% </span>
<span id="cb56-578"><a href="#cb56-578" aria-hidden="true" tabindex="-1"></a>  flatten_dfr() %&gt;% </span>
<span id="cb56-579"><a href="#cb56-579" aria-hidden="true" tabindex="-1"></a>    unnest(everything()))</span>
<span id="cb56-580"><a href="#cb56-580" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-581"><a href="#cb56-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-582"><a href="#cb56-582" aria-hidden="true" tabindex="-1"></a>Instead we'll need to extract the attributes before we flatten the data. Let's take another look at the legislators structure.</span>
<span id="cb56-583"><a href="#cb56-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-586"><a href="#cb56-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-587"><a href="#cb56-587" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-leg-list</span>
<span id="cb56-588"><a href="#cb56-588" aria-hidden="true" tabindex="-1"></a>vote_legislators = vote_data %&gt;% </span>
<span id="cb56-589"><a href="#cb56-589" aria-hidden="true" tabindex="-1"></a>  xml_find_all("recorded-vote")</span>
<span id="cb56-590"><a href="#cb56-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-591"><a href="#cb56-591" aria-hidden="true" tabindex="-1"></a>(legislators_list = as_list(vote_legislators))[1] %&gt;% </span>
<span id="cb56-592"><a href="#cb56-592" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-593"><a href="#cb56-593" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-594"><a href="#cb56-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-595"><a href="#cb56-595" aria-hidden="true" tabindex="-1"></a>The legislator element has all the attributes, while the vote element only has a value. We want to extract the attributes only for legislator using `map()` to apply `map_at()` on each legislator element and extract the attributes from each while retaining the value in `vote`. It can often feel like you're getting lost in a list of lists, but with some experimentation you'll be able to find your way back to the surface.</span>
<span id="cb56-596"><a href="#cb56-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-599"><a href="#cb56-599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-600"><a href="#cb56-600" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-leg-df</span>
<span id="cb56-601"><a href="#cb56-601" aria-hidden="true" tabindex="-1"></a>(legislator_vote_df = legislators_list %&gt;% </span>
<span id="cb56-602"><a href="#cb56-602" aria-hidden="true" tabindex="-1"></a>    # Modify one level deeper using map_at to target legislator elements</span>
<span id="cb56-603"><a href="#cb56-603" aria-hidden="true" tabindex="-1"></a>    map(map_at, "legislator", attributes) %&gt;% </span>
<span id="cb56-604"><a href="#cb56-604" aria-hidden="true" tabindex="-1"></a>    map_dfr(flatten_dfc))</span>
<span id="cb56-605"><a href="#cb56-605" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-606"><a href="#cb56-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-607"><a href="#cb56-607" aria-hidden="true" tabindex="-1"></a>Now we have a table of legislator voting data! But what about the `&lt;<span class="kw">vote-metadata</span>&gt;`? Everything other than the `&lt;<span class="kw">vote-totals</span>&gt;` element is singular so we can get that out of the way the same way as before:</span>
<span id="cb56-608"><a href="#cb56-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-611"><a href="#cb56-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-612"><a href="#cb56-612" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-metadata-xml</span>
<span id="cb56-613"><a href="#cb56-613" aria-hidden="true" tabindex="-1"></a>vote_metadata = xml_find_all(vote_roll_xml, "vote-metadata")</span>
<span id="cb56-614"><a href="#cb56-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-615"><a href="#cb56-615" aria-hidden="true" tabindex="-1"></a>vote_singular_nodes = xml_singular_nodes(vote_metadata)</span>
<span id="cb56-616"><a href="#cb56-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-617"><a href="#cb56-617" aria-hidden="true" tabindex="-1"></a>(vote_df = as_list(vote_singular_nodes) %&gt;% </span>
<span id="cb56-618"><a href="#cb56-618" aria-hidden="true" tabindex="-1"></a>  # as_list() doesn't retain element names so we set names ourselves</span>
<span id="cb56-619"><a href="#cb56-619" aria-hidden="true" tabindex="-1"></a>  setNames(xml_name(vote_singular_nodes)) %&gt;% </span>
<span id="cb56-620"><a href="#cb56-620" aria-hidden="true" tabindex="-1"></a>  flatten_dfc()) %&gt;% </span>
<span id="cb56-621"><a href="#cb56-621" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-622"><a href="#cb56-622" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-623"><a href="#cb56-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-624"><a href="#cb56-624" aria-hidden="true" tabindex="-1"></a>The `&lt;<span class="kw">vote-totals</span>&gt;` are a bit of a unique little element, with 3 different types of nodes. This is another opportunity for us to be choosy with our data. The first node is table headers, which we don't need because the elements are tagged anyway. From these, we really only need the `&lt;<span class="kw">totals-by-party</span>&gt;` nodes as long as the totals of which agree with `&lt;<span class="kw">totals-by-vote</span>&gt;` , which is worth checking.</span>
<span id="cb56-625"><a href="#cb56-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-628"><a href="#cb56-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-629"><a href="#cb56-629" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-metadata-totals-contents</span>
<span id="cb56-630"><a href="#cb56-630" aria-hidden="true" tabindex="-1"></a>#| layout-nrow: 1</span>
<span id="cb56-631"><a href="#cb56-631" aria-hidden="true" tabindex="-1"></a>(vote_totals = xml_find_all(vote_metadata, "vote-totals")) %&gt;% </span>
<span id="cb56-632"><a href="#cb56-632" aria-hidden="true" tabindex="-1"></a>  xml_contents()</span>
<span id="cb56-633"><a href="#cb56-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-634"><a href="#cb56-634" aria-hidden="true" tabindex="-1"></a>(vote_totals_by_party = xml_find_all(vote_totals, "totals-by-party"))</span>
<span id="cb56-635"><a href="#cb56-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-636"><a href="#cb56-636" aria-hidden="true" tabindex="-1"></a>(totals_by_vote = xml_find_all(vote_totals, "totals-by-vote")) %&gt;% </span>
<span id="cb56-637"><a href="#cb56-637" aria-hidden="true" tabindex="-1"></a>  xml_contents()</span>
<span id="cb56-638"><a href="#cb56-638" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-639"><a href="#cb56-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-640"><a href="#cb56-640" aria-hidden="true" tabindex="-1"></a>Once we have our nodeset (which at last are all singular), we use same listing, mapping, and flattening...or *lappening* as absolutely no one calls it.</span>
<span id="cb56-641"><a href="#cb56-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-644"><a href="#cb56-644" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-645"><a href="#cb56-645" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-metadata-totals-party</span>
<span id="cb56-646"><a href="#cb56-646" aria-hidden="true" tabindex="-1"></a>#| message: false</span>
<span id="cb56-647"><a href="#cb56-647" aria-hidden="true" tabindex="-1"></a>#| warning: false</span>
<span id="cb56-648"><a href="#cb56-648" aria-hidden="true" tabindex="-1"></a>(party_vote_totals_df = as_list(vote_totals_by_party) %&gt;% </span>
<span id="cb56-649"><a href="#cb56-649" aria-hidden="true" tabindex="-1"></a>  map_dfr(flatten_dfc) %&gt;% </span>
<span id="cb56-650"><a href="#cb56-650" aria-hidden="true" tabindex="-1"></a>    type_convert())</span>
<span id="cb56-651"><a href="#cb56-651" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-652"><a href="#cb56-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-655"><a href="#cb56-655" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-656"><a href="#cb56-656" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb56-657"><a href="#cb56-657" aria-hidden="true" tabindex="-1"></a>#| include: false</span>
<span id="cb56-658"><a href="#cb56-658" aria-hidden="true" tabindex="-1"></a># Check if totals match</span>
<span id="cb56-659"><a href="#cb56-659" aria-hidden="true" tabindex="-1"></a>as_list(totals_by_vote) %&gt;% </span>
<span id="cb56-660"><a href="#cb56-660" aria-hidden="true" tabindex="-1"></a>  map_dfr(flatten_dfc)</span>
<span id="cb56-661"><a href="#cb56-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-662"><a href="#cb56-662" aria-hidden="true" tabindex="-1"></a>summarise(party_vote_totals, </span>
<span id="cb56-663"><a href="#cb56-663" aria-hidden="true" tabindex="-1"></a>          across(.cols = -party, sum, na.rm=T))</span>
<span id="cb56-664"><a href="#cb56-664" aria-hidden="true" tabindex="-1"></a># They do!</span>
<span id="cb56-665"><a href="#cb56-665" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-666"><a href="#cb56-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-667"><a href="#cb56-667" aria-hidden="true" tabindex="-1"></a>Now that we have all of our vote data wrangled from the thorny grasp of XML, we can put it all together.</span>
<span id="cb56-668"><a href="#cb56-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-671"><a href="#cb56-671" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-672"><a href="#cb56-672" aria-hidden="true" tabindex="-1"></a>#| label: vote-roll-build</span>
<span id="cb56-673"><a href="#cb56-673" aria-hidden="true" tabindex="-1"></a>vote_roll_df = vote_df %&gt;% </span>
<span id="cb56-674"><a href="#cb56-674" aria-hidden="true" tabindex="-1"></a>  mutate(legislator_votes = list(legislator_vote_df),</span>
<span id="cb56-675"><a href="#cb56-675" aria-hidden="true" tabindex="-1"></a>         party_votes = list(party_vote_totals_df)) %&gt;% </span>
<span id="cb56-676"><a href="#cb56-676" aria-hidden="true" tabindex="-1"></a>    janitor::clean_names()</span>
<span id="cb56-677"><a href="#cb56-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-678"><a href="#cb56-678" aria-hidden="true" tabindex="-1"></a>(recorded_votes_df = recorded_votes_df %&gt;% </span>
<span id="cb56-679"><a href="#cb56-679" aria-hidden="true" tabindex="-1"></a>  mutate(vote_roll = list(vote_roll_df))) %&gt;% </span>
<span id="cb56-680"><a href="#cb56-680" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-681"><a href="#cb56-681" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-682"><a href="#cb56-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-683"><a href="#cb56-683" aria-hidden="true" tabindex="-1"></a>...all the way until we've gotten back to the bill-level. Now we have the bill-level characteristics with action and vote information nested in list columns. If we want to analyze the actions data, we simply have to `unnest()` it.</span>
<span id="cb56-684"><a href="#cb56-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-687"><a href="#cb56-687" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-688"><a href="#cb56-688" aria-hidden="true" tabindex="-1"></a>#| label: unnest-actions</span>
<span id="cb56-689"><a href="#cb56-689" aria-hidden="true" tabindex="-1"></a>bill_df$votes = list(recorded_votes_df)</span>
<span id="cb56-690"><a href="#cb56-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-691"><a href="#cb56-691" aria-hidden="true" tabindex="-1"></a>unnest(bill_df, actions) %&gt;% </span>
<span id="cb56-692"><a href="#cb56-692" aria-hidden="true" tabindex="-1"></a>  glimpse()</span>
<span id="cb56-693"><a href="#cb56-693" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-694"><a href="#cb56-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-695"><a href="#cb56-695" aria-hidden="true" tabindex="-1"></a>I'll stop there for brevity's sake, but you can find the code for extracting the full XML file [here](https://github.com/MokeEire/my-reps/blob/master/R/parsing_functions.R)[^10].</span>
<span id="cb56-696"><a href="#cb56-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-697"><a href="#cb56-697" aria-hidden="true" tabindex="-1"></a>[^10]: Ctrl/Cmd+F: `extract_bill_status`</span>
<span id="cb56-698"><a href="#cb56-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-699"><a href="#cb56-699" aria-hidden="true" tabindex="-1"></a># TL;DR: Main Points</span>
<span id="cb56-700"><a href="#cb56-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-701"><a href="#cb56-701" aria-hidden="true" tabindex="-1"></a>Processing XML documents can be simple depending on their structure, so try the simplest method if you can. If your data is making use of XML's flexibility you might but it can be boiled down to these steps:</span>
<span id="cb56-702"><a href="#cb56-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-703"><a href="#cb56-703" aria-hidden="true" tabindex="-1"></a>1.  **Explore the structure**</span>
<span id="cb56-704"><a href="#cb56-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-705"><a href="#cb56-705" aria-hidden="true" tabindex="-1"></a>&gt; Go through any available documentation, and when you read in the XML file you can use functions like `xmlParse()`, `xml_structure()`, and `xml_contents()` .</span>
<span id="cb56-706"><a href="#cb56-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-707"><a href="#cb56-707" aria-hidden="true" tabindex="-1"></a>2.  **Define the output**</span>
<span id="cb56-708"><a href="#cb56-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-709"><a href="#cb56-709" aria-hidden="true" tabindex="-1"></a>&gt; Consider what you want the output to look like and think about how it needs to be transformed to match this target.</span>
<span id="cb56-710"><a href="#cb56-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-711"><a href="#cb56-711" aria-hidden="true" tabindex="-1"></a>3.  **Process a single element** (write a function if it gets too complicated)</span>
<span id="cb56-712"><a href="#cb56-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-713"><a href="#cb56-713" aria-hidden="true" tabindex="-1"></a>&gt; Get one element into the form you want. Writing functions can help you think through the data transformations being applied and make your code easier to read.</span>
<span id="cb56-714"><a href="#cb56-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-715"><a href="#cb56-715" aria-hidden="true" tabindex="-1"></a>4.  **Apply to all elements**</span>
<span id="cb56-716"><a href="#cb56-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-717"><a href="#cb56-717" aria-hidden="true" tabindex="-1"></a>&gt; Focus on processing of the entire file (or the subset of the file you're interested in). You might want an XML file to return a single row, a single column, or a dataframe of size $n\times k$. Once you have a single file returned in the format you want, you can combine the outputs of multiple files.</span>
<span id="cb56-718"><a href="#cb56-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-719"><a href="#cb56-719" aria-hidden="true" tabindex="-1"></a>Please reach out with any questions or feedback! All is welcome, and there may even be a reward for anyone who finds a mistake in the code.</span>
<span id="cb56-720"><a href="#cb56-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-723"><a href="#cb56-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-724"><a href="#cb56-724" aria-hidden="true" tabindex="-1"></a>#| eval: false</span>
<span id="cb56-725"><a href="#cb56-725" aria-hidden="true" tabindex="-1"></a>#| include: false</span>
<span id="cb56-726"><a href="#cb56-726" aria-hidden="true" tabindex="-1"></a>parse_vote_roll = function(vote, logger, bill_type, bill_num){</span>
<span id="cb56-727"><a href="#cb56-727" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-728"><a href="#cb56-728" aria-hidden="true" tabindex="-1"></a>  tryCatch(</span>
<span id="cb56-729"><a href="#cb56-729" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb56-730"><a href="#cb56-730" aria-hidden="true" tabindex="-1"></a>      vote_xml = read_xml(vote, options = "RECOVER")</span>
<span id="cb56-731"><a href="#cb56-731" aria-hidden="true" tabindex="-1"></a>      vote_data = xml_find_all(vote_xml, "vote-data")</span>
<span id="cb56-732"><a href="#cb56-732" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-733"><a href="#cb56-733" aria-hidden="true" tabindex="-1"></a>      vote_roll_children = xml_children(vote_roll_xml)</span>
<span id="cb56-734"><a href="#cb56-734" aria-hidden="true" tabindex="-1"></a>      vote_data = xml_find_all(vote_roll_xml, "vote-data")</span>
<span id="cb56-735"><a href="#cb56-735" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-736"><a href="#cb56-736" aria-hidden="true" tabindex="-1"></a>      # Vote data</span>
<span id="cb56-737"><a href="#cb56-737" aria-hidden="true" tabindex="-1"></a>      vote_legislators = vote_data %&gt;% </span>
<span id="cb56-738"><a href="#cb56-738" aria-hidden="true" tabindex="-1"></a>        xml_find_all("recorded-vote")</span>
<span id="cb56-739"><a href="#cb56-739" aria-hidden="true" tabindex="-1"></a>      legislators_list = as_list(vote_legislators)</span>
<span id="cb56-740"><a href="#cb56-740" aria-hidden="true" tabindex="-1"></a>      legislator_vote_df = legislators_list %&gt;% </span>
<span id="cb56-741"><a href="#cb56-741" aria-hidden="true" tabindex="-1"></a>        # Modify one level deeper using map_at to target legislator elements</span>
<span id="cb56-742"><a href="#cb56-742" aria-hidden="true" tabindex="-1"></a>        map(map_at, "legislator", attributes) %&gt;% </span>
<span id="cb56-743"><a href="#cb56-743" aria-hidden="true" tabindex="-1"></a>        map_dfr(flatten_dfc)</span>
<span id="cb56-744"><a href="#cb56-744" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-745"><a href="#cb56-745" aria-hidden="true" tabindex="-1"></a>      # Vote metadata</span>
<span id="cb56-746"><a href="#cb56-746" aria-hidden="true" tabindex="-1"></a>      vote_metadata = xml_find_all(vote_roll_xml, "vote-metadata")</span>
<span id="cb56-747"><a href="#cb56-747" aria-hidden="true" tabindex="-1"></a>      vote_singular_nodes = xml_singular_nodes(vote_metadata)</span>
<span id="cb56-748"><a href="#cb56-748" aria-hidden="true" tabindex="-1"></a>      (vote_df = as_list(vote_singular_nodes) %&gt;% </span>
<span id="cb56-749"><a href="#cb56-749" aria-hidden="true" tabindex="-1"></a>          # as_list() doesn't retain element names so we set names ourselves</span>
<span id="cb56-750"><a href="#cb56-750" aria-hidden="true" tabindex="-1"></a>          setNames(xml_name(vote_singular_nodes)) %&gt;% </span>
<span id="cb56-751"><a href="#cb56-751" aria-hidden="true" tabindex="-1"></a>          flatten_dfc())</span>
<span id="cb56-752"><a href="#cb56-752" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-753"><a href="#cb56-753" aria-hidden="true" tabindex="-1"></a>      # Vote totals</span>
<span id="cb56-754"><a href="#cb56-754" aria-hidden="true" tabindex="-1"></a>      vote_totals = xml_find_all(vote_metadata, "vote-totals")</span>
<span id="cb56-755"><a href="#cb56-755" aria-hidden="true" tabindex="-1"></a>      vote_totals_by_party = xml_find_all(vote_totals, "totals-by-party")</span>
<span id="cb56-756"><a href="#cb56-756" aria-hidden="true" tabindex="-1"></a>      party_vote_totals_df = vote_totals_by_party %&gt;% </span>
<span id="cb56-757"><a href="#cb56-757" aria-hidden="true" tabindex="-1"></a>        as_list() %&gt;% </span>
<span id="cb56-758"><a href="#cb56-758" aria-hidden="true" tabindex="-1"></a>        map_dfr(flatten_dfc) %&gt;% </span>
<span id="cb56-759"><a href="#cb56-759" aria-hidden="true" tabindex="-1"></a>        type_convert()</span>
<span id="cb56-760"><a href="#cb56-760" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-761"><a href="#cb56-761" aria-hidden="true" tabindex="-1"></a>      vote_roll_df = vote_df %&gt;% </span>
<span id="cb56-762"><a href="#cb56-762" aria-hidden="true" tabindex="-1"></a>        mutate(legislator_votes = list(legislator_vote_df),</span>
<span id="cb56-763"><a href="#cb56-763" aria-hidden="true" tabindex="-1"></a>               party_votes = list(party_vote_totals_df)) %&gt;% </span>
<span id="cb56-764"><a href="#cb56-764" aria-hidden="true" tabindex="-1"></a>        janitor::clean_names()</span>
<span id="cb56-765"><a href="#cb56-765" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-766"><a href="#cb56-766" aria-hidden="true" tabindex="-1"></a>      vote_list = as_list(vote_data)</span>
<span id="cb56-767"><a href="#cb56-767" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-768"><a href="#cb56-768" aria-hidden="true" tabindex="-1"></a>      flatten_dfr(vote_list) %&gt;% </span>
<span id="cb56-769"><a href="#cb56-769" aria-hidden="true" tabindex="-1"></a>        unnest(everything())</span>
<span id="cb56-770"><a href="#cb56-770" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb56-771"><a href="#cb56-771" aria-hidden="true" tabindex="-1"></a>    error=function(cond) {</span>
<span id="cb56-772"><a href="#cb56-772" aria-hidden="true" tabindex="-1"></a>      log_info(logger, </span>
<span id="cb56-773"><a href="#cb56-773" aria-hidden="true" tabindex="-1"></a>               bill_type = bill_type,</span>
<span id="cb56-774"><a href="#cb56-774" aria-hidden="true" tabindex="-1"></a>               bill_num = bill_num, </span>
<span id="cb56-775"><a href="#cb56-775" aria-hidden="true" tabindex="-1"></a>               "ERROR: Vote roll could not be parsed")</span>
<span id="cb56-776"><a href="#cb56-776" aria-hidden="true" tabindex="-1"></a>      # Choose a return value in case of error</span>
<span id="cb56-777"><a href="#cb56-777" aria-hidden="true" tabindex="-1"></a>      return(tibble())</span>
<span id="cb56-778"><a href="#cb56-778" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-779"><a href="#cb56-779" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-780"><a href="#cb56-780" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-781"><a href="#cb56-781" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-782"><a href="#cb56-782" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-783"><a href="#cb56-783" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb56-784"><a href="#cb56-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-785"><a href="#cb56-785" aria-hidden="true" tabindex="-1"></a># Other helpful articles</span>
<span id="cb56-786"><a href="#cb56-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-787"><a href="#cb56-787" aria-hidden="true" tabindex="-1"></a>Here are some of the helpful articles I came across in the course of writing this:</span>
<span id="cb56-788"><a href="#cb56-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-789"><a href="#cb56-789" aria-hidden="true" tabindex="-1"></a>-   [From XML to Excel for Data Analysis](https://towardsdatascience.com/from-xml-to-excel-for-data-analysis-ac0c0c765b7d "Introduction to Processing XML In Python")</span>
<span id="cb56-790"><a href="#cb56-790" aria-hidden="true" tabindex="-1"></a>-   [Reading XML files in R](https://medium.com/geekculture/reading-xml-files-in-r-3122c3a2a8d9)</span>
<span id="cb56-791"><a href="#cb56-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-792"><a href="#cb56-792" aria-hidden="true" tabindex="-1"></a># Session Info</span>
<span id="cb56-793"><a href="#cb56-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-794"><a href="#cb56-794" aria-hidden="true" tabindex="-1"></a>Version information about R, OS, and loaded packages.</span>
<span id="cb56-795"><a href="#cb56-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-798"><a href="#cb56-798" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-799"><a href="#cb56-799" aria-hidden="true" tabindex="-1"></a>#| label: session-info</span>
<span id="cb56-800"><a href="#cb56-800" aria-hidden="true" tabindex="-1"></a>#| echo: false</span>
<span id="cb56-801"><a href="#cb56-801" aria-hidden="true" tabindex="-1"></a>sessioninfo::session_info("loaded")</span>
<span id="cb56-802"><a href="#cb56-802" aria-hidden="true" tabindex="-1"></a>```</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>